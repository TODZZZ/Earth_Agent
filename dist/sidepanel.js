const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["few_shot.js","globals.js","globals.css"])))=>i.map(i=>d[i]);
var op=Object.defineProperty;var cp=(n,e,t)=>e in n?op(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var Ut=(n,e,t)=>cp(n,typeof e!="symbol"?e+"":e,t);import{g as Ao,a as lp,r as $e,j as z,c as up,R as dp}from"./globals.js";const Hi="RFC3986",Gi={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:n=>String(n)},hp="RFC1738",fp=Array.isArray,yt=(()=>{const n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})(),ci=1024,pp=(n,e,t,r,s)=>{if(n.length===0)return n;let a=n;if(typeof n=="symbol"?a=Symbol.prototype.toString.call(n):typeof n!="string"&&(a=String(n)),t==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<a.length;o+=ci){const c=a.length>=ci?a.slice(o,o+ci):a,l=[];for(let u=0;u<c.length;++u){let d=c.charCodeAt(u);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||s===hp&&(d===40||d===41)){l[l.length]=c.charAt(u);continue}if(d<128){l[l.length]=yt[d];continue}if(d<2048){l[l.length]=yt[192|d>>6]+yt[128|d&63];continue}if(d<55296||d>=57344){l[l.length]=yt[224|d>>12]+yt[128|d>>6&63]+yt[128|d&63];continue}u+=1,d=65536+((d&1023)<<10|c.charCodeAt(u)&1023),l[l.length]=yt[240|d>>18]+yt[128|d>>12&63]+yt[128|d>>6&63]+yt[128|d&63]}i+=l.join("")}return i};function mp(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function $c(n,e){if(fp(n)){const t=[];for(let r=0;r<n.length;r+=1)t.push(e(n[r]));return t}return e(n)}const gp=Object.prototype.hasOwnProperty,Lu={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},wt=Array.isArray,yp=Array.prototype.push,Du=function(n,e){yp.apply(n,wt(e)?e:[e])},_p=Date.prototype.toISOString,me={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:pp,encodeValuesOnly:!1,format:Hi,formatter:Gi[Hi],indices:!1,serializeDate(n){return _p.call(n)},skipNulls:!1,strictNullHandling:!1};function bp(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}const li={};function Mu(n,e,t,r,s,a,i,o,c,l,u,d,h,f,g,p,m,_){let y=n,w=_,O=0,P=!1;for(;(w=w.get(li))!==void 0&&!P;){const se=w.get(n);if(O+=1,typeof se<"u"){if(se===O)throw new RangeError("Cyclic object value");P=!0}typeof w.get(li)>"u"&&(O=0)}if(typeof l=="function"?y=l(e,y):y instanceof Date?y=h==null?void 0:h(y):t==="comma"&&wt(y)&&(y=$c(y,function(se){return se instanceof Date?h==null?void 0:h(se):se})),y===null){if(a)return c&&!p?c(e,me.encoder,m,"key",f):e;y=""}if(bp(y)||mp(y)){if(c){const se=p?e:c(e,me.encoder,m,"key",f);return[(g==null?void 0:g(se))+"="+(g==null?void 0:g(c(y,me.encoder,m,"value",f)))]}return[(g==null?void 0:g(e))+"="+(g==null?void 0:g(String(y)))]}const k=[];if(typeof y>"u")return k;let $;if(t==="comma"&&wt(y))p&&c&&(y=$c(y,c)),$=[{value:y.length>0?y.join(",")||null:void 0}];else if(wt(l))$=l;else{const se=Object.keys(y);$=u?se.sort(u):se}const Q=o?String(e).replace(/\./g,"%2E"):String(e),re=r&&wt(y)&&y.length===1?Q+"[]":Q;if(s&&wt(y)&&y.length===0)return re+"[]";for(let se=0;se<$.length;++se){const ee=$[se],gt=typeof ee=="object"&&typeof ee.value<"u"?ee.value:y[ee];if(i&&gt===null)continue;const tr=d&&o?ee.replace(/\./g,"%2E"):ee,T=wt(y)?typeof t=="function"?t(re,tr):re:re+(d?"."+tr:"["+tr+"]");_.set(n,O);const S=new WeakMap;S.set(li,_),Du(k,Mu(gt,T,t,r,s,a,i,o,t==="comma"&&p&&wt(y)?null:c,l,u,d,h,f,g,p,m,S))}return k}function wp(n=me){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=n.charset||me.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=Hi;if(typeof n.format<"u"){if(!gp.call(Gi,n.format))throw new TypeError("Unknown format option provided.");t=n.format}const r=Gi[t];let s=me.filter;(typeof n.filter=="function"||wt(n.filter))&&(s=n.filter);let a;if(n.arrayFormat&&n.arrayFormat in Lu?a=n.arrayFormat:"indices"in n?a=n.indices?"indices":"repeat":a=me.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:me.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:me.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:me.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:me.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?me.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:me.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:me.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:me.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:me.encodeValuesOnly,filter:s,format:t,formatter:r,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:me.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:me.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:me.strictNullHandling}}function vp(n,e={}){let t=n;const r=wp(e);let s,a;typeof r.filter=="function"?(a=r.filter,t=a("",t)):wt(r.filter)&&(a=r.filter,s=a);const i=[];if(typeof t!="object"||t===null)return"";const o=Lu[r.arrayFormat],c=o==="comma"&&r.commaRoundTrip;s||(s=Object.keys(t)),r.sort&&s.sort(r.sort);const l=new WeakMap;for(let h=0;h<s.length;++h){const f=s[h];r.skipNulls&&t[f]===null||Du(i,Mu(t[f],f,o,c,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,l))}const u=i.join(r.delimiter);let d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}const Or="4.95.1";let Nc=!1,Zn,Uu,Fu,Ji,Bu,zu,Zu,qu,Vu;function Ep(n,e={auto:!1}){if(Nc)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(Zn)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${Zn}'\``);Nc=e.auto,Zn=n.kind,Uu=n.fetch,Fu=n.FormData,Ji=n.File,Bu=n.ReadableStream,zu=n.getMultipartRequestOptions,Zu=n.getDefaultAgent,qu=n.fileFromPath,Vu=n.isFsReadStream}class Ap{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function Op({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,r,s,a;try{t=fetch,r=Request,s=Response,a=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:s,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new Ap(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}const Hu=()=>{Zn||Ep(Op(),{auto:!0})};Hu();class F extends Error{}class Ee extends F{constructor(e,t,r,s){super(`${Ee.makeMessage(e,t,r)}`),this.status=e,this.headers=s,this.request_id=s==null?void 0:s["x-request-id"],this.error=t;const a=t;this.code=a==null?void 0:a.code,this.param=a==null?void 0:a.param,this.type=a==null?void 0:a.type}static makeMessage(e,t,r){const s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e||!s)return new ga({message:r,cause:Wi(t)});const a=t==null?void 0:t.error;return e===400?new Gu(e,a,r,s):e===401?new Ju(e,a,r,s):e===403?new Ku(e,a,r,s):e===404?new Wu(e,a,r,s):e===409?new Xu(e,a,r,s):e===422?new Yu(e,a,r,s):e===429?new Qu(e,a,r,s):e>=500?new ed(e,a,r,s):new Ee(e,a,r,s)}}class Je extends Ee{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class ga extends Ee{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class ya extends ga{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Gu extends Ee{}class Ju extends Ee{}class Ku extends Ee{}class Wu extends Ee{}class Xu extends Ee{}class Yu extends Ee{}class Qu extends Ee{}class ed extends Ee{}class td extends F{constructor(){super("Could not parse response content as the length limit was reached")}}class rd extends F{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var vs=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},rr=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ve;class _a{constructor(){Ve.set(this,void 0),this.buffer=new Uint8Array,vs(this,Ve,null,"f")}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let r=new Uint8Array(this.buffer.length+t.length);r.set(this.buffer),r.set(t,this.buffer.length),this.buffer=r;const s=[];let a;for(;(a=Sp(this.buffer,rr(this,Ve,"f")))!=null;){if(a.carriage&&rr(this,Ve,"f")==null){vs(this,Ve,a.index,"f");continue}if(rr(this,Ve,"f")!=null&&(a.index!==rr(this,Ve,"f")+1||a.carriage)){s.push(this.decodeText(this.buffer.slice(0,rr(this,Ve,"f")-1))),this.buffer=this.buffer.slice(rr(this,Ve,"f")),vs(this,Ve,null,"f");continue}const i=rr(this,Ve,"f")!==null?a.preceding-1:a.preceding,o=this.decodeText(this.buffer.slice(0,i));s.push(o),this.buffer=this.buffer.slice(a.index),vs(this,Ve,null,"f")}return s}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new F(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new F(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new F("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}Ve=new WeakMap;_a.NEWLINE_CHARS=new Set([`
`,"\r"]);_a.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Sp(n,e){for(let s=e??0;s<n.length;s++){if(n[s]===10)return{preceding:s,index:s+1,carriage:!1};if(n[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function Pp(n){for(let r=0;r<n.length-1;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}function nd(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class Ot{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const i of xp(e,t))if(!a){if(i.data.startsWith("[DONE]")){a=!0;continue}if(i.event===null||i.event.startsWith("response.")||i.event.startsWith("transcript.")){let o;try{o=JSON.parse(i.data)}catch(c){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),c}if(o&&o.error)throw new Ee(void 0,o.error,void 0,ud(e.headers));yield o}else{let o;try{o=JSON.parse(i.data)}catch(c){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),c}if(i.event=="error")throw new Ee(void 0,o.error,o.message,void 0);yield{event:i.event,data:o}}}a=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{a||t.abort()}}return new Ot(s,t)}static fromReadableStream(e,t){let r=!1;async function*s(){const i=new _a,o=nd(e);for await(const c of o)for(const l of i.decode(c))yield l;for(const c of i.flush())yield c}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(const o of s())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new Ot(a,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),s=a=>({next:()=>{if(a.length===0){const i=r.next();e.push(i),t.push(i)}return a.shift()}});return[new Ot(()=>s(e),this.controller),new Ot(()=>s(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new Bu({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{const{value:a,done:i}=await t.next();if(i)return s.close();const o=r.encode(JSON.stringify(a)+`
`);s.enqueue(o)}catch(a){s.error(a)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}}async function*xp(n,e){if(!n.body)throw e.abort(),new F("Attempted to iterate over a response with no body");const t=new Tp,r=new _a,s=nd(n.body);for await(const a of Rp(s))for(const i of r.decode(a)){const o=t.decode(i);o&&(yield o)}for(const a of r.flush()){const i=t.decode(a);i&&(yield i)}}async function*Rp(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let a;for(;(a=Pp(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}class Tp{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,s]=Ip(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}}function Ip(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}const sd=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",ad=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&ba(n),ba=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",kp=n=>ad(n)||sd(n)||Vu(n);async function id(n,e,t){var s;if(n=await n,ad(n))return n;if(sd(n)){const a=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=ba(a)?[await a.arrayBuffer()]:[a];return new Ji(i,e,t)}const r=await Cp(n);if(e||(e=Np(n)??"unknown_file"),!(t!=null&&t.type)){const a=(s=r[0])==null?void 0:s.type;typeof a=="string"&&(t={...t,type:a})}return new Ji(r,e,t)}async function Cp(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(ba(n))e.push(await n.arrayBuffer());else if(jp(n))for await(const r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${$p(n)}`);return e}function $p(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function Np(n){var e;return ui(n.name)||ui(n.filename)||((e=ui(n.path))==null?void 0:e.split(/[\\/]/).pop())}const ui=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},jp=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",jc=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",Mr=async n=>{const e=await Lp(n.body);return zu(e,n)},Lp=async n=>{const e=new Fu;return await Promise.all(Object.entries(n||{}).map(([t,r])=>Ki(e,t,r))),e},Ki=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(kp(t)){const r=await id(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>Ki(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>Ki(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Nr={},Dp=function(n,e,t,r,s){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t},Mp=function(n,e,t,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Es;Hu();async function od(n){var i;const{response:e}=n;if(n.options.stream)return Jt("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):Ot.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=e.headers.get("content-type"),r=(i=t==null?void 0:t.split(";")[0])==null?void 0:i.trim();if((r==null?void 0:r.includes("application/json"))||(r==null?void 0:r.endsWith("+json"))){const o=await e.json();return Jt("response",e.status,e.url,e.headers,o),cd(o,e)}const a=await e.text();return Jt("response",e.status,e.url,e.headers,a),a}function cd(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class wa extends Promise{constructor(e,t=od){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new wa(this.responsePromise,async t=>cd(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class Up{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:s,fetch:a}){this.baseURL=e,this.maxRetries=di("maxRetries",t),this.timeout=di("timeout",r),this.httpAgent=s,this.fetch=a??Uu}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...qp(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Jp()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async s=>{const a=s&&ba(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:e,path:t,...s,body:a}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var p;const r={...e},{method:s,path:a,query:i,headers:o={}}=r,c=ArrayBuffer.isView(r.body)||r.__binaryRequest&&typeof r.body=="string"?r.body:jc(r.body)?r.body.body:r.body?JSON.stringify(r.body,null,2):null,l=this.calculateContentLength(c),u=this.buildURL(a,i);"timeout"in r&&di("timeout",r.timeout),r.timeout=r.timeout??this.timeout;const d=r.httpAgent??this.httpAgent??Zu(u),h=r.timeout+1e3;typeof((p=d==null?void 0:d.options)==null?void 0:p.timeout)=="number"&&h>(d.options.timeout??0)&&(d.options.timeout=h),this.idempotencyHeader&&s!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey);const f=this.buildHeaders({options:r,headers:o,contentLength:l,retryCount:t});return{req:{method:s,...c&&{body:c},headers:f,...d&&{agent:d},signal:r.signal??null},url:u,timeout:r.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:s}){const a={};r&&(a["content-length"]=r);const i=this.defaultHeaders(e);return Uc(a,i),Uc(a,t),jc(e.body)&&Zn!=="node"&&delete a["content-type"],Os(i,"x-stainless-retry-count")===void 0&&Os(t,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(s)),Os(i,"x-stainless-timeout")===void 0&&Os(t,"x-stainless-timeout")===void 0&&e.timeout&&(a["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,s){return Ee.generate(e,t,r,s)}request(e,t=null){return new wa(this.makeRequest(e,t))}async makeRequest(e,t){var d,h;const r=await e,s=r.maxRetries??this.maxRetries;t==null&&(t=s),await this.prepareOptions(r);const{req:a,url:i,timeout:o}=this.buildRequest(r,{retryCount:s-t});if(await this.prepareRequest(a,{url:i,options:r}),Jt("request",i,r,a.headers),(d=r.signal)!=null&&d.aborted)throw new Je;const c=new AbortController,l=await this.fetchWithTimeout(i,a,o,c).catch(Wi);if(l instanceof Error){if((h=r.signal)!=null&&h.aborted)throw new Je;if(t)return this.retryRequest(r,t);throw l.name==="AbortError"?new ya:new ga({cause:l})}const u=ud(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){const y=`retrying, ${t} attempts remaining`;return Jt(`response (error; ${y})`,l.status,i,u),this.retryRequest(r,t,u)}const f=await l.text().catch(y=>Wi(y).message),g=Vp(f),p=g?void 0:f;throw Jt(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,i,u,p),this.makeStatusError(l.status,g,p,u)}return{response:l,options:r,controller:c}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new Fp(this,r,e)}buildURL(e,t){const r=Gp(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return dd(s)||(t={...s,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new F(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,s){const{signal:a,...i}=t||{};a&&a.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),r),c={signal:s.signal,...i};return c.method&&(c.method=c.method.toUpperCase()),this.fetch.call(void 0,e,c).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let s;const a=r==null?void 0:r["retry-after-ms"];if(a){const o=parseFloat(a);Number.isNaN(o)||(s=o)}const i=r==null?void 0:r["retry-after"];if(i&&!s){const o=parseFloat(i);Number.isNaN(o)?s=Date.parse(i)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,o)}return await as(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const a=t-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Or}`}}class ld{constructor(e,t,r,s){Es.set(this,void 0),Dp(this,Es,e),this.options=s,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new F("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[s,a]of r)e.url.searchParams.set(s,a);t.query=void 0,t.path=e.url.toString()}return await Mp(this,Es,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Es=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Fp extends wa{constructor(e,t,r){super(t,async s=>new r(e,s.response,await od(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const ud=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),Bp={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},le=n=>typeof n=="object"&&n!==null&&!dd(n)&&Object.keys(n).every(e=>hd(Bp,e)),zp=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Or,"X-Stainless-OS":Dc(Deno.build.os),"X-Stainless-Arch":Lc(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Or,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Or,"X-Stainless-OS":Dc(process.platform),"X-Stainless-Arch":Lc(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const n=Zp();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Or,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Or,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Zp(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const r=t.exec(navigator.userAgent);if(r){const s=r[1]||0,a=r[2]||0,i=r[3]||0;return{browser:e,version:`${s}.${a}.${i}`}}}return null}const Lc=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Dc=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Mc;const qp=()=>Mc??(Mc=zp()),Vp=n=>{try{return JSON.parse(n)}catch{return}},Hp=/^[a-z][a-z0-9+.-]*:/i,Gp=n=>Hp.test(n),as=n=>new Promise(e=>setTimeout(e,n)),di=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new F(`${n} must be an integer`);if(e<0)throw new F(`${n} must be a positive integer`);return e},Wi=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(n)},As=n=>{var e,t,r,s;if(typeof process<"u")return((e=Nr==null?void 0:Nr[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(s=(r=(t=Deno.env)==null?void 0:t.get)==null?void 0:r.call(t,n))==null?void 0:s.trim()};function dd(n){if(!n)return!0;for(const e in n)return!1;return!0}function hd(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Uc(n,e){for(const t in e){if(!hd(e,t))continue;const r=t.toLowerCase();if(!r)continue;const s=e[t];s===null?delete n[r]:s!==void 0&&(n[r]=s)}}const Fc=new Set(["authorization","api-key"]);function Jt(n,...e){if(typeof process<"u"&&(Nr==null?void 0:Nr.DEBUG)==="true"){const t=e.map(r=>{if(!r)return r;if(r.headers){const a={...r,headers:{...r.headers}};for(const i in r.headers)Fc.has(i.toLowerCase())&&(a.headers[i]="REDACTED");return a}let s=null;for(const a in r)Fc.has(a.toLowerCase())&&(s??(s={...r}),s[a]="REDACTED");return s??r});console.log(`OpenAI:DEBUG:${n}`,...t)}}const Jp=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Kp=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",Wp=n=>typeof(n==null?void 0:n.get)=="function",Os=(n,e)=>{var r;const t=e.toLowerCase();if(Wp(n)){const s=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(a,i,o)=>i+o.toUpperCase());for(const a of[e,t,e.toUpperCase(),s]){const i=n.get(a);if(i)return i}}for(const[s,a]of Object.entries(n))if(s.toLowerCase()===t)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${e} header, using the first entry.`),a[0]):a},Xp=n=>{if(typeof Buffer<"u"){const e=Buffer.from(n,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(n),t=e.length,r=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=e.charCodeAt(s);return Array.from(new Float32Array(r.buffer))}};function hi(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}class va extends ld{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class Oe extends ld{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var r;const e=this.getPaginatedItems();if(!e.length)return null;const t=(r=e[e.length-1])==null?void 0:r.id;return t?{params:{after:t}}:null}}class K{constructor(e){this._client=e}}let fd=class extends K{list(e,t={},r){return le(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,Yp,{query:t,...r})}},Ea=class extends K{constructor(){super(...arguments),this.messages=new fd(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,r){return this._client.post(`/chat/completions/${e}`,{body:t,...r})}list(e={},t){return le(e)?this.list({},e):this._client.getAPIList("/chat/completions",Aa,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}};class Aa extends Oe{}class Yp extends Oe{}Ea.ChatCompletionsPage=Aa;Ea.Messages=fd;let Oa=class extends K{constructor(){super(...arguments),this.completions=new Ea(this._client)}};Oa.Completions=Ea;Oa.ChatCompletionsPage=Aa;class pd extends K{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t==null?void 0:t.headers},__binaryResponse:!0})}}class md extends K{create(e,t){return this._client.post("/audio/transcriptions",Mr({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class gd extends K{create(e,t){return this._client.post("/audio/translations",Mr({body:e,...t,__metadata:{model:e.model}}))}}class is extends K{constructor(){super(...arguments),this.transcriptions=new md(this._client),this.translations=new gd(this._client),this.speech=new pd(this._client)}}is.Transcriptions=md;is.Translations=gd;is.Speech=pd;class Oo extends K{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return le(e)?this.list({},e):this._client.getAPIList("/batches",So,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class So extends Oe{}Oo.BatchesPage=So;class Po extends K{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},t){return le(e)?this.list({},e):this._client.getAPIList("/assistants",xo,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class xo extends Oe{}Po.AssistantsPage=xo;function Bc(n){return typeof n.parse=="function"}const jr=n=>(n==null?void 0:n.role)==="assistant",yd=n=>(n==null?void 0:n.role)==="function",_d=n=>(n==null?void 0:n.role)==="tool";var ot=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},ce=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Xi,Us,Fs,$n,Nn,Bs,jn,It,Ln,Js,Ks,Sr,bd;class Ro{constructor(){Xi.add(this),this.controller=new AbortController,Us.set(this,void 0),Fs.set(this,()=>{}),$n.set(this,()=>{}),Nn.set(this,void 0),Bs.set(this,()=>{}),jn.set(this,()=>{}),It.set(this,{}),Ln.set(this,!1),Js.set(this,!1),Ks.set(this,!1),Sr.set(this,!1),ot(this,Us,new Promise((e,t)=>{ot(this,Fs,e,"f"),ot(this,$n,t,"f")}),"f"),ot(this,Nn,new Promise((e,t)=>{ot(this,Bs,e,"f"),ot(this,jn,t,"f")}),"f"),ce(this,Us,"f").catch(()=>{}),ce(this,Nn,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},ce(this,Xi,"m",bd).bind(this))},0)}_connected(){this.ended||(ce(this,Fs,"f").call(this),this._emit("connect"))}get ended(){return ce(this,Ln,"f")}get errored(){return ce(this,Js,"f")}get aborted(){return ce(this,Ks,"f")}abort(){this.controller.abort()}on(e,t){return(ce(this,It,"f")[e]||(ce(this,It,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=ce(this,It,"f")[e];if(!r)return this;const s=r.findIndex(a=>a.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(ce(this,It,"f")[e]||(ce(this,It,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{ot(this,Sr,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){ot(this,Sr,!0,"f"),await ce(this,Nn,"f")}_emit(e,...t){if(ce(this,Ln,"f"))return;e==="end"&&(ot(this,Ln,!0,"f"),ce(this,Bs,"f").call(this));const r=ce(this,It,"f")[e];if(r&&(ce(this,It,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){const s=t[0];!ce(this,Sr,"f")&&!(r!=null&&r.length)&&Promise.reject(s),ce(this,$n,"f").call(this,s),ce(this,jn,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=t[0];!ce(this,Sr,"f")&&!(r!=null&&r.length)&&Promise.reject(s),ce(this,$n,"f").call(this,s),ce(this,jn,"f").call(this,s),this._emit("end")}}_emitFinal(){}}Us=new WeakMap,Fs=new WeakMap,$n=new WeakMap,Nn=new WeakMap,Bs=new WeakMap,jn=new WeakMap,It=new WeakMap,Ln=new WeakMap,Js=new WeakMap,Ks=new WeakMap,Sr=new WeakMap,Xi=new WeakSet,bd=function(e){if(ot(this,Js,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Je),e instanceof Je)return ot(this,Ks,!0,"f"),this._emit("abort",e);if(e instanceof F)return this._emit("error",e);if(e instanceof Error){const t=new F(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new F(String(e)))};function To(n){return(n==null?void 0:n.$brand)==="auto-parseable-response-format"}function os(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function Qp(n,e){return!e||!wd(e)?{...n,choices:n.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:Io(n,e)}function Io(n,e){const t=n.choices.map(r=>{var s;if(r.finish_reason==="length")throw new td;if(r.finish_reason==="content_filter")throw new rd;return{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:((s=r.message.tool_calls)==null?void 0:s.map(a=>tm(e,a)))??void 0}:void 0,parsed:r.message.content&&!r.message.refusal?em(e,r.message.content):null}}});return{...n,choices:t}}function em(n,e){var t,r;return((t=n.response_format)==null?void 0:t.type)!=="json_schema"?null:((r=n.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function tm(n,e){var r;const t=(r=n.tools)==null?void 0:r.find(s=>{var a;return((a=s.function)==null?void 0:a.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:os(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function rm(n,e){var r;if(!n)return!1;const t=(r=n.tools)==null?void 0:r.find(s=>{var a;return((a=s.function)==null?void 0:a.name)===e.function.name});return os(t)||(t==null?void 0:t.function.strict)||!1}function wd(n){var e;return To(n.response_format)?!0:((e=n.tools)==null?void 0:e.some(t=>os(t)||t.type==="function"&&t.function.strict===!0))??!1}function nm(n){for(const e of n??[]){if(e.type!=="function")throw new F(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new F(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Me=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Pe,Yi,Ws,Qi,eo,to,vd,ro;const zc=10;class Ed extends Ro{constructor(){super(...arguments),Pe.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(yd(e)||_d(e))&&e.content)this._emit("functionCallResult",e.content);else if(jr(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(jr(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new F("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Me(this,Pe,"m",Yi).call(this)}async finalMessage(){return await this.done(),Me(this,Pe,"m",Ws).call(this)}async finalFunctionCall(){return await this.done(),Me(this,Pe,"m",Qi).call(this)}async finalFunctionCallResult(){return await this.done(),Me(this,Pe,"m",eo).call(this)}async totalUsage(){return await this.done(),Me(this,Pe,"m",to).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=Me(this,Pe,"m",Ws).call(this);t&&this._emit("finalMessage",t);const r=Me(this,Pe,"m",Yi).call(this);r&&this._emit("finalContent",r);const s=Me(this,Pe,"m",Qi).call(this);s&&this._emit("finalFunctionCall",s);const a=Me(this,Pe,"m",eo).call(this);a!=null&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",Me(this,Pe,"m",to).call(this))}async _createChatCompletion(e,t,r){const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Me(this,Pe,"m",vd).call(this,t);const a=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Io(a,t))}async _runChatCompletion(e,t,r){for(const s of t.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){var h;const s="function",{function_call:a="auto",stream:i,...o}=t,c=typeof a!="string"&&(a==null?void 0:a.name),{maxChatCompletions:l=zc}=r||{},u={};for(const f of t.functions)u[f.name||f.function.name]=f;const d=t.functions.map(f=>({name:f.name||f.function.name,parameters:f.parameters,description:f.description}));for(const f of t.messages)this._addMessage(f,!1);for(let f=0;f<l;++f){const p=(h=(await this._createChatCompletion(e,{...o,function_call:a,functions:d,messages:[...this.messages]},r)).choices[0])==null?void 0:h.message;if(!p)throw new F("missing message in ChatCompletion response");if(!p.function_call)return;const{name:m,arguments:_}=p.function_call,y=u[m];if(y){if(c&&c!==m){const k=`Invalid function_call: ${JSON.stringify(m)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:s,name:m,content:k});continue}}else{const k=`Invalid function_call: ${JSON.stringify(m)}. Available options are: ${d.map($=>JSON.stringify($.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:m,content:k});continue}let w;try{w=Bc(y)?await y.parse(_):_}catch(k){this._addMessage({role:s,name:m,content:k instanceof Error?k.message:String(k)});continue}const O=await y.function(w,this),P=Me(this,Pe,"m",ro).call(this,O);if(this._addMessage({role:s,name:m,content:P}),c)return}}async _runTools(e,t,r){var f,g,p;const s="tool",{tool_choice:a="auto",stream:i,...o}=t,c=typeof a!="string"&&((f=a==null?void 0:a.function)==null?void 0:f.name),{maxChatCompletions:l=zc}=r||{},u=t.tools.map(m=>{if(os(m)){if(!m.$callback)throw new F("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:m.$callback,name:m.function.name,description:m.function.description||"",parameters:m.function.parameters,parse:m.$parseRaw,strict:!0}}}return m}),d={};for(const m of u)m.type==="function"&&(d[m.function.name||m.function.function.name]=m.function);const h="tools"in t?u.map(m=>m.type==="function"?{type:"function",function:{name:m.function.name||m.function.function.name,parameters:m.function.parameters,description:m.function.description,strict:m.function.strict}}:m):void 0;for(const m of t.messages)this._addMessage(m,!1);for(let m=0;m<l;++m){const y=(g=(await this._createChatCompletion(e,{...o,tool_choice:a,tools:h,messages:[...this.messages]},r)).choices[0])==null?void 0:g.message;if(!y)throw new F("missing message in ChatCompletion response");if(!((p=y.tool_calls)!=null&&p.length))return;for(const w of y.tool_calls){if(w.type!=="function")continue;const O=w.id,{name:P,arguments:k}=w.function,$=d[P];if($){if(c&&c!==P){const ee=`Invalid tool_call: ${JSON.stringify(P)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:s,tool_call_id:O,content:ee});continue}}else{const ee=`Invalid tool_call: ${JSON.stringify(P)}. Available options are: ${Object.keys(d).map(gt=>JSON.stringify(gt)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:O,content:ee});continue}let Q;try{Q=Bc($)?await $.parse(k):k}catch(ee){const gt=ee instanceof Error?ee.message:String(ee);this._addMessage({role:s,tool_call_id:O,content:gt});continue}const re=await $.function(Q,this),se=Me(this,Pe,"m",ro).call(this,re);if(this._addMessage({role:s,tool_call_id:O,content:se}),c)return}}}}Pe=new WeakSet,Yi=function(){return Me(this,Pe,"m",Ws).call(this).content??null},Ws=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(jr(t)){const{function_call:r,...s}=t,a={...s,content:t.content??null,refusal:t.refusal??null};return r&&(a.function_call=r),a}}throw new F("stream ended without producing a ChatCompletionMessage with role=assistant")},Qi=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){const s=this.messages[r];if(jr(s)&&(s!=null&&s.function_call))return s.function_call;if(jr(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(t=s.tool_calls.at(-1))==null?void 0:t.function}},eo=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(yd(t)&&t.content!=null||_d(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(r=>{var s;return r.role==="assistant"&&((s=r.tool_calls)==null?void 0:s.some(a=>a.type==="function"&&a.id===t.tool_call_id))}))return t.content}},to=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},vd=function(e){if(e.n!=null&&e.n>1)throw new F("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ro=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Gn extends Ed{static runFunctions(e,t,r){const s=new Gn,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,a)),s}static runTools(e,t,r){const s=new Gn,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,a)),s}_addMessage(e,t=!0){super._addMessage(e,t),jr(e)&&e.content&&this._emit("content",e.content)}}const Ad=1,Od=2,Sd=4,Pd=8,xd=16,Rd=32,Td=64,Id=128,kd=256,Cd=Id|kd,$d=xd|Rd|Cd|Td,Nd=Ad|Od|$d,jd=Sd|Pd,sm=Nd|jd,ye={STR:Ad,NUM:Od,ARR:Sd,OBJ:Pd,NULL:xd,BOOL:Rd,NAN:Td,INFINITY:Id,MINUS_INFINITY:kd,INF:Cd,SPECIAL:$d,ATOM:Nd,COLLECTION:jd,ALL:sm};class am extends Error{}class im extends Error{}function om(n,e=ye.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return cm(n.trim(),e)}const cm=(n,e)=>{const t=n.length;let r=0;const s=h=>{throw new am(`${h} at position ${r}`)},a=h=>{throw new im(`${h} at position ${r}`)},i=()=>(d(),r>=t&&s("Unexpected end of input"),n[r]==='"'?o():n[r]==="{"?c():n[r]==="["?l():n.substring(r,r+4)==="null"||ye.NULL&e&&t-r<4&&"null".startsWith(n.substring(r))?(r+=4,null):n.substring(r,r+4)==="true"||ye.BOOL&e&&t-r<4&&"true".startsWith(n.substring(r))?(r+=4,!0):n.substring(r,r+5)==="false"||ye.BOOL&e&&t-r<5&&"false".startsWith(n.substring(r))?(r+=5,!1):n.substring(r,r+8)==="Infinity"||ye.INFINITY&e&&t-r<8&&"Infinity".startsWith(n.substring(r))?(r+=8,1/0):n.substring(r,r+9)==="-Infinity"||ye.MINUS_INFINITY&e&&1<t-r&&t-r<9&&"-Infinity".startsWith(n.substring(r))?(r+=9,-1/0):n.substring(r,r+3)==="NaN"||ye.NAN&e&&t-r<3&&"NaN".startsWith(n.substring(r))?(r+=3,NaN):u()),o=()=>{const h=r;let f=!1;for(r++;r<t&&(n[r]!=='"'||f&&n[r-1]==="\\");)f=n[r]==="\\"?!f:!1,r++;if(n.charAt(r)=='"')try{return JSON.parse(n.substring(h,++r-Number(f)))}catch(g){a(String(g))}else if(ye.STR&e)try{return JSON.parse(n.substring(h,r-Number(f))+'"')}catch{return JSON.parse(n.substring(h,n.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},c=()=>{r++,d();const h={};try{for(;n[r]!=="}";){if(d(),r>=t&&ye.OBJ&e)return h;const f=o();d(),r++;try{const g=i();Object.defineProperty(h,f,{value:g,writable:!0,enumerable:!0,configurable:!0})}catch(g){if(ye.OBJ&e)return h;throw g}d(),n[r]===","&&r++}}catch{if(ye.OBJ&e)return h;s("Expected '}' at end of object")}return r++,h},l=()=>{r++;const h=[];try{for(;n[r]!=="]";)h.push(i()),d(),n[r]===","&&r++}catch{if(ye.ARR&e)return h;s("Expected ']' at end of array")}return r++,h},u=()=>{if(r===0){n==="-"&&ye.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(n)}catch(f){if(ye.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}a(String(f))}}const h=r;for(n[r]==="-"&&r++;n[r]&&!",]}".includes(n[r]);)r++;r==t&&!(ye.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(n.substring(h,r))}catch{n.substring(h,r)==="-"&&ye.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(n.substring(h,n.lastIndexOf("e")))}catch(g){a(String(g))}}},d=()=>{for(;r<t&&` 
\r	`.includes(n[r]);)r++};return i()},Zc=n=>om(n,ye.ALL^ye.NUM);var _r=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},ie=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},pe,Rt,br,Ft,fi,Ss,pi,mi,gi,Ps,yi,qc;class Jn extends Ed{constructor(e){super(),pe.add(this),Rt.set(this,void 0),br.set(this,void 0),Ft.set(this,void 0),_r(this,Rt,e,"f"),_r(this,br,[],"f")}get currentChatCompletionSnapshot(){return ie(this,Ft,"f")}static fromReadableStream(e){const t=new Jn(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){const s=new Jn(t);return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,r){var i;super._createChatCompletion;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),ie(this,pe,"m",fi).call(this);const a=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of a)ie(this,pe,"m",pi).call(this,o);if((i=a.controller.signal)!=null&&i.aborted)throw new Je;return this._addChatCompletion(ie(this,pe,"m",Ps).call(this))}async _fromReadableStream(e,t){var i;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),ie(this,pe,"m",fi).call(this),this._connected();const s=Ot.fromReadableStream(e,this.controller);let a;for await(const o of s)a&&a!==o.id&&this._addChatCompletion(ie(this,pe,"m",Ps).call(this)),ie(this,pe,"m",pi).call(this,o),a=o.id;if((i=s.controller.signal)!=null&&i.aborted)throw new Je;return this._addChatCompletion(ie(this,pe,"m",Ps).call(this))}[(Rt=new WeakMap,br=new WeakMap,Ft=new WeakMap,pe=new WeakSet,fi=function(){this.ended||_r(this,Ft,void 0,"f")},Ss=function(t){let r=ie(this,br,"f")[t.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},ie(this,br,"f")[t.index]=r,r)},pi=function(t){var s,a,i,o,c,l,u,d,h,f,g,p,m,_,y;if(this.ended)return;const r=ie(this,pe,"m",qc).call(this,t);this._emit("chunk",t,r);for(const w of t.choices){const O=r.choices[w.index];w.delta.content!=null&&((s=O.message)==null?void 0:s.role)==="assistant"&&((a=O.message)!=null&&a.content)&&(this._emit("content",w.delta.content,O.message.content),this._emit("content.delta",{delta:w.delta.content,snapshot:O.message.content,parsed:O.message.parsed})),w.delta.refusal!=null&&((i=O.message)==null?void 0:i.role)==="assistant"&&((o=O.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:w.delta.refusal,snapshot:O.message.refusal}),((c=w.logprobs)==null?void 0:c.content)!=null&&((l=O.message)==null?void 0:l.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(u=w.logprobs)==null?void 0:u.content,snapshot:((d=O.logprobs)==null?void 0:d.content)??[]}),((h=w.logprobs)==null?void 0:h.refusal)!=null&&((f=O.message)==null?void 0:f.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(g=w.logprobs)==null?void 0:g.refusal,snapshot:((p=O.logprobs)==null?void 0:p.refusal)??[]});const P=ie(this,pe,"m",Ss).call(this,O);O.finish_reason&&(ie(this,pe,"m",gi).call(this,O),P.current_tool_call_index!=null&&ie(this,pe,"m",mi).call(this,O,P.current_tool_call_index));for(const k of w.delta.tool_calls??[])P.current_tool_call_index!==k.index&&(ie(this,pe,"m",gi).call(this,O),P.current_tool_call_index!=null&&ie(this,pe,"m",mi).call(this,O,P.current_tool_call_index)),P.current_tool_call_index=k.index;for(const k of w.delta.tool_calls??[]){const $=(m=O.message.tool_calls)==null?void 0:m[k.index];$!=null&&$.type&&(($==null?void 0:$.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(_=$.function)==null?void 0:_.name,index:k.index,arguments:$.function.arguments,parsed_arguments:$.function.parsed_arguments,arguments_delta:((y=k.function)==null?void 0:y.arguments)??""}):($==null||$.type,void 0))}}},mi=function(t,r){var i,o,c;if(ie(this,pe,"m",Ss).call(this,t).done_tool_calls.has(r))return;const a=(i=t.message.tool_calls)==null?void 0:i[r];if(!a)throw new Error("no tool call snapshot");if(!a.type)throw new Error("tool call snapshot missing `type`");if(a.type==="function"){const l=(c=(o=ie(this,Rt,"f"))==null?void 0:o.tools)==null?void 0:c.find(u=>u.type==="function"&&u.function.name===a.function.name);this._emit("tool_calls.function.arguments.done",{name:a.function.name,index:r,arguments:a.function.arguments,parsed_arguments:os(l)?l.$parseRaw(a.function.arguments):l!=null&&l.function.strict?JSON.parse(a.function.arguments):null})}else a.type},gi=function(t){var s,a;const r=ie(this,pe,"m",Ss).call(this,t);if(t.message.content&&!r.content_done){r.content_done=!0;const i=ie(this,pe,"m",yi).call(this);this._emit("content.done",{content:t.message.content,parsed:i?i.$parseRaw(t.message.content):null})}t.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),(s=t.logprobs)!=null&&s.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),(a=t.logprobs)!=null&&a.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},Ps=function(){if(this.ended)throw new F("stream has ended, this shouldn't happen");const t=ie(this,Ft,"f");if(!t)throw new F("request ended without sending any chunks");return _r(this,Ft,void 0,"f"),_r(this,br,[],"f"),lm(t,ie(this,Rt,"f"))},yi=function(){var r;const t=(r=ie(this,Rt,"f"))==null?void 0:r.response_format;return To(t)?t:null},qc=function(t){var r,s,a,i;let o=ie(this,Ft,"f");const{choices:c,...l}=t;o?Object.assign(o,l):o=_r(this,Ft,{...l,choices:[]},"f");for(const{delta:u,finish_reason:d,index:h,logprobs:f=null,...g}of t.choices){let p=o.choices[h];if(p||(p=o.choices[h]={finish_reason:d,index:h,message:{},logprobs:f,...g}),f)if(!p.logprobs)p.logprobs=Object.assign({},f);else{const{content:k,refusal:$,...Q}=f;Object.assign(p.logprobs,Q),k&&((r=p.logprobs).content??(r.content=[]),p.logprobs.content.push(...k)),$&&((s=p.logprobs).refusal??(s.refusal=[]),p.logprobs.refusal.push(...$))}if(d&&(p.finish_reason=d,ie(this,Rt,"f")&&wd(ie(this,Rt,"f")))){if(d==="length")throw new td;if(d==="content_filter")throw new rd}if(Object.assign(p,g),!u)continue;const{content:m,refusal:_,function_call:y,role:w,tool_calls:O,...P}=u;if(Object.assign(p.message,P),_&&(p.message.refusal=(p.message.refusal||"")+_),w&&(p.message.role=w),y&&(p.message.function_call?(y.name&&(p.message.function_call.name=y.name),y.arguments&&((a=p.message.function_call).arguments??(a.arguments=""),p.message.function_call.arguments+=y.arguments)):p.message.function_call=y),m&&(p.message.content=(p.message.content||"")+m,!p.message.refusal&&ie(this,pe,"m",yi).call(this)&&(p.message.parsed=Zc(p.message.content))),O){p.message.tool_calls||(p.message.tool_calls=[]);for(const{index:k,id:$,type:Q,function:re,...se}of O){const ee=(i=p.message.tool_calls)[k]??(i[k]={});Object.assign(ee,se),$&&(ee.id=$),Q&&(ee.type=Q),re&&(ee.function??(ee.function={name:re.name??"",arguments:""})),re!=null&&re.name&&(ee.function.name=re.name),re!=null&&re.arguments&&(ee.function.arguments+=re.arguments,rm(ie(this,Rt,"f"),ee)&&(ee.function.parsed_arguments=Zc(ee.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("chunk",s=>{const a=t.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(const a of t)a.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(const a of t)a.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ot(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function lm(n,e){const{id:t,choices:r,created:s,model:a,system_fingerprint:i,...o}=n,c={...o,id:t,choices:r.map(({message:l,finish_reason:u,index:d,logprobs:h,...f})=>{if(!u)throw new F(`missing finish_reason for choice ${d}`);const{content:g=null,function_call:p,tool_calls:m,..._}=l,y=l.role;if(!y)throw new F(`missing role for choice ${d}`);if(p){const{arguments:w,name:O}=p;if(w==null)throw new F(`missing function_call.arguments for choice ${d}`);if(!O)throw new F(`missing function_call.name for choice ${d}`);return{...f,message:{content:g,function_call:{arguments:w,name:O},role:y,refusal:l.refusal??null},finish_reason:u,index:d,logprobs:h}}return m?{...f,index:d,finish_reason:u,logprobs:h,message:{..._,role:y,content:g,refusal:l.refusal??null,tool_calls:m.map((w,O)=>{const{function:P,type:k,id:$,...Q}=w,{arguments:re,name:se,...ee}=P||{};if($==null)throw new F(`missing choices[${d}].tool_calls[${O}].id
${xs(n)}`);if(k==null)throw new F(`missing choices[${d}].tool_calls[${O}].type
${xs(n)}`);if(se==null)throw new F(`missing choices[${d}].tool_calls[${O}].function.name
${xs(n)}`);if(re==null)throw new F(`missing choices[${d}].tool_calls[${O}].function.arguments
${xs(n)}`);return{...Q,id:$,type:k,function:{...ee,name:se,arguments:re}}})}}:{...f,message:{..._,content:g,role:y,refusal:l.refusal??null},finish_reason:u,index:d,logprobs:h}}),created:s,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return Qp(c,e)}function xs(n){return JSON.stringify(n)}class Lr extends Jn{static fromReadableStream(e){const t=new Lr(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){const s=new Lr(null),a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,a)),s}static runTools(e,t,r){const s=new Lr(t),a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,a)),s}}let Ld=class extends K{parse(e,t){return nm(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t==null?void 0:t.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(r=>Io(r,e))}runFunctions(e,t){return e.stream?Lr.runFunctions(this._client,e,t):Gn.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Lr.runTools(this._client,e,t):Gn.runTools(this._client,e,t)}stream(e,t){return Jn.createChatCompletion(this._client,e,t)}};class no extends K{constructor(){super(...arguments),this.completions=new Ld(this._client)}}(function(n){n.Completions=Ld})(no||(no={}));class Dd extends K{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class Md extends K{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class Sa extends K{constructor(){super(...arguments),this.sessions=new Dd(this._client),this.transcriptionSessions=new Md(this._client)}}Sa.Sessions=Dd;Sa.TranscriptionSessions=Md;var j=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},qe=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},we,so,vt,zs,ct,ar,Tr,nr,Xs,He,Zs,qs,qn,Dn,Mn,Vc,Hc,Gc,Jc,Kc,Wc,Xc;class lt extends Ro{constructor(){super(...arguments),we.add(this),so.set(this,[]),vt.set(this,{}),zs.set(this,{}),ct.set(this,void 0),ar.set(this,void 0),Tr.set(this,void 0),nr.set(this,void 0),Xs.set(this,void 0),He.set(this,void 0),Zs.set(this,void 0),qs.set(this,void 0),qn.set(this,void 0)}[(so=new WeakMap,vt=new WeakMap,zs=new WeakMap,ct=new WeakMap,ar=new WeakMap,Tr=new WeakMap,nr=new WeakMap,Xs=new WeakMap,He=new WeakMap,Zs=new WeakMap,qs=new WeakMap,qn=new WeakMap,we=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",s=>{const a=t.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(const a of t)a.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(const a of t)a.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new lt;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var a;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=Ot.fromReadableStream(e,this.controller);for await(const i of s)j(this,we,"m",Dn).call(this,i);if((a=s.controller.signal)!=null&&a.aborted)throw new Je;return this._addRun(j(this,we,"m",Mn).call(this))}toReadableStream(){return new Ot(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,s,a){const i=new lt;return i._run(()=>i._runToolAssistantStream(e,t,r,s,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,s,a){var l;const i=a==null?void 0:a.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const o={...s,stream:!0},c=await e.submitToolOutputs(t,r,o,{...a,signal:this.controller.signal});this._connected();for await(const u of c)j(this,we,"m",Dn).call(this,u);if((l=c.controller.signal)!=null&&l.aborted)throw new Je;return this._addRun(j(this,we,"m",Mn).call(this))}static createThreadAssistantStream(e,t,r){const s=new lt;return s._run(()=>s._threadAssistantStream(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,t,r,s){const a=new lt;return a._run(()=>a._runAssistantStream(e,t,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return j(this,Zs,"f")}currentRun(){return j(this,qs,"f")}currentMessageSnapshot(){return j(this,ct,"f")}currentRunStepSnapshot(){return j(this,qn,"f")}async finalRunSteps(){return await this.done(),Object.values(j(this,vt,"f"))}async finalMessages(){return await this.done(),Object.values(j(this,zs,"f"))}async finalRun(){if(await this.done(),!j(this,ar,"f"))throw Error("Final run was not received.");return j(this,ar,"f")}async _createThreadAssistantStream(e,t,r){var o;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const a={...t,stream:!0},i=await e.createAndRun(a,{...r,signal:this.controller.signal});this._connected();for await(const c of i)j(this,we,"m",Dn).call(this,c);if((o=i.controller.signal)!=null&&o.aborted)throw new Je;return this._addRun(j(this,we,"m",Mn).call(this))}async _createAssistantStream(e,t,r,s){var c;const a=s==null?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...r,stream:!0},o=await e.create(t,i,{...s,signal:this.controller.signal});this._connected();for await(const l of o)j(this,we,"m",Dn).call(this,l);if((c=o.controller.signal)!=null&&c.aborted)throw new Je;return this._addRun(j(this,we,"m",Mn).call(this))}static accumulateDelta(e,t){for(const[r,s]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=s;continue}let a=e[r];if(a==null){e[r]=s;continue}if(r==="index"||r==="type"){e[r]=s;continue}if(typeof a=="string"&&typeof s=="string")a+=s;else if(typeof a=="number"&&typeof s=="number")a+=s;else if(hi(a)&&hi(s))a=this.accumulateDelta(a,s);else if(Array.isArray(a)&&Array.isArray(s)){if(a.every(i=>typeof i=="string"||typeof i=="number")){a.push(...s);continue}for(const i of s){if(!hi(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);const o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const c=a[o];c==null?a.push(i):a[o]=this.accumulateDelta(c,i)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${s}, accValue: ${a}`);e[r]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,s){return await this._createAssistantStream(t,e,r,s)}async _runToolAssistantStream(e,t,r,s,a){return await this._createToolAssistantStream(r,e,t,s,a)}}Dn=function(e){if(!this.ended)switch(qe(this,Zs,e,"f"),j(this,we,"m",Gc).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":j(this,we,"m",Xc).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":j(this,we,"m",Hc).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":j(this,we,"m",Vc).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Mn=function(){if(this.ended)throw new F("stream has ended, this shouldn't happen");if(!j(this,ar,"f"))throw Error("Final run has not been received");return j(this,ar,"f")},Vc=function(e){const[t,r]=j(this,we,"m",Kc).call(this,e,j(this,ct,"f"));qe(this,ct,t,"f"),j(this,zs,"f")[t.id]=t;for(const s of r){const a=t.content[s.index];(a==null?void 0:a.type)=="text"&&this._emit("textCreated",a.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const s of e.data.delta.content){if(s.type=="text"&&s.text){let a=s.text,i=t.content[s.index];if(i&&i.type=="text")this._emit("textDelta",a,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=j(this,Tr,"f")){if(j(this,nr,"f"))switch(j(this,nr,"f").type){case"text":this._emit("textDone",j(this,nr,"f").text,j(this,ct,"f"));break;case"image_file":this._emit("imageFileDone",j(this,nr,"f").image_file,j(this,ct,"f"));break}qe(this,Tr,s.index,"f")}qe(this,nr,t.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(j(this,Tr,"f")!==void 0){const s=e.data.content[j(this,Tr,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,j(this,ct,"f"));break;case"text":this._emit("textDone",s.text,j(this,ct,"f"));break}}j(this,ct,"f")&&this._emit("messageDone",e.data),qe(this,ct,void 0,"f")}},Hc=function(e){const t=j(this,we,"m",Jc).call(this,e);switch(qe(this,qn,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(const a of r.step_details.tool_calls)a.index==j(this,Xs,"f")?this._emit("toolCallDelta",a,t.step_details.tool_calls[a.index]):(j(this,He,"f")&&this._emit("toolCallDone",j(this,He,"f")),qe(this,Xs,a.index,"f"),qe(this,He,t.step_details.tool_calls[a.index],"f"),j(this,He,"f")&&this._emit("toolCallCreated",j(this,He,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":qe(this,qn,void 0,"f"),e.data.step_details.type=="tool_calls"&&j(this,He,"f")&&(this._emit("toolCallDone",j(this,He,"f")),qe(this,He,void 0,"f")),this._emit("runStepDone",e.data,t);break}},Gc=function(e){j(this,so,"f").push(e),this._emit("event",e)},Jc=function(e){switch(e.event){case"thread.run.step.created":return j(this,vt,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=j(this,vt,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){const s=lt.accumulateDelta(t,r.delta);j(this,vt,"f")[e.data.id]=s}return j(this,vt,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":j(this,vt,"f")[e.data.id]=e.data;break}if(j(this,vt,"f")[e.data.id])return j(this,vt,"f")[e.data.id];throw new Error("No snapshot available")},Kc=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const a of s.delta.content)if(a.index in t.content){let i=t.content[a.index];t.content[a.index]=j(this,we,"m",Wc).call(this,a,i)}else t.content[a.index]=a,r.push(a);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Wc=function(e,t){return lt.accumulateDelta(t,e)},Xc=function(e){switch(qe(this,qs,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":qe(this,ar,e.data,"f"),j(this,He,"f")&&(this._emit("toolCallDone",j(this,He,"f")),qe(this,He,void 0,"f"));break}};class ko extends K{create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,t={},r){return le(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Co,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class Co extends Oe{}ko.MessagesPage=Co;class $o extends K{retrieve(e,t,r,s={},a){return le(s)?this.retrieve(e,t,r,{},s):this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{query:s,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t,r={},s){return le(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,No,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}}class No extends Oe{}$o.RunStepsPage=No;let cs=class extends K{constructor(){super(...arguments),this.steps=new $o(this._client)}create(e,t,r){const{include:s,...a}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:s},body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers},stream:t.stream??!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,t={},r){return le(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,jo,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){const s=await this.create(e,t,r);return await this.poll(e,s.id,r)}createAndStream(e,t,r){return lt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,t,{...r,headers:{...r==null?void 0:r.headers,...s}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const c=i.headers.get("openai-poll-after-ms");if(c){const l=parseInt(c);isNaN(l)||(o=l)}}await as(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,t,r){return lt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,s){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,t,r,s){const a=await this.submitToolOutputs(e,t,r,s);return await this.poll(e,a.id,s)}submitToolOutputsStream(e,t,r,s){return lt.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,s)}};class jo extends Oe{}cs.RunsPage=jo;cs.Steps=$o;cs.RunStepsPage=No;class en extends K{constructor(){super(...arguments),this.runs=new cs(this._client),this.messages=new ko(this._client)}create(e={},t){return le(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return lt.createThreadAssistantStream(e,this._client.beta.threads,t)}}en.Runs=cs;en.RunsPage=jo;en.Messages=ko;en.MessagesPage=Co;class tn extends K{constructor(){super(...arguments),this.realtime=new Sa(this._client),this.chat=new no(this._client),this.assistants=new Po(this._client),this.threads=new en(this._client)}}tn.Realtime=Sa;tn.Assistants=Po;tn.AssistantsPage=xo;tn.Threads=en;class Ud extends K{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Fd extends K{create(e,t){const r=!!e.encoding_format;let s=r?e.encoding_format:"base64";r&&Jt("Request","User defined encoding_format:",e.encoding_format);const a=this._client.post("/embeddings",{body:{...e,encoding_format:s},...t});return r?a:(Jt("response","Decoding base64 embeddings to float32 array"),a._thenUnwrap(i=>(i&&i.data&&i.data.forEach(o=>{const c=o.embedding;o.embedding=Xp(c)}),i)))}}class Lo extends K{retrieve(e,t,r,s){return this._client.get(`/evals/${e}/runs/${t}/output_items/${r}`,s)}list(e,t,r={},s){return le(r)?this.list(e,t,{},r):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,Do,{query:r,...s})}}class Do extends Oe{}Lo.OutputItemListResponsesPage=Do;class ls extends K{constructor(){super(...arguments),this.outputItems=new Lo(this._client)}create(e,t,r){return this._client.post(`/evals/${e}/runs`,{body:t,...r})}retrieve(e,t,r){return this._client.get(`/evals/${e}/runs/${t}`,r)}list(e,t={},r){return le(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,Mo,{query:t,...r})}del(e,t,r){return this._client.delete(`/evals/${e}/runs/${t}`,r)}cancel(e,t,r){return this._client.post(`/evals/${e}/runs/${t}`,r)}}class Mo extends Oe{}ls.RunListResponsesPage=Mo;ls.OutputItems=Lo;ls.OutputItemListResponsesPage=Do;class us extends K{constructor(){super(...arguments),this.runs=new ls(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,r){return this._client.post(`/evals/${e}`,{body:t,...r})}list(e={},t){return le(e)?this.list({},e):this._client.getAPIList("/evals",Uo,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class Uo extends Oe{}us.EvalListResponsesPage=Uo;us.Runs=ls;us.RunListResponsesPage=Mo;let Fo=class extends K{create(e,t){return this._client.post("/files",Mr({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return le(e)?this.list({},e):this._client.getAPIList("/files",Bo,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t==null?void 0:t.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){const s=new Set(["processed","error","deleted"]),a=Date.now();let i=await this.retrieve(e);for(;!i.status||!s.has(i.status);)if(await as(t),i=await this.retrieve(e),Date.now()-a>r)throw new ya({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}};class Bo extends Oe{}Fo.FileObjectsPage=Bo;class zo extends K{create(e,t,r){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,Zo,{body:t,method:"post",...r})}retrieve(e,t={},r){return le(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...r})}del(e,t){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions`,t)}}class Zo extends va{}zo.PermissionCreateResponsesPage=Zo;let Pa=class extends K{constructor(){super(...arguments),this.permissions=new zo(this._client)}};Pa.Permissions=zo;Pa.PermissionCreateResponsesPage=Zo;class qo extends K{list(e,t={},r){return le(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Vo,{query:t,...r})}}class Vo extends Oe{}qo.FineTuningJobCheckpointsPage=Vo;class rn extends K{constructor(){super(...arguments),this.checkpoints=new qo(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return le(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Ho,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return le(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Go,{query:t,...r})}}class Ho extends Oe{}class Go extends Oe{}rn.FineTuningJobsPage=Ho;rn.FineTuningJobEventsPage=Go;rn.Checkpoints=qo;rn.FineTuningJobCheckpointsPage=Vo;class nn extends K{constructor(){super(...arguments),this.jobs=new rn(this._client),this.checkpoints=new Pa(this._client)}}nn.Jobs=rn;nn.FineTuningJobsPage=Ho;nn.FineTuningJobEventsPage=Go;nn.Checkpoints=Pa;class Bd extends K{createVariation(e,t){return this._client.post("/images/variations",Mr({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",Mr({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class Jo extends K{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Ko,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Ko extends va{}Jo.ModelsPage=Ko;class zd extends K{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function um(n,e){return!e||!hm(e)?{...n,output_parsed:null,output:n.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(r=>({...r,parsed:null}))}:t)}:Zd(n,e)}function Zd(n,e){const t=n.output.map(s=>{if(s.type==="function_call")return{...s,parsed_arguments:mm(e,s)};if(s.type==="message"){const a=s.content.map(i=>i.type==="output_text"?{...i,parsed:dm(e,i.text)}:i);return{...s,content:a}}return s}),r=Object.assign({},n,{output:t});return Object.getOwnPropertyDescriptor(n,"output_text")||qd(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(const s of r.output)if(s.type==="message"){for(const a of s.content)if(a.type==="output_text"&&a.parsed!==null)return a.parsed}return null}}),r}function dm(n,e){var t,r,s,a;return((r=(t=n.text)==null?void 0:t.format)==null?void 0:r.type)!=="json_schema"?null:"$parseRaw"in((s=n.text)==null?void 0:s.format)?((a=n.text)==null?void 0:a.format).$parseRaw(e):JSON.parse(e)}function hm(n){var e;return!!To((e=n.text)==null?void 0:e.format)}function fm(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function pm(n,e){return n.find(t=>t.type==="function"&&t.name===e)}function mm(n,e){const t=pm(n.tools??[],e.name);return{...e,...e,parsed_arguments:fm(t)?t.$parseRaw(e.arguments):t!=null&&t.strict?JSON.parse(e.arguments):null}}function qd(n){const e=[];for(const t of n.output)if(t.type==="message")for(const r of t.content)r.type==="output_text"&&e.push(r.text);n.output_text=e.join("")}class Vd extends K{list(e,t={},r){return le(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,ym,{query:t,...r})}}var wr=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},Bt=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},vr,Rs,zt,Ts,Yc,Qc,el,tl;class Wo extends Ro{constructor(e){super(),vr.add(this),Rs.set(this,void 0),zt.set(this,void 0),Ts.set(this,void 0),wr(this,Rs,e,"f")}static createResponse(e,t,r){const s=new Wo(t);return s._run(()=>s._createResponse(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createResponse(e,t,r){var i;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Bt(this,vr,"m",Yc).call(this);const a=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of a)Bt(this,vr,"m",Qc).call(this,o);if((i=a.controller.signal)!=null&&i.aborted)throw new Je;return Bt(this,vr,"m",el).call(this)}[(Rs=new WeakMap,zt=new WeakMap,Ts=new WeakMap,vr=new WeakSet,Yc=function(){this.ended||wr(this,zt,void 0,"f")},Qc=function(t){if(this.ended)return;const r=Bt(this,vr,"m",tl).call(this,t);switch(this._emit("event",t),t.type){case"response.output_text.delta":{const s=r.output[t.output_index];if(!s)throw new F(`missing output at index ${t.output_index}`);if(s.type==="message"){const a=s.content[t.content_index];if(!a)throw new F(`missing content at index ${t.content_index}`);if(a.type!=="output_text")throw new F(`expected content to be 'output_text', got ${a.type}`);this._emit("response.output_text.delta",{...t,snapshot:a.text})}break}case"response.function_call_arguments.delta":{const s=r.output[t.output_index];if(!s)throw new F(`missing output at index ${t.output_index}`);s.type==="function_call"&&this._emit("response.function_call_arguments.delta",{...t,snapshot:s.arguments});break}default:this._emit(t.type,t);break}},el=function(){if(this.ended)throw new F("stream has ended, this shouldn't happen");const t=Bt(this,zt,"f");if(!t)throw new F("request ended without sending any events");wr(this,zt,void 0,"f");const r=gm(t,Bt(this,Rs,"f"));return wr(this,Ts,r,"f"),r},tl=function(t){let r=Bt(this,zt,"f");if(!r){if(t.type!=="response.created")throw new F(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return r=wr(this,zt,t.response,"f"),r}switch(t.type){case"response.output_item.added":{r.output.push(t.item);break}case"response.content_part.added":{const s=r.output[t.output_index];if(!s)throw new F(`missing output at index ${t.output_index}`);s.type==="message"&&s.content.push(t.part);break}case"response.output_text.delta":{const s=r.output[t.output_index];if(!s)throw new F(`missing output at index ${t.output_index}`);if(s.type==="message"){const a=s.content[t.content_index];if(!a)throw new F(`missing content at index ${t.content_index}`);if(a.type!=="output_text")throw new F(`expected content to be 'output_text', got ${a.type}`);a.text+=t.delta}break}case"response.function_call_arguments.delta":{const s=r.output[t.output_index];if(!s)throw new F(`missing output at index ${t.output_index}`);s.type==="function_call"&&(s.arguments+=t.delta);break}case"response.completed":{wr(this,zt,t.response,"f");break}}return r},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",s=>{const a=t.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(const a of t)a.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(const a of t)a.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=Bt(this,Ts,"f");if(!e)throw new F("stream ended without producing a ChatCompletion");return e}}function gm(n,e){return um(n,e)}class Xo extends K{constructor(){super(...arguments),this.inputItems=new Vd(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&qd(r),r))}retrieve(e,t={},r){return le(t)?this.retrieve(e,{},t):this._client.get(`/responses/${e}`,{query:t,...r})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t==null?void 0:t.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(r=>Zd(r,e))}stream(e,t){return Wo.createResponse(this._client,e,t)}}class ym extends Oe{}Xo.InputItems=Vd;class Hd extends K{create(e,t,r){return this._client.post(`/uploads/${e}/parts`,Mr({body:t,...r}))}}class Yo extends K{constructor(){super(...arguments),this.parts=new Hd(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(`/uploads/${e}/complete`,{body:t,...r})}}Yo.Parts=Hd;const _m=async n=>{const e=await Promise.allSettled(n),t=e.filter(s=>s.status==="rejected");if(t.length){for(const s of t)console.error(s.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const r=[];for(const s of e)s.status==="fulfilled"&&r.push(s.value);return r};class xa extends K{create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,t={},r){return le(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Ra,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){const s=await this.create(e,t,r);return await this.poll(e,s.id,r)}async poll(e,t,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const a=await this.retrieve(e,t,{...r,headers:s}).withResponse(),i=a.data;switch(i.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const c=a.response.headers.get("openai-poll-after-ms");if(c){const l=parseInt(c);isNaN(l)||(o=l)}}await as(o);break;case"failed":case"completed":return i}}}async upload(e,t,r){const s=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:s.id},r)}async uploadAndPoll(e,t,r){const s=await this.upload(e,t,r);return await this.poll(e,s.id,r)}content(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,Qo,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class Ra extends Oe{}class Qo extends va{}xa.VectorStoreFilesPage=Ra;xa.FileContentResponsesPage=Qo;class Gd extends K{create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){const s=await this.create(e,t);return await this.poll(e,s.id,r)}listFiles(e,t,r={},s){return le(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Ra,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}async poll(e,t,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,t,{...r,headers:s}).withResponse();switch(a.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const c=i.headers.get("openai-poll-after-ms");if(c){const l=parseInt(c);isNaN(l)||(o=l)}}await as(o);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},s){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=(s==null?void 0:s.maxConcurrency)??5,i=Math.min(a,t.length),o=this._client,c=t.values(),l=[...r];async function u(h){for(let f of h){const g=await o.files.create({file:f,purpose:"assistants"},s);l.push(g.id)}}const d=Array(i).fill(c).map(u);return await _m(d),await this.createAndPoll(e,{file_ids:l})}}class er extends K{constructor(){super(...arguments),this.files=new xa(this._client),this.fileBatches=new Gd(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},t){return le(e)?this.list({},e):this._client.getAPIList("/vector_stores",ec,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}search(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/search`,tc,{body:t,method:"post",...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class ec extends Oe{}class tc extends va{}er.VectorStoresPage=ec;er.VectorStoreSearchResponsesPage=tc;er.Files=xa;er.VectorStoreFilesPage=Ra;er.FileContentResponsesPage=Qo;er.FileBatches=Gd;var Jd;let G=class extends Up{constructor({baseURL:e=As("OPENAI_BASE_URL"),apiKey:t=As("OPENAI_API_KEY"),organization:r=As("OPENAI_ORG_ID")??null,project:s=As("OPENAI_PROJECT_ID")??null,...a}={}){if(t===void 0)throw new F("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:r,project:s,...a,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&Kp())throw new F(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new Ud(this),this.chat=new Oa(this),this.embeddings=new Fd(this),this.files=new Fo(this),this.images=new Bd(this),this.audio=new is(this),this.moderations=new zd(this),this.models=new Jo(this),this.fineTuning=new nn(this),this.vectorStores=new er(this),this.beta=new tn(this),this.batches=new Oo(this),this.uploads=new Yo(this),this.responses=new Xo(this),this.evals=new us(this),this._options=i,this.apiKey=t,this.organization=r,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return vp(e,{arrayFormat:"brackets"})}};Jd=G;G.OpenAI=Jd;G.DEFAULT_TIMEOUT=6e5;G.OpenAIError=F;G.APIError=Ee;G.APIConnectionError=ga;G.APIConnectionTimeoutError=ya;G.APIUserAbortError=Je;G.NotFoundError=Wu;G.ConflictError=Xu;G.RateLimitError=Qu;G.BadRequestError=Gu;G.AuthenticationError=Ju;G.InternalServerError=ed;G.PermissionDeniedError=Ku;G.UnprocessableEntityError=Yu;G.toFile=id;G.fileFromPath=qu;G.Completions=Ud;G.Chat=Oa;G.ChatCompletionsPage=Aa;G.Embeddings=Fd;G.Files=Fo;G.FileObjectsPage=Bo;G.Images=Bd;G.Audio=is;G.Moderations=zd;G.Models=Jo;G.ModelsPage=Ko;G.FineTuning=nn;G.VectorStores=er;G.VectorStoresPage=ec;G.VectorStoreSearchResponsesPage=tc;G.Beta=tn;G.Batches=Oo;G.BatchesPage=So;G.Uploads=Yo;G.Responses=Xo;G.Evals=us;G.EvalListResponsesPage=Uo;function bm(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="";const t=[];let r=!1,s=!1;for(let a of n){if(r)a==='"'&&!s?r=!1:a===`
`&&!s?a="\\n":a==="\\"?s=!s:s=!1;else if(a==='"')r=!0,s=!1;else if(a==="{")t.push("}");else if(a==="[")t.push("]");else if(a==="}"||a==="]")if(t&&t[t.length-1]===a)t.pop();else return null;e+=a}r&&(e+='"');for(let a=t.length-1;a>=0;a-=1)e+=t[a];try{return JSON.parse(e)}catch{return null}}var wm=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const vm=Ao(wm);var Kd={exports:{}};const Em=/[\p{Lu}]/u,Am=/[\p{Ll}]/u,rl=/^[\p{Lu}](?![\p{Lu}])/gu,Wd=/([\p{Alpha}\p{N}_]|$)/u,Xd=/[_.\- ]+/,Om=new RegExp("^"+Xd.source),nl=new RegExp(Xd.source+Wd.source,"gu"),sl=new RegExp("\\d+"+Wd.source,"gu"),Sm=(n,e,t)=>{let r=!1,s=!1,a=!1;for(let i=0;i<n.length;i++){const o=n[i];r&&Em.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,a=s,s=!0,i++):s&&a&&Am.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),a=s,s=!1,r=!0):(r=e(o)===o&&t(o)!==o,a=s,s=t(o)===o&&e(o)!==o)}return n},Pm=(n,e)=>(rl.lastIndex=0,n.replace(rl,t=>e(t))),xm=(n,e)=>(nl.lastIndex=0,sl.lastIndex=0,n.replace(nl,(t,r)=>e(r)).replace(sl,t=>e(t))),Yd=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(a=>a.trim()).filter(a=>a.length).join("-"):n=n.trim(),n.length===0)return"";const t=e.locale===!1?a=>a.toLowerCase():a=>a.toLocaleLowerCase(e.locale),r=e.locale===!1?a=>a.toUpperCase():a=>a.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=Sm(n,t,r)),n=n.replace(Om,""),e.preserveConsecutiveUppercase?n=Pm(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),xm(n,r))};Kd.exports=Yd;Kd.exports.default=Yd;function Rm(n,e){return(e==null?void 0:e[n])||vm(n)}function Tm(n,e,t){const r={};for(const s in n)Object.hasOwn(n,s)&&(r[e(s,t)]=n[s]);return r}function al(n){return Array.isArray(n)?[...n]:{...n}}function Im(n,e){const t=al(n);for(const[r,s]of Object.entries(e)){const[a,...i]=r.split(".").reverse();let o=t;for(const c of i.reverse()){if(o[c]===void 0)break;o[c]=al(o[c]),o=o[c]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[s]})}return t}function Qd(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}class hr{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Qd(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof hr||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((s,a)=>(s[a]=a in this?this[a]:this.lc_kwargs[a],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(t,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(t).forEach(s=>{let a=this,i=r;const[o,...c]=s.split(".").reverse();for(const l of c.reverse()){if(!(l in a)||a[l]===void 0)return;(!(l in i)||i[l]===void 0)&&(typeof a[l]=="object"&&a[l]!=null?i[l]={}:Array.isArray(a[l])&&(i[l]=[])),a=a[l],i=i[l]}o in a&&a[o]!==void 0&&(i[o]=i[o]||a[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Tm(Object.keys(t).length?Im(r,t):r,Rm,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function sn(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}class ds extends hr{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}}function Ze(n,e){const t={...n};for(const[r,s]of Object.entries(e))if(t[r]==null)t[r]=s;else{if(s==null)continue;if(typeof t[r]!=typeof s||Array.isArray(t[r])!==Array.isArray(s))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string")t[r]=t[r]+s;else if(!Array.isArray(t[r])&&typeof t[r]=="object")t[r]=Ze(t[r],s);else if(Array.isArray(t[r]))t[r]=eh(t[r],s);else{if(t[r]===s)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function eh(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{const t=[...n];for(const r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){const s=t.findIndex(a=>a.index===r.index);s!==-1?t[s]=Ze(t[s],r):t.push(r)}else t.push(r);return t}}}class an extends ds{}function km(n){return typeof(n==null?void 0:n._getType)=="function"}class rc extends an{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new rc({content:sn(this.content,e.content),additional_kwargs:Ze(this.additional_kwargs,e.additional_kwargs),response_metadata:Ze(this.response_metadata,e.response_metadata),tool_call_id:this.tool_call_id})}}function Cm(n){const e=[],t=[];for(const r of n)if(r.function){const s=r.function.name;try{const a=JSON.parse(r.function.arguments),i={name:s||"",args:a||{},id:r.id};e.push(i)}catch{t.push({name:s,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}class th extends ds{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){var s;let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;const a=(s=r.additional_kwargs)==null?void 0:s.tool_calls,i=r.tool_calls;a!=null&&a.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(a!=null&&i===void 0){const[o,c]=Cm(a);r.tool_calls=o??[],r.invalid_tool_calls=c??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls)}static lc_name(){return"AIMessage"}_getType(){return"ai"}}class Ta extends an{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else{const r=[],s=[];for(const a of e.tool_call_chunks){let i={};try{if(i=bm(a.args??"{}")??{},typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:a.name??"",args:i,id:a.id})}catch{s.push({name:a.name,args:a.args,id:a.id,error:"Malformed args."})}}t={...e,tool_calls:r,invalid_tool_calls:s}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.tool_call_chunks=(t==null?void 0:t.tool_call_chunks)??this.tool_call_chunks,this.tool_calls=(t==null?void 0:t.tool_calls)??this.tool_calls,this.invalid_tool_calls=(t==null?void 0:t.invalid_tool_calls)??this.invalid_tool_calls}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){const t={content:sn(this.content,e.content),additional_kwargs:Ze(this.additional_kwargs,e.additional_kwargs),response_metadata:Ze(this.response_metadata,e.response_metadata),tool_call_chunks:[]};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const r=eh(this.tool_call_chunks,e.tool_call_chunks);r!==void 0&&r.length>0&&(t.tool_call_chunks=r)}return new Ta(t)}}class Ia extends ds{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Ia}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}}class nc extends an{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new nc({content:sn(this.content,e.content),additional_kwargs:Ze(this.additional_kwargs,e.additional_kwargs),response_metadata:Ze(this.response_metadata,e.response_metadata),role:this.role})}}class sc extends an{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new sc({content:sn(this.content,e.content),additional_kwargs:Ze(this.additional_kwargs,e.additional_kwargs),response_metadata:Ze(this.response_metadata,e.response_metadata),name:this.name??""})}}class Ys extends ds{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class ac extends an{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new ac({content:sn(this.content,e.content),additional_kwargs:Ze(this.additional_kwargs,e.additional_kwargs),response_metadata:Ze(this.response_metadata,e.response_metadata)})}}class $m extends ds{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class ic extends an{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new ic({content:sn(this.content,e.content),additional_kwargs:Ze(this.additional_kwargs,e.additional_kwargs),response_metadata:Ze(this.response_metadata,e.response_metadata)})}}function Un(n){if(typeof n=="string")return new Ys(n);if(km(n))return n;const[e,t]=n;if(e==="human"||e==="user")return new Ys({content:t});if(e==="ai"||e==="assistant")return new th({content:t});if(e==="system")return new $m({content:t});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function rh(n,e="Human",t="AI"){const r=[];for(const s of n){let a;if(s._getType()==="human")a=e;else if(s._getType()==="ai")a=t;else if(s._getType()==="system")a="System";else if(s._getType()==="function")a="Function";else if(s._getType()==="tool")a="Tool";else if(s._getType()==="generic")a=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const i=s.name?`${s.name}, `:"";r.push(`${a}: ${i}${s.content}`)}return r.join(`
`)}const il="__run";class oc{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new oc({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class cc extends oc{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new cc({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}var _i={};const Nm=()=>typeof window<"u"&&typeof window.document<"u",jm=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Lm=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),nh=()=>typeof Deno<"u",Dm=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!nh(),Mm=()=>{let n;return Nm()?n="browser":Dm()?n="node":jm()?n="webworker":Lm()?n="jsdom":nh()?n="deno":n="other",n};let bi;async function Um(){return bi===void 0&&(bi={library:"langchain-js",runtime:Mm()}),bi}function Ge(n){try{return typeof process<"u"?_i==null?void 0:_i[n]:void 0}catch{return}}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var Fm=typeof window=="object"?window:{},J="0123456789abcdef".split(""),Bm=[-2147483648,8388608,32768,128],nt=[24,16,8,0],ge=[];function dt(n){n?(ge[0]=ge[16]=ge[1]=ge[2]=ge[3]=ge[4]=ge[5]=ge[6]=ge[7]=ge[8]=ge[9]=ge[10]=ge[11]=ge[12]=ge[13]=ge[14]=ge[15]=0,this.blocks=ge):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}dt.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===Fm.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,s,a=n.length||0,i=this.blocks;r<a;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(s=this.start;r<a&&s<64;++r)i[s>>2]|=n[r]<<nt[s++&3];else for(s=this.start;r<a&&s<64;++r)t=n.charCodeAt(r),t<128?i[s>>2]|=t<<nt[s++&3]:t<2048?(i[s>>2]|=(192|t>>6)<<nt[s++&3],i[s>>2]|=(128|t&63)<<nt[s++&3]):t<55296||t>=57344?(i[s>>2]|=(224|t>>12)<<nt[s++&3],i[s>>2]|=(128|t>>6&63)<<nt[s++&3],i[s>>2]|=(128|t&63)<<nt[s++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[s>>2]|=(240|t>>18)<<nt[s++&3],i[s>>2]|=(128|t>>12&63)<<nt[s++&3],i[s>>2]|=(128|t>>6&63)<<nt[s++&3],i[s>>2]|=(128|t&63)<<nt[s++&3]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=i[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};dt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=Bm[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};dt.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4,a,i,o,c=this.blocks;for(i=16;i<80;++i)o=c[i-3]^c[i-8]^c[i-14]^c[i-16],c[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)a=e&t|~e&r,o=n<<5|n>>>27,s=o+a+s+1518500249+c[i]<<0,e=e<<30|e>>>2,a=n&e|~n&t,o=s<<5|s>>>27,r=o+a+r+1518500249+c[i+1]<<0,n=n<<30|n>>>2,a=s&n|~s&e,o=r<<5|r>>>27,t=o+a+t+1518500249+c[i+2]<<0,s=s<<30|s>>>2,a=r&s|~r&n,o=t<<5|t>>>27,e=o+a+e+1518500249+c[i+3]<<0,r=r<<30|r>>>2,a=t&r|~t&s,o=e<<5|e>>>27,n=o+a+n+1518500249+c[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)a=e^t^r,o=n<<5|n>>>27,s=o+a+s+1859775393+c[i]<<0,e=e<<30|e>>>2,a=n^e^t,o=s<<5|s>>>27,r=o+a+r+1859775393+c[i+1]<<0,n=n<<30|n>>>2,a=s^n^e,o=r<<5|r>>>27,t=o+a+t+1859775393+c[i+2]<<0,s=s<<30|s>>>2,a=r^s^n,o=t<<5|t>>>27,e=o+a+e+1859775393+c[i+3]<<0,r=r<<30|r>>>2,a=t^r^s,o=e<<5|e>>>27,n=o+a+n+1859775393+c[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)a=e&t|e&r|t&r,o=n<<5|n>>>27,s=o+a+s-1894007588+c[i]<<0,e=e<<30|e>>>2,a=n&e|n&t|e&t,o=s<<5|s>>>27,r=o+a+r-1894007588+c[i+1]<<0,n=n<<30|n>>>2,a=s&n|s&e|n&e,o=r<<5|r>>>27,t=o+a+t-1894007588+c[i+2]<<0,s=s<<30|s>>>2,a=r&s|r&n|s&n,o=t<<5|t>>>27,e=o+a+e-1894007588+c[i+3]<<0,r=r<<30|r>>>2,a=t&r|t&s|r&s,o=e<<5|e>>>27,n=o+a+n-1894007588+c[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)a=e^t^r,o=n<<5|n>>>27,s=o+a+s-899497514+c[i]<<0,e=e<<30|e>>>2,a=n^e^t,o=s<<5|s>>>27,r=o+a+r-899497514+c[i+1]<<0,n=n<<30|n>>>2,a=s^n^e,o=r<<5|r>>>27,t=o+a+t-899497514+c[i+2]<<0,s=s<<30|s>>>2,a=r^s^n,o=t<<5|t>>>27,e=o+a+e-899497514+c[i+3]<<0,r=r<<30|r>>>2,a=t^r^s,o=e<<5|e>>>27,n=o+a+n-899497514+c[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+s<<0};dt.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4;return J[n>>28&15]+J[n>>24&15]+J[n>>20&15]+J[n>>16&15]+J[n>>12&15]+J[n>>8&15]+J[n>>4&15]+J[n&15]+J[e>>28&15]+J[e>>24&15]+J[e>>20&15]+J[e>>16&15]+J[e>>12&15]+J[e>>8&15]+J[e>>4&15]+J[e&15]+J[t>>28&15]+J[t>>24&15]+J[t>>20&15]+J[t>>16&15]+J[t>>12&15]+J[t>>8&15]+J[t>>4&15]+J[t&15]+J[r>>28&15]+J[r>>24&15]+J[r>>20&15]+J[r>>16&15]+J[r>>12&15]+J[r>>8&15]+J[r>>4&15]+J[r&15]+J[s>>28&15]+J[s>>24&15]+J[s>>20&15]+J[s>>16&15]+J[s>>12&15]+J[s>>8&15]+J[s>>4&15]+J[s&15]};dt.prototype.toString=dt.prototype.hex;dt.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,s>>24&255,s>>16&255,s>>8&255,s&255]};dt.prototype.array=dt.prototype.digest;dt.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};const zm=n=>new dt(!0).update(n).hex(),ol=(...n)=>zm(n.join("_"));class Zm{}const qm=new Map;class lc extends Zm{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(ol(e,t))??null)}async update(e,t,r){this.cache.set(ol(e,t),r)}static global(){return new lc(qm)}}class sh extends hr{}class ah extends sh{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Ys(this.value)]}}class Vm extends sh{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return rh(this.messages)}toChatMessages(){return this.messages}}var ka={exports:{}},ih={};function rt(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var Hm=rt;rt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};rt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};rt.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};rt.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};rt.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};rt.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};rt.prototype.start=rt.prototype.try;rt.prototype.errors=function(){return this._errors};rt.prototype.attempts=function(){return this._attempts};rt.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var s=this._errors[r],a=s.message,i=(n[a]||0)+1;n[a]=i,i>=t&&(e=s,t=i)}return e};(function(n){var e=Hm;n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)r[s]=t[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],i=0;i<r.retries;i++)a.push(this.createTimeout(i,r));return t&&t.forever&&!a.length&&a.push(this.createTimeout(i,r)),a.sort(function(o,c){return o-c}),a},n.createTimeout=function(t,r){var s=r.randomize?Math.random()+1:1,a=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return a=Math.min(a,r.maxTimeout),a},n.wrap=function(t,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var a in t)typeof t[a]=="function"&&s.push(a)}for(var i=0;i<s.length;i++){var o=s[i],c=t[o];t[o]=(function(u){var d=n.operation(r),h=Array.prototype.slice.call(arguments,1),f=h.pop();h.push(function(g){d.retry(g)||(g&&(arguments[0]=d.mainError()),f.apply(this,arguments))}),d.attempt(function(){u.apply(t,h)})}).bind(t,c),t[o].options=r}}})(ih);var Gm=ih;const Jm=Gm,Km=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class oh extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const Wm=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},Xm=n=>Km.includes(n),ch=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const s=Jm.operation(e);s.attempt(async a=>{try{t(await n(a))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof oh)s.stop(),r(i.originalError);else if(i instanceof TypeError&&!Xm(i.message))s.stop(),r(i);else{Wm(i,a,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}s.retry(i)||r(s.mainError())}}})});ka.exports=ch;ka.exports.default=ch;ka.exports.AbortError=oh;var Ym=ka.exports;const Qs=Ao(Ym);var lh={},uh={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function s(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function a(c,l,u,d,h){if(typeof u!="function")throw new TypeError("The listener must be a function");var f=new s(u,d||c,h),g=t?t+l:l;return c._events[g]?c._events[g].fn?c._events[g]=[c._events[g],f]:c._events[g].push(f):(c._events[g]=f,c._eventsCount++),c}function i(c,l){--c._eventsCount===0?c._events=new r:delete c._events[l]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],u,d;if(this._eventsCount===0)return l;for(d in u=this._events)e.call(u,d)&&l.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},o.prototype.listeners=function(l){var u=t?t+l:l,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,g=new Array(f);h<f;h++)g[h]=d[h].fn;return g},o.prototype.listenerCount=function(l){var u=t?t+l:l,d=this._events[u];return d?d.fn?1:d.length:0},o.prototype.emit=function(l,u,d,h,f,g){var p=t?t+l:l;if(!this._events[p])return!1;var m=this._events[p],_=arguments.length,y,w;if(m.fn){switch(m.once&&this.removeListener(l,m.fn,void 0,!0),_){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,u),!0;case 3:return m.fn.call(m.context,u,d),!0;case 4:return m.fn.call(m.context,u,d,h),!0;case 5:return m.fn.call(m.context,u,d,h,f),!0;case 6:return m.fn.call(m.context,u,d,h,f,g),!0}for(w=1,y=new Array(_-1);w<_;w++)y[w-1]=arguments[w];m.fn.apply(m.context,y)}else{var O=m.length,P;for(w=0;w<O;w++)switch(m[w].once&&this.removeListener(l,m[w].fn,void 0,!0),_){case 1:m[w].fn.call(m[w].context);break;case 2:m[w].fn.call(m[w].context,u);break;case 3:m[w].fn.call(m[w].context,u,d);break;case 4:m[w].fn.call(m[w].context,u,d,h);break;default:if(!y)for(P=1,y=new Array(_-1);P<_;P++)y[P-1]=arguments[P];m[w].fn.apply(m[w].context,y)}}return!0},o.prototype.on=function(l,u,d){return a(this,l,u,d,!1)},o.prototype.once=function(l,u,d){return a(this,l,u,d,!0)},o.prototype.removeListener=function(l,u,d,h){var f=t?t+l:l;if(!this._events[f])return this;if(!u)return i(this,f),this;var g=this._events[f];if(g.fn)g.fn===u&&(!h||g.once)&&(!d||g.context===d)&&i(this,f);else{for(var p=0,m=[],_=g.length;p<_;p++)(g[p].fn!==u||h&&!g[p].once||d&&g[p].context!==d)&&m.push(g[p]);m.length?this._events[f]=m.length===1?m[0]:m:i(this,f)}return this},o.prototype.removeAllListeners=function(l){var u;return l?(u=t?t+l:l,this._events[u]&&i(this,u)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(uh);var Qm=uh.exports,Ca={exports:{}},eg=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})));const tg=eg;class dh extends Error{constructor(e){super(e),this.name="TimeoutError"}}const hh=(n,e,t)=>new Promise((r,s)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}const a=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(c){s(c)}return}const i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new dh(i);typeof n.cancel=="function"&&n.cancel(),s(o)},e);tg(n.then(r,s),()=>{clearTimeout(a)})});Ca.exports=hh;Ca.exports.default=hh;Ca.exports.TimeoutError=dh;var rg=Ca.exports,uc={},dc={};Object.defineProperty(dc,"__esModule",{value:!0});function ng(n,e,t){let r=0,s=n.length;for(;s>0;){const a=s/2|0;let i=r+a;t(n[i],e)<=0?(r=++i,s-=a+1):s=a}return r}dc.default=ng;Object.defineProperty(uc,"__esModule",{value:!0});const sg=dc;class ag{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}const s=sg.default(this._queue,r,(a,i)=>i.priority-a.priority);this._queue.splice(s,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}uc.default=ag;Object.defineProperty(lh,"__esModule",{value:!0});const ig=Qm,fh=rg,og=uc,Is=()=>{},cg=new fh.TimeoutError;class lg extends ig{constructor(e){var t,r,s,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Is,this._resolveIdle=Is,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:og.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(a=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&a!==void 0?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Is,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Is,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,s)=>{const a=async()=>{this._pendingCount++,this._intervalCount++;try{const i=this._timeout===void 0&&t.timeout===void 0?e():fh.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&s(cg)});r(await i)}catch(i){s(i)}this._next()};this._queue.enqueue(a,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var $t=lh.default=lg;const ug=[400,401,402,403,404,405,406,407,409],dg=n=>{var t,r;if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;const e=((t=n==null?void 0:n.response)==null?void 0:t.status)??(n==null?void 0:n.status);if(e&&ug.includes(+e))throw n;if(((r=n==null?void 0:n.error)==null?void 0:r.code)==="insufficient_quota"){const s=new Error(n==null?void 0:n.message);throw s.name="InsufficientQuotaError",s}};let hc=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??dg;const t="default"in $t?$t.default:$t;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Qs(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,a)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var $a={};$a.byteLength=pg;$a.toByteArray=gg;$a.fromByteArray=bg;var At=[],Ye=[],hg=typeof Uint8Array<"u"?Uint8Array:Array,wi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Er=0,fg=wi.length;Er<fg;++Er)At[Er]=wi[Er],Ye[wi.charCodeAt(Er)]=Er;Ye[45]=62;Ye[95]=63;function ph(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function pg(n){var e=ph(n),t=e[0],r=e[1];return(t+r)*3/4-r}function mg(n,e,t){return(e+t)*3/4-t}function gg(n){var e,t=ph(n),r=t[0],s=t[1],a=new hg(mg(n,r,s)),i=0,o=s>0?r-4:r,c;for(c=0;c<o;c+=4)e=Ye[n.charCodeAt(c)]<<18|Ye[n.charCodeAt(c+1)]<<12|Ye[n.charCodeAt(c+2)]<<6|Ye[n.charCodeAt(c+3)],a[i++]=e>>16&255,a[i++]=e>>8&255,a[i++]=e&255;return s===2&&(e=Ye[n.charCodeAt(c)]<<2|Ye[n.charCodeAt(c+1)]>>4,a[i++]=e&255),s===1&&(e=Ye[n.charCodeAt(c)]<<10|Ye[n.charCodeAt(c+1)]<<4|Ye[n.charCodeAt(c+2)]>>2,a[i++]=e>>8&255,a[i++]=e&255),a}function yg(n){return At[n>>18&63]+At[n>>12&63]+At[n>>6&63]+At[n&63]}function _g(n,e,t){for(var r,s=[],a=e;a<t;a+=3)r=(n[a]<<16&16711680)+(n[a+1]<<8&65280)+(n[a+2]&255),s.push(yg(r));return s.join("")}function bg(n){for(var e,t=n.length,r=t%3,s=[],a=16383,i=0,o=t-r;i<o;i+=a)s.push(_g(n,i,i+a>o?o:i+a));return r===1?(e=n[t-1],s.push(At[e>>2]+At[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],s.push(At[e>>10]+At[e>>4&63]+At[e<<2&63]+"=")),s.join("")}var wg=Object.defineProperty,vg=(n,e,t)=>e in n?wg(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Eg=(n,e,t)=>(vg(n,e+"",t),t);function Ag(n,e){let t=Array.from({length:n.length},(r,s)=>({start:s,end:s+1}));for(;t.length>1;){let r=null;for(let s=0;s<t.length-1;s++){const a=n.slice(t[s].start,t[s+1].end),i=e.get(a.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,s])}if(r!=null){const s=r[1];t[s]={start:t[s].start,end:t[s+1].end},t.splice(s+1,1)}else break}return t}function Og(n,e){return n.length===1?[e.get(n.join(","))]:Ag(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function Sg(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var ao=class{constructor(n,e){Ut(this,"specialTokens");Ut(this,"inverseSpecialTokens");Ut(this,"patStr");Ut(this,"textEncoder",new TextEncoder);Ut(this,"textDecoder",new TextDecoder("utf-8"));Ut(this,"rankMap",new Map);Ut(this,"textMap",new Map);this.patStr=n.pat_str;const t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,s)=>{const[a,i,...o]=s.split(" "),c=Number.parseInt(i,10);return o.forEach((l,u)=>r[l]=c+u),r},{});for(const[r,s]of Object.entries(t)){const a=$a.toByteArray(r);this.rankMap.set(a.join(","),s),this.textMap.set(s,a)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[s,a])=>(r[a]=this.textEncoder.encode(s),r),{})}encode(n,e=[],t="all"){const r=new RegExp(this.patStr,"ug"),s=ao.specialTokenRegex(Object.keys(this.specialTokens)),a=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!i.has(l)):t);if(o.size>0){const l=ao.specialTokenRegex([...o]),u=n.match(l);if(u!=null)throw new Error(`The text contains a special token that is not allowed: ${u[0]}`)}let c=0;for(;;){let l=null,u=c;for(;s.lastIndex=u,l=s.exec(n),!(l==null||i.has(l[0]));)u=l.index+1;const d=(l==null?void 0:l.index)??n.length;for(const f of n.substring(c,d).matchAll(r)){const g=this.textEncoder.encode(f[0]),p=this.rankMap.get(g.join(","));if(p!=null){a.push(p);continue}a.push(...Og(g,this.rankMap))}if(l==null)break;let h=this.specialTokens[l[0]];a.push(h),c=l.index+l[0].length}return a}decode(n){const e=[];let t=0;for(let a=0;a<n.length;++a){const i=n[a],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),t+=o.length)}const r=new Uint8Array(t);let s=0;for(const a of e)r.set(a,s),s+=a.length;return this.textDecoder.decode(r)}},mh=ao;Eg(mh,"specialTokenRegex",n=>new RegExp(n.map(e=>Sg(e)).join("|"),"g"));function Pg(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"o3-mini":case"o3-mini-2025-01-31":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}const ks={},xg=new hc({});async function Rg(n){return n in ks||(ks[n]=xg.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new mh(e)).catch(e=>{throw delete ks[n],e})),await ks[n]}async function Tg(n){return Rg(Pg(n))}var Y;(function(n){n.assertEqual=s=>s;function e(s){}n.assertIs=e;function t(s){throw new Error}n.assertNever=t,n.arrayToEnum=s=>{const a={};for(const i of s)a[i]=i;return a},n.getValidEnumValues=s=>{const a=n.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),i={};for(const o of a)i[o]=s[o];return n.objectValues(i)},n.objectValues=s=>n.objectKeys(s).map(function(a){return s[a]}),n.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const a=[];for(const i in s)Object.prototype.hasOwnProperty.call(s,i)&&a.push(i);return a},n.find=(s,a)=>{for(const i of s)if(a(i))return i},n.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&isFinite(s)&&Math.floor(s)===s;function r(s,a=" | "){return s.map(i=>typeof i=="string"?`'${i}'`:i).join(a)}n.joinValues=r,n.jsonStringifyReplacer=(s,a)=>typeof a=="bigint"?a.toString():a})(Y||(Y={}));var ea;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(ea||(ea={}));const R=Y.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Et=n=>{switch(typeof n){case"undefined":return R.undefined;case"string":return R.string;case"number":return isNaN(n)?R.nan:R.number;case"boolean":return R.boolean;case"function":return R.function;case"bigint":return R.bigint;case"symbol":return R.symbol;case"object":return Array.isArray(n)?R.array:n===null?R.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?R.promise:typeof Map<"u"&&n instanceof Map?R.map:typeof Set<"u"&&n instanceof Set?R.set:typeof Date<"u"&&n instanceof Date?R.date:R.object;default:return R.unknown}},E=Y.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),gh=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:");class Fe extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(a){return a.message},r={_errors:[]},s=a=>{for(const i of a.issues)if(i.code==="invalid_union")i.unionErrors.map(s);else if(i.code==="invalid_return_type")s(i.returnTypeError);else if(i.code==="invalid_arguments")s(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,c=0;for(;c<i.path.length;){const l=i.path[c];c===i.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(t(i))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return s(this),r}static assert(e){if(!(e instanceof Fe))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Y.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):r.push(e(s));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}Fe.create=n=>new Fe(n);const fr=(n,e)=>{let t;switch(n.code){case E.invalid_type:n.received===R.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case E.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,Y.jsonStringifyReplacer)}`;break;case E.unrecognized_keys:t=`Unrecognized key(s) in object: ${Y.joinValues(n.keys,", ")}`;break;case E.invalid_union:t="Invalid input";break;case E.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${Y.joinValues(n.options)}`;break;case E.invalid_enum_value:t=`Invalid enum value. Expected ${Y.joinValues(n.options)}, received '${n.received}'`;break;case E.invalid_arguments:t="Invalid function arguments";break;case E.invalid_return_type:t="Invalid function return type";break;case E.invalid_date:t="Invalid date";break;case E.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:Y.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case E.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case E.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case E.custom:t="Invalid input";break;case E.invalid_intersection_types:t="Intersection results could not be merged";break;case E.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case E.not_finite:t="Number must be finite";break;default:t=e.defaultError,Y.assertNever(n)}return{message:t}};let yh=fr;function _h(n){yh=n}function Kn(){return yh}const Wn=n=>{const{data:e,path:t,errorMaps:r,issueData:s}=n,a=[...t,...s.path||[]],i={...s,path:a};if(s.message!==void 0)return{...s,path:a,message:s.message};let o="";const c=r.filter(l=>!!l).slice().reverse();for(const l of c)o=l(i,{data:e,defaultError:o}).message;return{...s,path:a,message:o}},bh=[];function x(n,e){const t=Kn(),r=Wn({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===fr?void 0:fr].filter(s=>!!s)});n.common.issues.push(r)}class Ae{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const s of t){if(s.status==="aborted")return B;s.status==="dirty"&&e.dirty(),r.push(s.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const s of t){const a=await s.key,i=await s.value;r.push({key:a,value:i})}return Ae.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const s of t){const{key:a,value:i}=s;if(a.status==="aborted"||i.status==="aborted")return B;a.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof i.value<"u"||s.alwaysSet)&&(r[a.value]=i.value)}return{status:e.value,value:r}}}const B=Object.freeze({status:"aborted"}),ir=n=>({status:"dirty",value:n}),Te=n=>({status:"valid",value:n}),ta=n=>n.status==="aborted",ra=n=>n.status==="dirty",Xt=n=>n.status==="valid",Ur=n=>typeof Promise<"u"&&n instanceof Promise;function na(n,e,t,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(n)}function wh(n,e,t,r,s){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t}var N;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(N||(N={}));var Fn,Bn;class St{constructor(e,t,r,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=s}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const cl=(n,e)=>{if(Xt(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new Fe(n.common.issues);return this._error=t,this._error}}};function H(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:r,description:s}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(i,o)=>{var c,l;const{message:u}=n;return i.code==="invalid_enum_value"?{message:u??o.defaultError}:typeof o.data>"u"?{message:(c=u??r)!==null&&c!==void 0?c:o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:(l=u??t)!==null&&l!==void 0?l:o.defaultError}},description:s}}class Z{get description(){return this._def.description}_getType(e){return Et(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Et(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Ae,ctx:{common:e.parent.common,data:e.data,parsedType:Et(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Ur(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;const s={common:{issues:[],async:(r=t==null?void 0:t.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Et(e)},a=this._parseSync({data:e,path:s.path,parent:s});return cl(s,a)}"~validate"(e){var t,r;const s={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Et(e)};if(!this["~standard"].async)try{const a=this._parseSync({data:e,path:[],parent:s});return Xt(a)?{value:a.value}:{issues:s.common.issues}}catch(a){!((r=(t=a==null?void 0:a.message)===null||t===void 0?void 0:t.toLowerCase())===null||r===void 0)&&r.includes("encountered")&&(this["~standard"].async=!0),s.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:s}).then(a=>Xt(a)?{value:a.value}:{issues:s.common.issues})}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Et(e)},s=this._parse({data:e,path:r.path,parent:r}),a=await(Ur(s)?s:Promise.resolve(s));return cl(r,a)}refine(e,t){const r=s=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(s):t;return this._refinement((s,a)=>{const i=e(s),o=()=>a.addIssue({code:E.custom,...r(s)});return typeof Promise<"u"&&i instanceof Promise?i.then(c=>c?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,s)=>e(r)?!0:(s.addIssue(typeof t=="function"?t(r,s):t),!1))}_refinement(e){return new We({schema:this,typeName:A.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return tt.create(this,this._def)}nullable(){return Dt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return et.create(this)}promise(){return mr.create(this,this._def)}or(e){return Zr.create([this,e],this._def)}and(e){return qr.create(this,e,this._def)}transform(e){return new We({...H(this._def),schema:this,typeName:A.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new Kr({...H(this._def),innerType:this,defaultValue:t,typeName:A.ZodDefault})}brand(){return new Na({typeName:A.ZodBranded,type:this,...H(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Wr({...H(this._def),innerType:this,catchValue:t,typeName:A.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return on.create(this,e)}readonly(){return Xr.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Ig=/^c[^\s-]{8,}$/i,kg=/^[0-9a-z]+$/,Cg=/^[0-9A-HJKMNP-TV-Z]{26}$/i,$g=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Ng=/^[a-z0-9_-]{21}$/i,jg=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Lg=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Dg=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Mg="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let vi;const Ug=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Fg=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Bg=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,zg=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Zg=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,qg=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,vh="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Vg=new RegExp(`^${vh}$`);function Eh(n){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`),e}function Hg(n){return new RegExp(`^${Eh(n)}$`)}function fc(n){let e=`${vh}T${Eh(n)}`;const t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Gg(n,e){return!!((e==="v4"||!e)&&Ug.test(n)||(e==="v6"||!e)&&Bg.test(n))}function Jg(n,e){if(!jg.test(n))return!1;try{const[t]=n.split("."),r=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),s=JSON.parse(atob(r));return!(typeof s!="object"||s===null||!s.typ||!s.alg||e&&s.alg!==e)}catch{return!1}}function Kg(n,e){return!!((e==="v4"||!e)&&Fg.test(n)||(e==="v6"||!e)&&zg.test(n))}class Qe extends Z{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==R.string){const a=this._getOrReturnCtx(e);return x(a,{code:E.invalid_type,expected:R.string,received:a.parsedType}),B}const r=new Ae;let s;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(s=this._getOrReturnCtx(e,s),x(s,{code:E.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="max")e.data.length>a.value&&(s=this._getOrReturnCtx(e,s),x(s,{code:E.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="length"){const i=e.data.length>a.value,o=e.data.length<a.value;(i||o)&&(s=this._getOrReturnCtx(e,s),i?x(s,{code:E.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&x(s,{code:E.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),r.dirty())}else if(a.kind==="email")Dg.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"email",code:E.invalid_string,message:a.message}),r.dirty());else if(a.kind==="emoji")vi||(vi=new RegExp(Mg,"u")),vi.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"emoji",code:E.invalid_string,message:a.message}),r.dirty());else if(a.kind==="uuid")$g.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"uuid",code:E.invalid_string,message:a.message}),r.dirty());else if(a.kind==="nanoid")Ng.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"nanoid",code:E.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid")Ig.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"cuid",code:E.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid2")kg.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"cuid2",code:E.invalid_string,message:a.message}),r.dirty());else if(a.kind==="ulid")Cg.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"ulid",code:E.invalid_string,message:a.message}),r.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),x(s,{validation:"url",code:E.invalid_string,message:a.message}),r.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"regex",code:E.invalid_string,message:a.message}),r.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(s=this._getOrReturnCtx(e,s),x(s,{code:E.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),r.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(s=this._getOrReturnCtx(e,s),x(s,{code:E.invalid_string,validation:{startsWith:a.value},message:a.message}),r.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(s=this._getOrReturnCtx(e,s),x(s,{code:E.invalid_string,validation:{endsWith:a.value},message:a.message}),r.dirty()):a.kind==="datetime"?fc(a).test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{code:E.invalid_string,validation:"datetime",message:a.message}),r.dirty()):a.kind==="date"?Vg.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{code:E.invalid_string,validation:"date",message:a.message}),r.dirty()):a.kind==="time"?Hg(a).test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{code:E.invalid_string,validation:"time",message:a.message}),r.dirty()):a.kind==="duration"?Lg.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"duration",code:E.invalid_string,message:a.message}),r.dirty()):a.kind==="ip"?Gg(e.data,a.version)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"ip",code:E.invalid_string,message:a.message}),r.dirty()):a.kind==="jwt"?Jg(e.data,a.alg)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"jwt",code:E.invalid_string,message:a.message}),r.dirty()):a.kind==="cidr"?Kg(e.data,a.version)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"cidr",code:E.invalid_string,message:a.message}),r.dirty()):a.kind==="base64"?Zg.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"base64",code:E.invalid_string,message:a.message}),r.dirty()):a.kind==="base64url"?qg.test(e.data)||(s=this._getOrReturnCtx(e,s),x(s,{validation:"base64url",code:E.invalid_string,message:a.message}),r.dirty()):Y.assertNever(a);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(s=>e.test(s),{validation:t,code:E.invalid_string,...N.errToObj(r)})}_addCheck(e){return new Qe({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...N.errToObj(e)})}url(e){return this._addCheck({kind:"url",...N.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...N.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...N.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...N.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...N.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...N.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...N.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...N.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...N.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...N.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...N.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...N.errToObj(e)})}datetime(e){var t,r;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,local:(r=e==null?void 0:e.local)!==null&&r!==void 0?r:!1,...N.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...N.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...N.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...N.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...N.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...N.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...N.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...N.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...N.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...N.errToObj(t)})}nonempty(e){return this.min(1,N.errToObj(e))}trim(){return new Qe({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Qe({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Qe({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Qe.create=n=>{var e;return new Qe({checks:[],typeName:A.ZodString,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...H(n)})};function Wg(n,e){const t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=t>r?t:r,a=parseInt(n.toFixed(s).replace(".","")),i=parseInt(e.toFixed(s).replace(".",""));return a%i/Math.pow(10,s)}class Nt extends Z{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==R.number){const a=this._getOrReturnCtx(e);return x(a,{code:E.invalid_type,expected:R.number,received:a.parsedType}),B}let r;const s=new Ae;for(const a of this._def.checks)a.kind==="int"?Y.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),x(r,{code:E.invalid_type,expected:"integer",received:"float",message:a.message}),s.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:E.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:E.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="multipleOf"?Wg(e.data,a.value)!==0&&(r=this._getOrReturnCtx(e,r),x(r,{code:E.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),x(r,{code:E.not_finite,message:a.message}),s.dirty()):Y.assertNever(a);return{status:s.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,N.toString(t))}gt(e,t){return this.setLimit("min",e,!1,N.toString(t))}lte(e,t){return this.setLimit("max",e,!0,N.toString(t))}lt(e,t){return this.setLimit("max",e,!1,N.toString(t))}setLimit(e,t,r,s){return new Nt({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:N.toString(s)}]})}_addCheck(e){return new Nt({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:N.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:N.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:N.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:N.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:N.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:N.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:N.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:N.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:N.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&Y.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Nt.create=n=>new Nt({checks:[],typeName:A.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...H(n)});class jt extends Z{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==R.bigint)return this._getInvalidInput(e);let r;const s=new Ae;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:E.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:E.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),x(r,{code:E.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):Y.assertNever(a);return{status:s.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return x(t,{code:E.invalid_type,expected:R.bigint,received:t.parsedType}),B}gte(e,t){return this.setLimit("min",e,!0,N.toString(t))}gt(e,t){return this.setLimit("min",e,!1,N.toString(t))}lte(e,t){return this.setLimit("max",e,!0,N.toString(t))}lt(e,t){return this.setLimit("max",e,!1,N.toString(t))}setLimit(e,t,r,s){return new jt({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:N.toString(s)}]})}_addCheck(e){return new jt({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:N.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:N.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:N.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:N.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:N.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}jt.create=n=>{var e;return new jt({checks:[],typeName:A.ZodBigInt,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...H(n)})};class Fr extends Z{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==R.boolean){const r=this._getOrReturnCtx(e);return x(r,{code:E.invalid_type,expected:R.boolean,received:r.parsedType}),B}return Te(e.data)}}Fr.create=n=>new Fr({typeName:A.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...H(n)});class Yt extends Z{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==R.date){const a=this._getOrReturnCtx(e);return x(a,{code:E.invalid_type,expected:R.date,received:a.parsedType}),B}if(isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return x(a,{code:E.invalid_date}),B}const r=new Ae;let s;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(s=this._getOrReturnCtx(e,s),x(s,{code:E.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),r.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(s=this._getOrReturnCtx(e,s),x(s,{code:E.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),r.dirty()):Y.assertNever(a);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Yt({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:N.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:N.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}Yt.create=n=>new Yt({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:A.ZodDate,...H(n)});class Xn extends Z{_parse(e){if(this._getType(e)!==R.symbol){const r=this._getOrReturnCtx(e);return x(r,{code:E.invalid_type,expected:R.symbol,received:r.parsedType}),B}return Te(e.data)}}Xn.create=n=>new Xn({typeName:A.ZodSymbol,...H(n)});class Br extends Z{_parse(e){if(this._getType(e)!==R.undefined){const r=this._getOrReturnCtx(e);return x(r,{code:E.invalid_type,expected:R.undefined,received:r.parsedType}),B}return Te(e.data)}}Br.create=n=>new Br({typeName:A.ZodUndefined,...H(n)});class zr extends Z{_parse(e){if(this._getType(e)!==R.null){const r=this._getOrReturnCtx(e);return x(r,{code:E.invalid_type,expected:R.null,received:r.parsedType}),B}return Te(e.data)}}zr.create=n=>new zr({typeName:A.ZodNull,...H(n)});class pr extends Z{constructor(){super(...arguments),this._any=!0}_parse(e){return Te(e.data)}}pr.create=n=>new pr({typeName:A.ZodAny,...H(n)});class Kt extends Z{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Te(e.data)}}Kt.create=n=>new Kt({typeName:A.ZodUnknown,...H(n)});class Pt extends Z{_parse(e){const t=this._getOrReturnCtx(e);return x(t,{code:E.invalid_type,expected:R.never,received:t.parsedType}),B}}Pt.create=n=>new Pt({typeName:A.ZodNever,...H(n)});class Yn extends Z{_parse(e){if(this._getType(e)!==R.undefined){const r=this._getOrReturnCtx(e);return x(r,{code:E.invalid_type,expected:R.void,received:r.parsedType}),B}return Te(e.data)}}Yn.create=n=>new Yn({typeName:A.ZodVoid,...H(n)});class et extends Z{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),s=this._def;if(t.parsedType!==R.array)return x(t,{code:E.invalid_type,expected:R.array,received:t.parsedType}),B;if(s.exactLength!==null){const i=t.data.length>s.exactLength.value,o=t.data.length<s.exactLength.value;(i||o)&&(x(t,{code:i?E.too_big:E.too_small,minimum:o?s.exactLength.value:void 0,maximum:i?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),r.dirty())}if(s.minLength!==null&&t.data.length<s.minLength.value&&(x(t,{code:E.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),r.dirty()),s.maxLength!==null&&t.data.length>s.maxLength.value&&(x(t,{code:E.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>s.type._parseAsync(new St(t,i,t.path,o)))).then(i=>Ae.mergeArray(r,i));const a=[...t.data].map((i,o)=>s.type._parseSync(new St(t,i,t.path,o)));return Ae.mergeArray(r,a)}get element(){return this._def.type}min(e,t){return new et({...this._def,minLength:{value:e,message:N.toString(t)}})}max(e,t){return new et({...this._def,maxLength:{value:e,message:N.toString(t)}})}length(e,t){return new et({...this._def,exactLength:{value:e,message:N.toString(t)}})}nonempty(e){return this.min(1,e)}}et.create=(n,e)=>new et({type:n,minLength:null,maxLength:null,exactLength:null,typeName:A.ZodArray,...H(e)});function Pr(n){if(n instanceof oe){const e={};for(const t in n.shape){const r=n.shape[t];e[t]=tt.create(Pr(r))}return new oe({...n._def,shape:()=>e})}else return n instanceof et?new et({...n._def,type:Pr(n.element)}):n instanceof tt?tt.create(Pr(n.unwrap())):n instanceof Dt?Dt.create(Pr(n.unwrap())):n instanceof ht?ht.create(n.items.map(e=>Pr(e))):n}class oe extends Z{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=Y.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==R.object){const l=this._getOrReturnCtx(e);return x(l,{code:E.invalid_type,expected:R.object,received:l.parsedType}),B}const{status:r,ctx:s}=this._processInputParams(e),{shape:a,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof Pt&&this._def.unknownKeys==="strip"))for(const l in s.data)i.includes(l)||o.push(l);const c=[];for(const l of i){const u=a[l],d=s.data[l];c.push({key:{status:"valid",value:l},value:u._parse(new St(s,d,s.path,l)),alwaysSet:l in s.data})}if(this._def.catchall instanceof Pt){const l=this._def.unknownKeys;if(l==="passthrough")for(const u of o)c.push({key:{status:"valid",value:u},value:{status:"valid",value:s.data[u]}});else if(l==="strict")o.length>0&&(x(s,{code:E.unrecognized_keys,keys:o}),r.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const l=this._def.catchall;for(const u of o){const d=s.data[u];c.push({key:{status:"valid",value:u},value:l._parse(new St(s,d,s.path,u)),alwaysSet:u in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const l=[];for(const u of c){const d=await u.key,h=await u.value;l.push({key:d,value:h,alwaysSet:u.alwaysSet})}return l}).then(l=>Ae.mergeObjectSync(r,l)):Ae.mergeObjectSync(r,c)}get shape(){return this._def.shape()}strict(e){return N.errToObj,new oe({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var s,a,i,o;const c=(i=(a=(s=this._def).errorMap)===null||a===void 0?void 0:a.call(s,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=N.errToObj(e).message)!==null&&o!==void 0?o:c}:{message:c}}}:{}})}strip(){return new oe({...this._def,unknownKeys:"strip"})}passthrough(){return new oe({...this._def,unknownKeys:"passthrough"})}extend(e){return new oe({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new oe({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:A.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new oe({...this._def,catchall:e})}pick(e){const t={};return Y.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new oe({...this._def,shape:()=>t})}omit(e){const t={};return Y.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new oe({...this._def,shape:()=>t})}deepPartial(){return Pr(this)}partial(e){const t={};return Y.objectKeys(this.shape).forEach(r=>{const s=this.shape[r];e&&!e[r]?t[r]=s:t[r]=s.optional()}),new oe({...this._def,shape:()=>t})}required(e){const t={};return Y.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let a=this.shape[r];for(;a instanceof tt;)a=a._def.innerType;t[r]=a}}),new oe({...this._def,shape:()=>t})}keyof(){return Ah(Y.objectKeys(this.shape))}}oe.create=(n,e)=>new oe({shape:()=>n,unknownKeys:"strip",catchall:Pt.create(),typeName:A.ZodObject,...H(e)});oe.strictCreate=(n,e)=>new oe({shape:()=>n,unknownKeys:"strict",catchall:Pt.create(),typeName:A.ZodObject,...H(e)});oe.lazycreate=(n,e)=>new oe({shape:n,unknownKeys:"strip",catchall:Pt.create(),typeName:A.ZodObject,...H(e)});class Zr extends Z{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;function s(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const i=a.map(o=>new Fe(o.ctx.common.issues));return x(t,{code:E.invalid_union,unionErrors:i}),B}if(t.common.async)return Promise.all(r.map(async a=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(s);{let a;const i=[];for(const c of r){const l={...t,common:{...t.common,issues:[]},parent:null},u=c._parseSync({data:t.data,path:t.path,parent:l});if(u.status==="valid")return u;u.status==="dirty"&&!a&&(a={result:u,ctx:l}),l.common.issues.length&&i.push(l.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;const o=i.map(c=>new Fe(c));return x(t,{code:E.invalid_union,unionErrors:o}),B}}get options(){return this._def.options}}Zr.create=(n,e)=>new Zr({options:n,typeName:A.ZodUnion,...H(e)});const kt=n=>n instanceof Hr?kt(n.schema):n instanceof We?kt(n.innerType()):n instanceof Gr?[n.value]:n instanceof Lt?n.options:n instanceof Jr?Y.objectValues(n.enum):n instanceof Kr?kt(n._def.innerType):n instanceof Br?[void 0]:n instanceof zr?[null]:n instanceof tt?[void 0,...kt(n.unwrap())]:n instanceof Dt?[null,...kt(n.unwrap())]:n instanceof Na||n instanceof Xr?kt(n.unwrap()):n instanceof Wr?kt(n._def.innerType):[];class hs extends Z{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.object)return x(t,{code:E.invalid_type,expected:R.object,received:t.parsedType}),B;const r=this.discriminator,s=t.data[r],a=this.optionsMap.get(s);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(x(t,{code:E.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),B)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){const s=new Map;for(const a of t){const i=kt(a.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of i){if(s.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);s.set(o,a)}}return new hs({typeName:A.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:s,...H(r)})}}function io(n,e){const t=Et(n),r=Et(e);if(n===e)return{valid:!0,data:n};if(t===R.object&&r===R.object){const s=Y.objectKeys(e),a=Y.objectKeys(n).filter(o=>s.indexOf(o)!==-1),i={...n,...e};for(const o of a){const c=io(n[o],e[o]);if(!c.valid)return{valid:!1};i[o]=c.data}return{valid:!0,data:i}}else if(t===R.array&&r===R.array){if(n.length!==e.length)return{valid:!1};const s=[];for(let a=0;a<n.length;a++){const i=n[a],o=e[a],c=io(i,o);if(!c.valid)return{valid:!1};s.push(c.data)}return{valid:!0,data:s}}else return t===R.date&&r===R.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class qr extends Z{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),s=(a,i)=>{if(ta(a)||ta(i))return B;const o=io(a.value,i.value);return o.valid?((ra(a)||ra(i))&&t.dirty(),{status:t.value,value:o.data}):(x(r,{code:E.invalid_intersection_types}),B)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([a,i])=>s(a,i)):s(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}qr.create=(n,e,t)=>new qr({left:n,right:e,typeName:A.ZodIntersection,...H(t)});class ht extends Z{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==R.array)return x(r,{code:E.invalid_type,expected:R.array,received:r.parsedType}),B;if(r.data.length<this._def.items.length)return x(r,{code:E.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),B;!this._def.rest&&r.data.length>this._def.items.length&&(x(r,{code:E.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const a=[...r.data].map((i,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new St(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(a).then(i=>Ae.mergeArray(t,i)):Ae.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new ht({...this._def,rest:e})}}ht.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ht({items:n,typeName:A.ZodTuple,rest:null,...H(e)})};class Vr extends Z{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==R.object)return x(r,{code:E.invalid_type,expected:R.object,received:r.parsedType}),B;const s=[],a=this._def.keyType,i=this._def.valueType;for(const o in r.data)s.push({key:a._parse(new St(r,o,r.path,o)),value:i._parse(new St(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?Ae.mergeObjectAsync(t,s):Ae.mergeObjectSync(t,s)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof Z?new Vr({keyType:e,valueType:t,typeName:A.ZodRecord,...H(r)}):new Vr({keyType:Qe.create(),valueType:e,typeName:A.ZodRecord,...H(t)})}}class Qn extends Z{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==R.map)return x(r,{code:E.invalid_type,expected:R.map,received:r.parsedType}),B;const s=this._def.keyType,a=this._def.valueType,i=[...r.data.entries()].map(([o,c],l)=>({key:s._parse(new St(r,o,r.path,[l,"key"])),value:a._parse(new St(r,c,r.path,[l,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of i){const l=await c.key,u=await c.value;if(l.status==="aborted"||u.status==="aborted")return B;(l.status==="dirty"||u.status==="dirty")&&t.dirty(),o.set(l.value,u.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const c of i){const l=c.key,u=c.value;if(l.status==="aborted"||u.status==="aborted")return B;(l.status==="dirty"||u.status==="dirty")&&t.dirty(),o.set(l.value,u.value)}return{status:t.value,value:o}}}}Qn.create=(n,e,t)=>new Qn({valueType:e,keyType:n,typeName:A.ZodMap,...H(t)});class Qt extends Z{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==R.set)return x(r,{code:E.invalid_type,expected:R.set,received:r.parsedType}),B;const s=this._def;s.minSize!==null&&r.data.size<s.minSize.value&&(x(r,{code:E.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),s.maxSize!==null&&r.data.size>s.maxSize.value&&(x(r,{code:E.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const a=this._def.valueType;function i(c){const l=new Set;for(const u of c){if(u.status==="aborted")return B;u.status==="dirty"&&t.dirty(),l.add(u.value)}return{status:t.value,value:l}}const o=[...r.data.values()].map((c,l)=>a._parse(new St(r,c,r.path,l)));return r.common.async?Promise.all(o).then(c=>i(c)):i(o)}min(e,t){return new Qt({...this._def,minSize:{value:e,message:N.toString(t)}})}max(e,t){return new Qt({...this._def,maxSize:{value:e,message:N.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Qt.create=(n,e)=>new Qt({valueType:n,minSize:null,maxSize:null,typeName:A.ZodSet,...H(e)});class lr extends Z{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.function)return x(t,{code:E.invalid_type,expected:R.function,received:t.parsedType}),B;function r(o,c){return Wn({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Kn(),fr].filter(l=>!!l),issueData:{code:E.invalid_arguments,argumentsError:c}})}function s(o,c){return Wn({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Kn(),fr].filter(l=>!!l),issueData:{code:E.invalid_return_type,returnTypeError:c}})}const a={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof mr){const o=this;return Te(async function(...c){const l=new Fe([]),u=await o._def.args.parseAsync(c,a).catch(f=>{throw l.addIssue(r(c,f)),l}),d=await Reflect.apply(i,this,u);return await o._def.returns._def.type.parseAsync(d,a).catch(f=>{throw l.addIssue(s(d,f)),l})})}else{const o=this;return Te(function(...c){const l=o._def.args.safeParse(c,a);if(!l.success)throw new Fe([r(c,l.error)]);const u=Reflect.apply(i,this,l.data),d=o._def.returns.safeParse(u,a);if(!d.success)throw new Fe([s(u,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new lr({...this._def,args:ht.create(e).rest(Kt.create())})}returns(e){return new lr({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new lr({args:e||ht.create([]).rest(Kt.create()),returns:t||Kt.create(),typeName:A.ZodFunction,...H(r)})}}class Hr extends Z{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Hr.create=(n,e)=>new Hr({getter:n,typeName:A.ZodLazy,...H(e)});class Gr extends Z{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return x(t,{received:t.data,code:E.invalid_literal,expected:this._def.value}),B}return{status:"valid",value:e.data}}get value(){return this._def.value}}Gr.create=(n,e)=>new Gr({value:n,typeName:A.ZodLiteral,...H(e)});function Ah(n,e){return new Lt({values:n,typeName:A.ZodEnum,...H(e)})}class Lt extends Z{constructor(){super(...arguments),Fn.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),r=this._def.values;return x(t,{expected:Y.joinValues(r),received:t.parsedType,code:E.invalid_type}),B}if(na(this,Fn)||wh(this,Fn,new Set(this._def.values)),!na(this,Fn).has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return x(t,{received:t.data,code:E.invalid_enum_value,options:r}),B}return Te(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Lt.create(e,{...this._def,...t})}exclude(e,t=this._def){return Lt.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}}Fn=new WeakMap;Lt.create=Ah;class Jr extends Z{constructor(){super(...arguments),Bn.set(this,void 0)}_parse(e){const t=Y.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==R.string&&r.parsedType!==R.number){const s=Y.objectValues(t);return x(r,{expected:Y.joinValues(s),received:r.parsedType,code:E.invalid_type}),B}if(na(this,Bn)||wh(this,Bn,new Set(Y.getValidEnumValues(this._def.values))),!na(this,Bn).has(e.data)){const s=Y.objectValues(t);return x(r,{received:r.data,code:E.invalid_enum_value,options:s}),B}return Te(e.data)}get enum(){return this._def.values}}Bn=new WeakMap;Jr.create=(n,e)=>new Jr({values:n,typeName:A.ZodNativeEnum,...H(e)});class mr extends Z{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.promise&&t.common.async===!1)return x(t,{code:E.invalid_type,expected:R.promise,received:t.parsedType}),B;const r=t.parsedType===R.promise?t.data:Promise.resolve(t.data);return Te(r.then(s=>this._def.type.parseAsync(s,{path:t.path,errorMap:t.common.contextualErrorMap})))}}mr.create=(n,e)=>new mr({type:n,typeName:A.ZodPromise,...H(e)});class We extends Z{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===A.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),s=this._def.effect||null,a={addIssue:i=>{x(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(a.addIssue=a.addIssue.bind(a),s.type==="preprocess"){const i=s.transform(r.data,a);if(r.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return B;const c=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return c.status==="aborted"?B:c.status==="dirty"||t.value==="dirty"?ir(c.value):c});{if(t.value==="aborted")return B;const o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?B:o.status==="dirty"||t.value==="dirty"?ir(o.value):o}}if(s.type==="refinement"){const i=o=>{const c=s.refinement(o,a);if(r.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?B:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?B:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(s.type==="transform")if(r.common.async===!1){const i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!Xt(i))return i;const o=s.transform(i.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>Xt(i)?Promise.resolve(s.transform(i.value,a)).then(o=>({status:t.value,value:o})):i);Y.assertNever(s)}}We.create=(n,e,t)=>new We({schema:n,typeName:A.ZodEffects,effect:e,...H(t)});We.createWithPreprocess=(n,e,t)=>new We({schema:e,effect:{type:"preprocess",transform:n},typeName:A.ZodEffects,...H(t)});class tt extends Z{_parse(e){return this._getType(e)===R.undefined?Te(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}tt.create=(n,e)=>new tt({innerType:n,typeName:A.ZodOptional,...H(e)});class Dt extends Z{_parse(e){return this._getType(e)===R.null?Te(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Dt.create=(n,e)=>new Dt({innerType:n,typeName:A.ZodNullable,...H(e)});class Kr extends Z{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===R.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Kr.create=(n,e)=>new Kr({innerType:n,typeName:A.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...H(e)});class Wr extends Z{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Ur(s)?s.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new Fe(r.common.issues)},input:r.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new Fe(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}Wr.create=(n,e)=>new Wr({innerType:n,typeName:A.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...H(e)});class es extends Z{_parse(e){if(this._getType(e)!==R.nan){const r=this._getOrReturnCtx(e);return x(r,{code:E.invalid_type,expected:R.nan,received:r.parsedType}),B}return{status:"valid",value:e.data}}}es.create=n=>new es({typeName:A.ZodNaN,...H(n)});const Oh=Symbol("zod_brand");class Na extends Z{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class on extends Z{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?B:a.status==="dirty"?(t.dirty(),ir(a.value)):this._def.out._parseAsync({data:a.value,path:r.path,parent:r})})();{const s=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?B:s.status==="dirty"?(t.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:r.path,parent:r})}}static create(e,t){return new on({in:e,out:t,typeName:A.ZodPipeline})}}class Xr extends Z{_parse(e){const t=this._def.innerType._parse(e),r=s=>(Xt(s)&&(s.value=Object.freeze(s.value)),s);return Ur(t)?t.then(s=>r(s)):r(t)}unwrap(){return this._def.innerType}}Xr.create=(n,e)=>new Xr({innerType:n,typeName:A.ZodReadonly,...H(e)});function ll(n,e){const t=typeof n=="function"?n(e):typeof n=="string"?{message:n}:n;return typeof t=="string"?{message:t}:t}function pc(n,e={},t){return n?pr.create().superRefine((r,s)=>{var a,i;const o=n(r);if(o instanceof Promise)return o.then(c=>{var l,u;if(!c){const d=ll(e,r),h=(u=(l=d.fatal)!==null&&l!==void 0?l:t)!==null&&u!==void 0?u:!0;s.addIssue({code:"custom",...d,fatal:h})}});if(!o){const c=ll(e,r),l=(i=(a=c.fatal)!==null&&a!==void 0?a:t)!==null&&i!==void 0?i:!0;s.addIssue({code:"custom",...c,fatal:l})}}):pr.create()}const Sh={object:oe.lazycreate};var A;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(A||(A={}));const Ph=(n,e={message:`Input not instance of ${n.name}`})=>pc(t=>t instanceof n,e),mc=Qe.create,gc=Nt.create,xh=es.create,Rh=jt.create,yc=Fr.create,Th=Yt.create,Ih=Xn.create,kh=Br.create,Ch=zr.create,$h=pr.create,Nh=Kt.create,jh=Pt.create,Lh=Yn.create,Dh=et.create,Mh=oe.create,Uh=oe.strictCreate,Fh=Zr.create,Bh=hs.create,zh=qr.create,Zh=ht.create,qh=Vr.create,Vh=Qn.create,Hh=Qt.create,Gh=lr.create,Jh=Hr.create,Kh=Gr.create,Wh=Lt.create,Xh=Jr.create,Yh=mr.create,sa=We.create,Qh=tt.create,ef=Dt.create,tf=We.createWithPreprocess,rf=on.create,nf=()=>mc().optional(),sf=()=>gc().optional(),af=()=>yc().optional(),of={string:n=>Qe.create({...n,coerce:!0}),number:n=>Nt.create({...n,coerce:!0}),boolean:n=>Fr.create({...n,coerce:!0}),bigint:n=>jt.create({...n,coerce:!0}),date:n=>Yt.create({...n,coerce:!0})},cf=B;var aa=Object.freeze({__proto__:null,defaultErrorMap:fr,setErrorMap:_h,getErrorMap:Kn,makeIssue:Wn,EMPTY_PATH:bh,addIssueToContext:x,ParseStatus:Ae,INVALID:B,DIRTY:ir,OK:Te,isAborted:ta,isDirty:ra,isValid:Xt,isAsync:Ur,get util(){return Y},get objectUtil(){return ea},ZodParsedType:R,getParsedType:Et,ZodType:Z,datetimeRegex:fc,ZodString:Qe,ZodNumber:Nt,ZodBigInt:jt,ZodBoolean:Fr,ZodDate:Yt,ZodSymbol:Xn,ZodUndefined:Br,ZodNull:zr,ZodAny:pr,ZodUnknown:Kt,ZodNever:Pt,ZodVoid:Yn,ZodArray:et,ZodObject:oe,ZodUnion:Zr,ZodDiscriminatedUnion:hs,ZodIntersection:qr,ZodTuple:ht,ZodRecord:Vr,ZodMap:Qn,ZodSet:Qt,ZodFunction:lr,ZodLazy:Hr,ZodLiteral:Gr,ZodEnum:Lt,ZodNativeEnum:Jr,ZodPromise:mr,ZodEffects:We,ZodTransformer:We,ZodOptional:tt,ZodNullable:Dt,ZodDefault:Kr,ZodCatch:Wr,ZodNaN:es,BRAND:Oh,ZodBranded:Na,ZodPipeline:on,ZodReadonly:Xr,custom:pc,Schema:Z,ZodSchema:Z,late:Sh,get ZodFirstPartyTypeKind(){return A},coerce:of,any:$h,array:Dh,bigint:Rh,boolean:yc,date:Th,discriminatedUnion:Bh,effect:sa,enum:Wh,function:Gh,instanceof:Ph,intersection:zh,lazy:Jh,literal:Kh,map:Vh,nan:xh,nativeEnum:Xh,never:jh,null:Ch,nullable:ef,number:gc,object:Mh,oboolean:af,onumber:sf,optional:Qh,ostring:nf,pipeline:rf,preprocess:tf,promise:Yh,record:qh,set:Hh,strictObject:Uh,string:mc,symbol:Ih,transformer:sa,tuple:Zh,undefined:kh,union:Fh,unknown:Nh,void:Lh,NEVER:cf,ZodIssueCode:E,quotelessJson:gh,ZodError:Fe});const Xg=Object.freeze(Object.defineProperty({__proto__:null,BRAND:Oh,DIRTY:ir,EMPTY_PATH:bh,INVALID:B,NEVER:cf,OK:Te,ParseStatus:Ae,Schema:Z,ZodAny:pr,ZodArray:et,ZodBigInt:jt,ZodBoolean:Fr,ZodBranded:Na,ZodCatch:Wr,ZodDate:Yt,ZodDefault:Kr,ZodDiscriminatedUnion:hs,ZodEffects:We,ZodEnum:Lt,ZodError:Fe,get ZodFirstPartyTypeKind(){return A},ZodFunction:lr,ZodIntersection:qr,ZodIssueCode:E,ZodLazy:Hr,ZodLiteral:Gr,ZodMap:Qn,ZodNaN:es,ZodNativeEnum:Jr,ZodNever:Pt,ZodNull:zr,ZodNullable:Dt,ZodNumber:Nt,ZodObject:oe,ZodOptional:tt,ZodParsedType:R,ZodPipeline:on,ZodPromise:mr,ZodReadonly:Xr,ZodRecord:Vr,ZodSchema:Z,ZodSet:Qt,ZodString:Qe,ZodSymbol:Xn,ZodTransformer:We,ZodTuple:ht,ZodType:Z,ZodUndefined:Br,ZodUnion:Zr,ZodUnknown:Kt,ZodVoid:Yn,addIssueToContext:x,any:$h,array:Dh,bigint:Rh,boolean:yc,coerce:of,custom:pc,date:Th,datetimeRegex:fc,default:aa,defaultErrorMap:fr,discriminatedUnion:Bh,effect:sa,enum:Wh,function:Gh,getErrorMap:Kn,getParsedType:Et,instanceof:Ph,intersection:zh,isAborted:ta,isAsync:Ur,isDirty:ra,isValid:Xt,late:Sh,lazy:Jh,literal:Kh,makeIssue:Wn,map:Vh,nan:xh,nativeEnum:Xh,never:jh,null:Ch,nullable:ef,number:gc,object:Mh,get objectUtil(){return ea},oboolean:af,onumber:sf,optional:Qh,ostring:nf,pipeline:rf,preprocess:tf,promise:Yh,quotelessJson:gh,record:qh,set:Hh,setErrorMap:_h,strictObject:Uh,string:mc,symbol:Ih,transformer:sa,tuple:Zh,undefined:kh,union:Fh,unknown:Nh,get util(){return Y},void:Lh,z:aa},Symbol.toStringTag,{value:"Module"}));let Cs;const Yg=new Uint8Array(16);function Qg(){if(!Cs&&(Cs=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Cs))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Cs(Yg)}const ey=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function ty(n){return typeof n=="string"&&ey.test(n)}const _e=[];for(let n=0;n<256;++n)_e.push((n+256).toString(16).slice(1));function ry(n,e=0){return _e[n[e+0]]+_e[n[e+1]]+_e[n[e+2]]+_e[n[e+3]]+"-"+_e[n[e+4]]+_e[n[e+5]]+"-"+_e[n[e+6]]+_e[n[e+7]]+"-"+_e[n[e+8]]+_e[n[e+9]]+"-"+_e[n[e+10]]+_e[n[e+11]]+_e[n[e+12]]+_e[n[e+13]]+_e[n[e+14]]+_e[n[e+15]]}const ny=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ul={randomUUID:ny};function Ht(n,e,t){if(ul.randomUUID&&!n)return ul.randomUUID();n=n||{};const r=n.random||(n.rng||Qg)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,ry(r)}class sy{}class fs extends sy{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Qd(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:Ge("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.awaitHandlers=e._awaitHandler??this.awaitHandlers)}copy(){return new this.constructor(this)}toJSON(){return hr.prototype.toJSON.call(this)}toJSONNotImplemented(){return hr.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends fs{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ht()}),Object.assign(this,e)}}return new t}}var _c={exports:{}};_c.exports;(function(n){const t=(a=0)=>i=>`\x1B[${38+a};5;${i}m`,r=(a=0)=>(i,o,c)=>`\x1B[${38+a};2;${i};${o};${c}m`;function s(){const a=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[o,c]of Object.entries(i)){for(const[l,u]of Object.entries(c))i[l]={open:`\x1B[${u[0]}m`,close:`\x1B[${u[1]}m`},c[l]=i[l],a.set(u[0],u[1]);Object.defineProperty(i,o,{value:c,enumerable:!1})}return Object.defineProperty(i,"codes",{value:a,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=t(),i.color.ansi16m=r(),i.bgColor.ansi256=t(10),i.bgColor.ansi16m=r(10),Object.defineProperties(i,{rgbToAnsi256:{value:(o,c,l)=>o===c&&c===l?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(l/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:l}=c.groups;l.length===3&&(l=l.split("").map(d=>d+d).join(""));const u=Number.parseInt(l,16);return[u>>16&255,u>>8&255,u&255]},enumerable:!1},hexToAnsi256:{value:o=>i.rgbToAnsi256(...i.hexToRgb(o)),enumerable:!1}}),i}Object.defineProperty(n,"exports",{enumerable:!0,get:s})})(_c);var ay=_c.exports;const lf=Ao(ay);function Ei(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function iy(n){return n.replace(/[-:.]/g,"")}function oy(n,e,t){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return iy(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}class ja extends fs{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){var s;const t=oy(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){const a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await((s=this.onRunCreate)==null?void 0:s.call(this,r))}async _endTrace(e){var r;const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,s,a,i,o,c){var f;const l=this._getExecutionOrder(s),u=Date.now(),d=o?{...a,metadata:o}:a,h={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:d??{},tags:i||[]};return await this._startTrace(h),await((f=this.onLLMStart)==null?void 0:f.call(this,h)),h}async handleChatModelStart(e,t,r,s,a,i,o,c){var f;const l=this._getExecutionOrder(s),u=Date.now(),d=o?{...a,metadata:o}:a,h={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:d??{},tags:i||[]};return await this._startTrace(h),await((f=this.onLLMStart)==null?void 0:f.call(this,h)),h}async handleLLMEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onLLMEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleLLMError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onLLMError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleChainStart(e,t,r,s,a,i,o,c){var h;const l=this._getExecutionOrder(s),u=Date.now(),d={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(d),await((h=this.onChainStart)==null?void 0:h.call(this,d)),d}async handleChainEnd(e,t,r,s,a){var o;const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Ei(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=Ei(a.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,r,s,a){var o;const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=Ei(a.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleToolStart(e,t,r,s,a,i,o){var d;const c=this._getExecutionOrder(s),l=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:c,child_execution_order:c,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(u),await((d=this.onToolStart)==null?void 0:d.call(this,u)),u}async handleToolEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentAction)==null?void 0:a.call(this,r))}async handleAgentEnd(e,t){var s;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}async handleRetrieverStart(e,t,r,s,a,i,o){var d;const c=this._getExecutionOrder(s),l=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:c,child_execution_order:c,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(u),await((d=this.onRetrieverStart)==null?void 0:d.call(this,u)),u}async handleRetrieverEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var s;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,t,r,s,a,i){var c;const o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((c=this.onLLMNewToken)==null?void 0:c.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}}function ke(n,e){return`${n.open}${e}${n.close}`}function st(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function Zt(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:De}=lf;class dl extends ja{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const s=this.runMap.get(r.parent_run_id);if(s)t.push(s),r=s;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((s,a,i)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return a===i.length-1?ke(lf.bold,o):o}).join(" > ");return ke(De.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${ke(De.green,"[chain/start]")} [${t}] Entering Chain run with input: ${st(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ke(De.cyan,"[chain/end]")} [${t}] [${Zt(e)}] Exiting Chain run with output: ${st(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${ke(De.red,"[chain/error]")} [${t}] [${Zt(e)}] Chain run errored with error: ${st(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${ke(De.green,"[llm/start]")} [${t}] Entering LLM run with input: ${st(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ke(De.cyan,"[llm/end]")} [${t}] [${Zt(e)}] Exiting LLM run with output: ${st(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${ke(De.red,"[llm/error]")} [${t}] [${Zt(e)}] LLM run errored with error: ${st(e.error,"[error]")}`)}onToolStart(e){var r;const t=this.getBreadcrumbs(e);console.log(`${ke(De.green,"[tool/start]")} [${t}] Entering Tool run with input: "${(r=e.inputs.input)==null?void 0:r.trim()}"`)}onToolEnd(e){var r,s;const t=this.getBreadcrumbs(e);console.log(`${ke(De.cyan,"[tool/end]")} [${t}] [${Zt(e)}] Exiting Tool run with output: "${(s=(r=e.outputs)==null?void 0:r.output)==null?void 0:s.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${ke(De.red,"[tool/error]")} [${t}] [${Zt(e)}] Tool run errored with error: ${st(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${ke(De.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${st(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ke(De.cyan,"[retriever/end]")} [${t}] [${Zt(e)}] Exiting Retriever run with output: ${st(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${ke(De.red,"[retriever/error]")} [${t}] [${Zt(e)}] Retriever run errored with error: ${st(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${ke(De.blue,"[agent/action]")} [${r}] Agent selected action: ${st(t.actions[t.actions.length-1],"[action]")}`)}}const cy=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function ly(n){return typeof n=="string"&&cy.test(n)}var be=[];for(var Ai=0;Ai<256;++Ai)be.push((Ai+256).toString(16).slice(1));function uy(n,e=0){return(be[n[e+0]]+be[n[e+1]]+be[n[e+2]]+be[n[e+3]]+"-"+be[n[e+4]]+be[n[e+5]]+"-"+be[n[e+6]]+be[n[e+7]]+"-"+be[n[e+8]]+be[n[e+9]]+"-"+be[n[e+10]]+be[n[e+11]]+be[n[e+12]]+be[n[e+13]]+be[n[e+14]]+be[n[e+15]]).toLowerCase()}var $s,dy=new Uint8Array(16);function hy(){if(!$s&&($s=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!$s))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return $s(dy)}var fy=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const hl={randomUUID:fy};function Oi(n,e,t){if(hl.randomUUID&&!n)return hl.randomUUID();n=n||{};var r=n.random||(n.rng||hy)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,uy(r)}const py=(...n)=>fetch(...n),my=Symbol.for("ls:fetch_implementation"),D=()=>globalThis[my]??py,gy=[400,401,403,404,405,406,407,408],yy=[409];class fl{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in $t?this.queue=new $t.default({concurrency:this.maxConcurrency}):this.queue=new $t({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add(()=>Qs(()=>e(...t).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;const a=s==null?void 0:s.response,i=a==null?void 0:a.status;if(i){if(gy.includes(+i))throw s;if(yy.includes(+i))return;r&&await r(a)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,a)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>D()(...e).then(t=>t.ok?t:Promise.reject(t)))}}function pl(n){return typeof(n==null?void 0:n._getType)=="function"}function ml(n){const e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var Vn={};let Tt;const _y=()=>typeof window<"u"&&typeof window.document<"u",by=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",wy=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),uf=()=>typeof Deno<"u",vy=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!uf(),Ey=()=>Tt||(_y()?Tt="browser":vy()?Tt="node":by()?Tt="webworker":wy()?Tt="jsdom":uf()?Tt="deno":Tt="other",Tt);let Si;function Ay(){if(Si===void 0){const n=Ey(),e=Py();Si={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:_f,...e}}return Si}function Oy(){const n=Sy()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,s]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof s=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[r]=s);return e}function Sy(){try{return typeof process<"u"&&Vn?Object.entries(Vn).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function oo(n){try{return typeof process<"u"?Vn==null?void 0:Vn[n]:void 0}catch{return}}function xr(n){return oo(`LANGSMITH_${n}`)||oo(`LANGCHAIN_${n}`)}let Pi;function Py(){if(Pi!==void 0)return Pi;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=oo(t);r!==void 0&&(e[t]=r)}return Pi=e,e}function X(n,e){if(!ly(n)){const t=e!==void 0?`Invalid UUID for ${e}: ${n}`:`Invalid UUID: ${n}`;throw new Error(t)}return n}const gl={};function xy(n){gl[n]||(console.warn(n),gl[n]=!0)}var co={exports:{}};const Ry="2.0.0",df=256,Ty=Number.MAX_SAFE_INTEGER||9007199254740991,Iy=16,ky=df-6,Cy=["major","premajor","minor","preminor","patch","prepatch","prerelease"];var La={MAX_LENGTH:df,MAX_SAFE_COMPONENT_LENGTH:Iy,MAX_SAFE_BUILD_LENGTH:ky,MAX_SAFE_INTEGER:Ty,RELEASE_TYPES:Cy,SEMVER_SPEC_VERSION:Ry,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},xi={};const $y=typeof process=="object"&&xi&&xi.NODE_DEBUG&&/\bsemver\b/i.test(xi.NODE_DEBUG)?(...n)=>console.error("SEMVER",...n):()=>{};var Da=$y;(function(n,e){const{MAX_SAFE_COMPONENT_LENGTH:t,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:s}=La,a=Da;e=n.exports={};const i=e.re=[],o=e.safeRe=[],c=e.src=[],l=e.safeSrc=[],u=e.t={};let d=0;const h="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",s],[h,r]],g=m=>{for(const[_,y]of f)m=m.split(`${_}*`).join(`${_}{0,${y}}`).split(`${_}+`).join(`${_}{1,${y}}`);return m},p=(m,_,y)=>{const w=g(_),O=d++;a(m,O,_),u[m]=O,c[O]=_,l[O]=w,i[O]=new RegExp(_,y?"g":void 0),o[O]=new RegExp(w,y?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),p("MAINVERSION",`(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${c[u.NUMERICIDENTIFIER]}|${c[u.NONNUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${c[u.NUMERICIDENTIFIERLOOSE]}|${c[u.NONNUMERICIDENTIFIER]})`),p("PRERELEASE",`(?:-(${c[u.PRERELEASEIDENTIFIER]}(?:\\.${c[u.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${c[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[u.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${h}+`),p("BUILD",`(?:\\+(${c[u.BUILDIDENTIFIER]}(?:\\.${c[u.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${c[u.MAINVERSION]}${c[u.PRERELEASE]}?${c[u.BUILD]}?`),p("FULL",`^${c[u.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${c[u.MAINVERSIONLOOSE]}${c[u.PRERELEASELOOSE]}?${c[u.BUILD]}?`),p("LOOSE",`^${c[u.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${c[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${c[u.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:${c[u.PRERELEASE]})?${c[u.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:${c[u.PRERELEASELOOSE]})?${c[u.BUILD]}?)?)?`),p("XRANGE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${t}})(?:\\.(\\d{1,${t}}))?(?:\\.(\\d{1,${t}}))?`),p("COERCE",`${c[u.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",c[u.COERCEPLAIN]+`(?:${c[u.PRERELEASE]})?(?:${c[u.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",c[u.COERCE],!0),p("COERCERTLFULL",c[u.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${c[u.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",p("TILDE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${c[u.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",p("CARET",`^${c[u.LONECARET]}${c[u.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${c[u.LONECARET]}${c[u.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${c[u.GTLT]}\\s*(${c[u.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]}|${c[u.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${c[u.XRANGEPLAIN]})\\s+-\\s+(${c[u.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${c[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[u.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(co,co.exports);var ps=co.exports;const Ny=Object.freeze({loose:!0}),jy=Object.freeze({}),Ly=n=>n?typeof n!="object"?Ny:n:jy;var bc=Ly;const yl=/^[0-9]+$/,hf=(n,e)=>{const t=yl.test(n),r=yl.test(e);return t&&r&&(n=+n,e=+e),n===e?0:t&&!r?-1:r&&!t?1:n<e?-1:1},Dy=(n,e)=>hf(e,n);var ff={compareIdentifiers:hf,rcompareIdentifiers:Dy};const Ns=Da,{MAX_LENGTH:_l,MAX_SAFE_INTEGER:js}=La,{safeRe:bl,safeSrc:wl,t:Ls}=ps,My=bc,{compareIdentifiers:Ar}=ff;let Uy=class bt{constructor(e,t){if(t=My(t),e instanceof bt){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>_l)throw new TypeError(`version is longer than ${_l} characters`);Ns("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const r=e.trim().match(t.loose?bl[Ls.LOOSE]:bl[Ls.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>js||this.major<0)throw new TypeError("Invalid major version");if(this.minor>js||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>js||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(s=>{if(/^[0-9]+$/.test(s)){const a=+s;if(a>=0&&a<js)return a}return s}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(Ns("SemVer.compare",this.version,this.options,e),!(e instanceof bt)){if(typeof e=="string"&&e===this.version)return 0;e=new bt(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof bt||(e=new bt(e,this.options)),Ar(this.major,e.major)||Ar(this.minor,e.minor)||Ar(this.patch,e.patch)}comparePre(e){if(e instanceof bt||(e=new bt(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const r=this.prerelease[t],s=e.prerelease[t];if(Ns("prerelease compare",t,r,s),r===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(r===void 0)return-1;if(r===s)continue;return Ar(r,s)}while(++t)}compareBuild(e){e instanceof bt||(e=new bt(e,this.options));let t=0;do{const r=this.build[t],s=e.build[t];if(Ns("build compare",t,r,s),r===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(r===void 0)return-1;if(r===s)continue;return Ar(r,s)}while(++t)}inc(e,t,r){if(e.startsWith("pre")){if(!t&&r===!1)throw new Error("invalid increment argument: identifier is empty");if(t){const s=new RegExp(`^${this.options.loose?wl[Ls.PRERELEASELOOSE]:wl[Ls.PRERELEASE]}$`),a=`-${t}`.match(s);if(!a||a[1]!==t)throw new Error(`invalid identifier: ${t}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const s=Number(r)?1:0;if(this.prerelease.length===0)this.prerelease=[s];else{let a=this.prerelease.length;for(;--a>=0;)typeof this.prerelease[a]=="number"&&(this.prerelease[a]++,a=-2);if(a===-1){if(t===this.prerelease.join(".")&&r===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(s)}}if(t){let a=[t,s];r===!1&&(a=[t]),Ar(this.prerelease[0],t)===0?isNaN(this.prerelease[1])&&(this.prerelease=a):this.prerelease=a}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};var je=Uy;const vl=je,Fy=(n,e,t=!1)=>{if(n instanceof vl)return n;try{return new vl(n,e)}catch(r){if(!t)return null;throw r}};var cn=Fy;const By=cn,zy=(n,e)=>{const t=By(n,e);return t?t.version:null};var Zy=zy;const qy=cn,Vy=(n,e)=>{const t=qy(n.trim().replace(/^[=v]+/,""),e);return t?t.version:null};var Hy=Vy;const El=je,Gy=(n,e,t,r,s)=>{typeof t=="string"&&(s=r,r=t,t=void 0);try{return new El(n instanceof El?n.version:n,t).inc(e,r,s).version}catch{return null}};var Jy=Gy;const Al=cn,Ky=(n,e)=>{const t=Al(n,null,!0),r=Al(e,null,!0),s=t.compare(r);if(s===0)return null;const a=s>0,i=a?t:r,o=a?r:t,c=!!i.prerelease.length;if(!!o.prerelease.length&&!c){if(!o.patch&&!o.minor)return"major";if(o.compareMain(i)===0)return o.minor&&!o.patch?"minor":"patch"}const u=c?"pre":"";return t.major!==r.major?u+"major":t.minor!==r.minor?u+"minor":t.patch!==r.patch?u+"patch":"prerelease"};var Wy=Ky;const Xy=je,Yy=(n,e)=>new Xy(n,e).major;var Qy=Yy;const e_=je,t_=(n,e)=>new e_(n,e).minor;var r_=t_;const n_=je,s_=(n,e)=>new n_(n,e).patch;var a_=s_;const i_=cn,o_=(n,e)=>{const t=i_(n,e);return t&&t.prerelease.length?t.prerelease:null};var c_=o_;const Ol=je,l_=(n,e,t)=>new Ol(n,t).compare(new Ol(e,t));var ft=l_;const u_=ft,d_=(n,e,t)=>u_(e,n,t);var h_=d_;const f_=ft,p_=(n,e)=>f_(n,e,!0);var m_=p_;const Sl=je,g_=(n,e,t)=>{const r=new Sl(n,t),s=new Sl(e,t);return r.compare(s)||r.compareBuild(s)};var wc=g_;const y_=wc,__=(n,e)=>n.sort((t,r)=>y_(t,r,e));var b_=__;const w_=wc,v_=(n,e)=>n.sort((t,r)=>w_(r,t,e));var E_=v_;const A_=ft,O_=(n,e,t)=>A_(n,e,t)>0;var Ma=O_;const S_=ft,P_=(n,e,t)=>S_(n,e,t)<0;var vc=P_;const x_=ft,R_=(n,e,t)=>x_(n,e,t)===0;var pf=R_;const T_=ft,I_=(n,e,t)=>T_(n,e,t)!==0;var mf=I_;const k_=ft,C_=(n,e,t)=>k_(n,e,t)>=0;var Ec=C_;const $_=ft,N_=(n,e,t)=>$_(n,e,t)<=0;var Ac=N_;const j_=pf,L_=mf,D_=Ma,M_=Ec,U_=vc,F_=Ac,B_=(n,e,t,r)=>{switch(e){case"===":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n===t;case"!==":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n!==t;case"":case"=":case"==":return j_(n,t,r);case"!=":return L_(n,t,r);case">":return D_(n,t,r);case">=":return M_(n,t,r);case"<":return U_(n,t,r);case"<=":return F_(n,t,r);default:throw new TypeError(`Invalid operator: ${e}`)}};var gf=B_;const z_=je,Z_=cn,{safeRe:Ds,t:Ms}=ps,q_=(n,e)=>{if(n instanceof z_)return n;if(typeof n=="number"&&(n=String(n)),typeof n!="string")return null;e=e||{};let t=null;if(!e.rtl)t=n.match(e.includePrerelease?Ds[Ms.COERCEFULL]:Ds[Ms.COERCE]);else{const c=e.includePrerelease?Ds[Ms.COERCERTLFULL]:Ds[Ms.COERCERTL];let l;for(;(l=c.exec(n))&&(!t||t.index+t[0].length!==n.length);)(!t||l.index+l[0].length!==t.index+t[0].length)&&(t=l),c.lastIndex=l.index+l[1].length+l[2].length;c.lastIndex=-1}if(t===null)return null;const r=t[2],s=t[3]||"0",a=t[4]||"0",i=e.includePrerelease&&t[5]?`-${t[5]}`:"",o=e.includePrerelease&&t[6]?`+${t[6]}`:"";return Z_(`${r}.${s}.${a}${i}${o}`,e)};var V_=q_;class H_{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);if(t!==void 0)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&t!==void 0){if(this.map.size>=this.max){const s=this.map.keys().next().value;this.delete(s)}this.map.set(e,t)}return this}}var G_=H_,Ri,Pl;function pt(){if(Pl)return Ri;Pl=1;const n=/\s+/g;class e{constructor(S,M){if(M=s(M),S instanceof e)return S.loose===!!M.loose&&S.includePrerelease===!!M.includePrerelease?S:new e(S.raw,M);if(S instanceof a)return this.raw=S.value,this.set=[[S]],this.formatted=void 0,this;if(this.options=M,this.loose=!!M.loose,this.includePrerelease=!!M.includePrerelease,this.raw=S.trim().replace(n," "),this.set=this.raw.split("||").map(L=>this.parseRange(L.trim())).filter(L=>L.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const L=this.set[0];if(this.set=this.set.filter(U=>!p(U[0])),this.set.length===0)this.set=[L];else if(this.set.length>1){for(const U of this.set)if(U.length===1&&m(U[0])){this.set=[U];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let S=0;S<this.set.length;S++){S>0&&(this.formatted+="||");const M=this.set[S];for(let L=0;L<M.length;L++)L>0&&(this.formatted+=" "),this.formatted+=M[L].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(S){const L=((this.options.includePrerelease&&f)|(this.options.loose&&g))+":"+S,U=r.get(L);if(U)return U;const v=this.options.loose,C=v?c[l.HYPHENRANGELOOSE]:c[l.HYPHENRANGE];S=S.replace(C,gt(this.options.includePrerelease)),i("hyphen replace",S),S=S.replace(c[l.COMPARATORTRIM],u),i("comparator trim",S),S=S.replace(c[l.TILDETRIM],d),i("tilde trim",S),S=S.replace(c[l.CARETTRIM],h),i("caret trim",S);let I=S.split(" ").map(he=>y(he,this.options)).join(" ").split(/\s+/).map(he=>ee(he,this.options));v&&(I=I.filter(he=>(i("loose invalid filter",he,this.options),!!he.match(c[l.COMPARATORLOOSE])))),i("range list",I);const q=new Map,ae=I.map(he=>new a(he,this.options));for(const he of ae){if(p(he))return[he];q.set(he.value,he)}q.size>1&&q.has("")&&q.delete("");const Ie=[...q.values()];return r.set(L,Ie),Ie}intersects(S,M){if(!(S instanceof e))throw new TypeError("a Range is required");return this.set.some(L=>_(L,M)&&S.set.some(U=>_(U,M)&&L.every(v=>U.every(C=>v.intersects(C,M)))))}test(S){if(!S)return!1;if(typeof S=="string")try{S=new o(S,this.options)}catch{return!1}for(let M=0;M<this.set.length;M++)if(tr(this.set[M],S,this.options))return!0;return!1}}Ri=e;const t=G_,r=new t,s=bc,a=Ua(),i=Da,o=je,{safeRe:c,t:l,comparatorTrimReplace:u,tildeTrimReplace:d,caretTrimReplace:h}=ps,{FLAG_INCLUDE_PRERELEASE:f,FLAG_LOOSE:g}=La,p=T=>T.value==="<0.0.0-0",m=T=>T.value==="",_=(T,S)=>{let M=!0;const L=T.slice();let U=L.pop();for(;M&&L.length;)M=L.every(v=>U.intersects(v,S)),U=L.pop();return M},y=(T,S)=>(i("comp",T,S),T=k(T,S),i("caret",T),T=O(T,S),i("tildes",T),T=Q(T,S),i("xrange",T),T=se(T,S),i("stars",T),T),w=T=>!T||T.toLowerCase()==="x"||T==="*",O=(T,S)=>T.trim().split(/\s+/).map(M=>P(M,S)).join(" "),P=(T,S)=>{const M=S.loose?c[l.TILDELOOSE]:c[l.TILDE];return T.replace(M,(L,U,v,C,I)=>{i("tilde",T,L,U,v,C,I);let q;return w(U)?q="":w(v)?q=`>=${U}.0.0 <${+U+1}.0.0-0`:w(C)?q=`>=${U}.${v}.0 <${U}.${+v+1}.0-0`:I?(i("replaceTilde pr",I),q=`>=${U}.${v}.${C}-${I} <${U}.${+v+1}.0-0`):q=`>=${U}.${v}.${C} <${U}.${+v+1}.0-0`,i("tilde return",q),q})},k=(T,S)=>T.trim().split(/\s+/).map(M=>$(M,S)).join(" "),$=(T,S)=>{i("caret",T,S);const M=S.loose?c[l.CARETLOOSE]:c[l.CARET],L=S.includePrerelease?"-0":"";return T.replace(M,(U,v,C,I,q)=>{i("caret",T,U,v,C,I,q);let ae;return w(v)?ae="":w(C)?ae=`>=${v}.0.0${L} <${+v+1}.0.0-0`:w(I)?v==="0"?ae=`>=${v}.${C}.0${L} <${v}.${+C+1}.0-0`:ae=`>=${v}.${C}.0${L} <${+v+1}.0.0-0`:q?(i("replaceCaret pr",q),v==="0"?C==="0"?ae=`>=${v}.${C}.${I}-${q} <${v}.${C}.${+I+1}-0`:ae=`>=${v}.${C}.${I}-${q} <${v}.${+C+1}.0-0`:ae=`>=${v}.${C}.${I}-${q} <${+v+1}.0.0-0`):(i("no pr"),v==="0"?C==="0"?ae=`>=${v}.${C}.${I}${L} <${v}.${C}.${+I+1}-0`:ae=`>=${v}.${C}.${I}${L} <${v}.${+C+1}.0-0`:ae=`>=${v}.${C}.${I} <${+v+1}.0.0-0`),i("caret return",ae),ae})},Q=(T,S)=>(i("replaceXRanges",T,S),T.split(/\s+/).map(M=>re(M,S)).join(" ")),re=(T,S)=>{T=T.trim();const M=S.loose?c[l.XRANGELOOSE]:c[l.XRANGE];return T.replace(M,(L,U,v,C,I,q)=>{i("xRange",T,L,U,v,C,I,q);const ae=w(v),Ie=ae||w(C),he=Ie||w(I),fn=he;return U==="="&&fn&&(U=""),q=S.includePrerelease?"-0":"",ae?U===">"||U==="<"?L="<0.0.0-0":L="*":U&&fn?(Ie&&(C=0),I=0,U===">"?(U=">=",Ie?(v=+v+1,C=0,I=0):(C=+C+1,I=0)):U==="<="&&(U="<",Ie?v=+v+1:C=+C+1),U==="<"&&(q="-0"),L=`${U+v}.${C}.${I}${q}`):Ie?L=`>=${v}.0.0${q} <${+v+1}.0.0-0`:he&&(L=`>=${v}.${C}.0${q} <${v}.${+C+1}.0-0`),i("xRange return",L),L})},se=(T,S)=>(i("replaceStars",T,S),T.trim().replace(c[l.STAR],"")),ee=(T,S)=>(i("replaceGTE0",T,S),T.trim().replace(c[S.includePrerelease?l.GTE0PRE:l.GTE0],"")),gt=T=>(S,M,L,U,v,C,I,q,ae,Ie,he,fn)=>(w(L)?M="":w(U)?M=`>=${L}.0.0${T?"-0":""}`:w(v)?M=`>=${L}.${U}.0${T?"-0":""}`:C?M=`>=${M}`:M=`>=${M}${T?"-0":""}`,w(ae)?q="":w(Ie)?q=`<${+ae+1}.0.0-0`:w(he)?q=`<${ae}.${+Ie+1}.0-0`:fn?q=`<=${ae}.${Ie}.${he}-${fn}`:T?q=`<${ae}.${Ie}.${+he+1}-0`:q=`<=${q}`,`${M} ${q}`.trim()),tr=(T,S,M)=>{for(let L=0;L<T.length;L++)if(!T[L].test(S))return!1;if(S.prerelease.length&&!M.includePrerelease){for(let L=0;L<T.length;L++)if(i(T[L].semver),T[L].semver!==a.ANY&&T[L].semver.prerelease.length>0){const U=T[L].semver;if(U.major===S.major&&U.minor===S.minor&&U.patch===S.patch)return!0}return!1}return!0};return Ri}var Ti,xl;function Ua(){if(xl)return Ti;xl=1;const n=Symbol("SemVer ANY");class e{static get ANY(){return n}constructor(u,d){if(d=t(d),u instanceof e){if(u.loose===!!d.loose)return u;u=u.value}u=u.trim().split(/\s+/).join(" "),i("comparator",u,d),this.options=d,this.loose=!!d.loose,this.parse(u),this.semver===n?this.value="":this.value=this.operator+this.semver.version,i("comp",this)}parse(u){const d=this.options.loose?r[s.COMPARATORLOOSE]:r[s.COMPARATOR],h=u.match(d);if(!h)throw new TypeError(`Invalid comparator: ${u}`);this.operator=h[1]!==void 0?h[1]:"",this.operator==="="&&(this.operator=""),h[2]?this.semver=new o(h[2],this.options.loose):this.semver=n}toString(){return this.value}test(u){if(i("Comparator.test",u,this.options.loose),this.semver===n||u===n)return!0;if(typeof u=="string")try{u=new o(u,this.options)}catch{return!1}return a(u,this.operator,this.semver,this.options)}intersects(u,d){if(!(u instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(u.value,d).test(this.value):u.operator===""?u.value===""?!0:new c(this.value,d).test(u.semver):(d=t(d),d.includePrerelease&&(this.value==="<0.0.0-0"||u.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||u.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&u.operator.startsWith(">")||this.operator.startsWith("<")&&u.operator.startsWith("<")||this.semver.version===u.semver.version&&this.operator.includes("=")&&u.operator.includes("=")||a(this.semver,"<",u.semver,d)&&this.operator.startsWith(">")&&u.operator.startsWith("<")||a(this.semver,">",u.semver,d)&&this.operator.startsWith("<")&&u.operator.startsWith(">")))}}Ti=e;const t=bc,{safeRe:r,t:s}=ps,a=gf,i=Da,o=je,c=pt();return Ti}const J_=pt(),K_=(n,e,t)=>{try{e=new J_(e,t)}catch{return!1}return e.test(n)};var Fa=K_;const W_=pt(),X_=(n,e)=>new W_(n,e).set.map(t=>t.map(r=>r.value).join(" ").trim().split(" "));var Y_=X_;const Q_=je,eb=pt(),tb=(n,e,t)=>{let r=null,s=null,a=null;try{a=new eb(e,t)}catch{return null}return n.forEach(i=>{a.test(i)&&(!r||s.compare(i)===-1)&&(r=i,s=new Q_(r,t))}),r};var rb=tb;const nb=je,sb=pt(),ab=(n,e,t)=>{let r=null,s=null,a=null;try{a=new sb(e,t)}catch{return null}return n.forEach(i=>{a.test(i)&&(!r||s.compare(i)===1)&&(r=i,s=new nb(r,t))}),r};var ib=ab;const Ii=je,ob=pt(),Rl=Ma,cb=(n,e)=>{n=new ob(n,e);let t=new Ii("0.0.0");if(n.test(t)||(t=new Ii("0.0.0-0"),n.test(t)))return t;t=null;for(let r=0;r<n.set.length;++r){const s=n.set[r];let a=null;s.forEach(i=>{const o=new Ii(i.semver.version);switch(i.operator){case">":o.prerelease.length===0?o.patch++:o.prerelease.push(0),o.raw=o.format();case"":case">=":(!a||Rl(o,a))&&(a=o);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${i.operator}`)}}),a&&(!t||Rl(t,a))&&(t=a)}return t&&n.test(t)?t:null};var lb=cb;const ub=pt(),db=(n,e)=>{try{return new ub(n,e).range||"*"}catch{return null}};var hb=db;const fb=je,yf=Ua(),{ANY:pb}=yf,mb=pt(),gb=Fa,Tl=Ma,Il=vc,yb=Ac,_b=Ec,bb=(n,e,t,r)=>{n=new fb(n,r),e=new mb(e,r);let s,a,i,o,c;switch(t){case">":s=Tl,a=yb,i=Il,o=">",c=">=";break;case"<":s=Il,a=_b,i=Tl,o="<",c="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(gb(n,e,r))return!1;for(let l=0;l<e.set.length;++l){const u=e.set[l];let d=null,h=null;if(u.forEach(f=>{f.semver===pb&&(f=new yf(">=0.0.0")),d=d||f,h=h||f,s(f.semver,d.semver,r)?d=f:i(f.semver,h.semver,r)&&(h=f)}),d.operator===o||d.operator===c||(!h.operator||h.operator===o)&&a(n,h.semver))return!1;if(h.operator===c&&i(n,h.semver))return!1}return!0};var Oc=bb;const wb=Oc,vb=(n,e,t)=>wb(n,e,">",t);var Eb=vb;const Ab=Oc,Ob=(n,e,t)=>Ab(n,e,"<",t);var Sb=Ob;const kl=pt(),Pb=(n,e,t)=>(n=new kl(n,t),e=new kl(e,t),n.intersects(e,t));var xb=Pb;const Rb=Fa,Tb=ft;var Ib=(n,e,t)=>{const r=[];let s=null,a=null;const i=n.sort((u,d)=>Tb(u,d,t));for(const u of i)Rb(u,e,t)?(a=u,s||(s=u)):(a&&r.push([s,a]),a=null,s=null);s&&r.push([s,null]);const o=[];for(const[u,d]of r)u===d?o.push(u):!d&&u===i[0]?o.push("*"):d?u===i[0]?o.push(`<=${d}`):o.push(`${u} - ${d}`):o.push(`>=${u}`);const c=o.join(" || "),l=typeof e.raw=="string"?e.raw:String(e);return c.length<l.length?c:e};const Cl=pt(),Sc=Ua(),{ANY:ki}=Sc,pn=Fa,Pc=ft,kb=(n,e,t={})=>{if(n===e)return!0;n=new Cl(n,t),e=new Cl(e,t);let r=!1;e:for(const s of n.set){for(const a of e.set){const i=$b(s,a,t);if(r=r||i!==null,i)continue e}if(r)return!1}return!0},Cb=[new Sc(">=0.0.0-0")],$l=[new Sc(">=0.0.0")],$b=(n,e,t)=>{if(n===e)return!0;if(n.length===1&&n[0].semver===ki){if(e.length===1&&e[0].semver===ki)return!0;t.includePrerelease?n=Cb:n=$l}if(e.length===1&&e[0].semver===ki){if(t.includePrerelease)return!0;e=$l}const r=new Set;let s,a;for(const f of n)f.operator===">"||f.operator===">="?s=Nl(s,f,t):f.operator==="<"||f.operator==="<="?a=jl(a,f,t):r.add(f.semver);if(r.size>1)return null;let i;if(s&&a){if(i=Pc(s.semver,a.semver,t),i>0)return null;if(i===0&&(s.operator!==">="||a.operator!=="<="))return null}for(const f of r){if(s&&!pn(f,String(s),t)||a&&!pn(f,String(a),t))return null;for(const g of e)if(!pn(f,String(g),t))return!1;return!0}let o,c,l,u,d=a&&!t.includePrerelease&&a.semver.prerelease.length?a.semver:!1,h=s&&!t.includePrerelease&&s.semver.prerelease.length?s.semver:!1;d&&d.prerelease.length===1&&a.operator==="<"&&d.prerelease[0]===0&&(d=!1);for(const f of e){if(u=u||f.operator===">"||f.operator===">=",l=l||f.operator==="<"||f.operator==="<=",s){if(h&&f.semver.prerelease&&f.semver.prerelease.length&&f.semver.major===h.major&&f.semver.minor===h.minor&&f.semver.patch===h.patch&&(h=!1),f.operator===">"||f.operator===">="){if(o=Nl(s,f,t),o===f&&o!==s)return!1}else if(s.operator===">="&&!pn(s.semver,String(f),t))return!1}if(a){if(d&&f.semver.prerelease&&f.semver.prerelease.length&&f.semver.major===d.major&&f.semver.minor===d.minor&&f.semver.patch===d.patch&&(d=!1),f.operator==="<"||f.operator==="<="){if(c=jl(a,f,t),c===f&&c!==a)return!1}else if(a.operator==="<="&&!pn(a.semver,String(f),t))return!1}if(!f.operator&&(a||s)&&i!==0)return!1}return!(s&&l&&!a&&i!==0||a&&u&&!s&&i!==0||h||d)},Nl=(n,e,t)=>{if(!n)return e;const r=Pc(n.semver,e.semver,t);return r>0?n:r<0||e.operator===">"&&n.operator===">="?e:n},jl=(n,e,t)=>{if(!n)return e;const r=Pc(n.semver,e.semver,t);return r<0?n:r>0||e.operator==="<"&&n.operator==="<="?e:n};var Nb=kb;const Ci=ps,Ll=La,jb=je,Dl=ff,Lb=cn,Db=Zy,Mb=Hy,Ub=Jy,Fb=Wy,Bb=Qy,zb=r_,Zb=a_,qb=c_,Vb=ft,Hb=h_,Gb=m_,Jb=wc,Kb=b_,Wb=E_,Xb=Ma,Yb=vc,Qb=pf,ew=mf,tw=Ec,rw=Ac,nw=gf,sw=V_,aw=Ua(),iw=pt(),ow=Fa,cw=Y_,lw=rb,uw=ib,dw=lb,hw=hb,fw=Oc,pw=Eb,mw=Sb,gw=xb,yw=Ib,_w=Nb;var Ml={parse:Lb,valid:Db,clean:Mb,inc:Ub,diff:Fb,major:Bb,minor:zb,patch:Zb,prerelease:qb,compare:Vb,rcompare:Hb,compareLoose:Gb,compareBuild:Jb,sort:Kb,rsort:Wb,gt:Xb,lt:Yb,eq:Qb,neq:ew,gte:tw,lte:rw,cmp:nw,coerce:sw,Comparator:aw,Range:iw,satisfies:ow,toComparators:cw,maxSatisfying:lw,minSatisfying:uw,minVersion:dw,validRange:hw,outside:fw,gtr:pw,ltr:mw,intersects:gw,simplifyRange:yw,subset:_w,SemVer:jb,re:Ci.re,src:Ci.src,tokens:Ci.t,SEMVER_SPEC_VERSION:Ll.SEMVER_SPEC_VERSION,RELEASE_TYPES:Ll.RELEASE_TYPES,compareIdentifiers:Dl.compareIdentifiers,rcompareIdentifiers:Dl.rcompareIdentifiers};function bw(n,e){const t=Ml.parse(n),r=Ml.parse(e);if(!t||!r)throw new Error("Invalid version format.");return t.compare(r)>=0}function qt(n){if(!n||n.split("/").length>2||n.startsWith("/")||n.endsWith("/")||n.split(":").length>2)throw new Error(`Invalid identifier format: ${n}`);const[e,t]=n.split(":"),r=t||"latest";if(e.includes("/")){const[s,a]=e.split("/",2);if(!s||!a)throw new Error(`Invalid identifier format: ${n}`);return[s,a,r]}else{if(!e)throw new Error(`Invalid identifier format: ${n}`);return["-",e,r]}}class ww extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function W(n,e,t){let r;if(n.ok){t&&(r=await n.text());return}r=await n.text();const s=`Failed to ${e}. Received status [${n.status}]: ${n.statusText}. Server response: ${r}`;throw n.status===409?new ww(s):new Error(s)}var Ul="[...]",vw={result:"[Circular]"},ia=[],Ir=[];function Ew(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function Rr(n,e,t,r){var i;try{return JSON.stringify(n,e,t)}catch(o){if(!((i=o.message)!=null&&i.includes("Converting circular structure to JSON")))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),typeof r>"u"&&(r=Ew()),lo(n,"",0,[],void 0,0,r);var s;try{Ir.length===0?s=JSON.stringify(n,e,t):s=JSON.stringify(n,Aw(e),t)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;ia.length!==0;){var a=ia.pop();a.length===4?Object.defineProperty(a[0],a[1],a[3]):a[0][a[1]]=a[2]}}return s}}function $i(n,e,t,r){var s=Object.getOwnPropertyDescriptor(r,t);s.get!==void 0?s.configurable?(Object.defineProperty(r,t,{value:n}),ia.push([r,t,e,s])):Ir.push([e,t,n]):(r[t]=n,ia.push([r,t,e]))}function lo(n,e,t,r,s,a,i){a+=1;var o;if(typeof n=="object"&&n!==null){for(o=0;o<r.length;o++)if(r[o]===n){$i(vw,n,e,s);return}if(typeof i.depthLimit<"u"&&a>i.depthLimit){$i(Ul,n,e,s);return}if(typeof i.edgesLimit<"u"&&t+1>i.edgesLimit){$i(Ul,n,e,s);return}if(r.push(n),Array.isArray(n))for(o=0;o<n.length;o++)lo(n[o],o,o,r,n,a,i);else{var c=Object.keys(n);for(o=0;o<c.length;o++){var l=c[o];lo(n[l],l,o,r,n,a,i)}}r.pop()}}function Aw(n){return n=typeof n<"u"?n:function(e,t){return t},function(e,t){if(Ir.length>0)for(var r=0;r<Ir.length;r++){var s=Ir[r];if(s[1]===e&&s[0]===t){t=s[2],Ir.splice(r,1);break}}return n.call(this,e,t)}}function Fl(n){const e=Ay(),t=Oy(),r=n.extra??{},s=r.metadata;return n.extra={...r,runtime:{...e,...r==null?void 0:r.runtime},metadata:{...t,...t.revision_id||n.revision_id?{revision_id:n.revision_id??t.revision_id}:{},...s}},n}const Ow=()=>{const n=xr("TRACING_SAMPLING_RATE");if(n===void 0)return;const e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},Sw=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function Pw(n){const e=[];for await(const t of n)e.push(t);return e}function Ni(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const xw=async n=>{if((n==null?void 0:n.status)===429){const e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};class Rw{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const r=new Promise(a=>{t=a}),s=Rr(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:r,size:s}),this.sizeBytes+=s,r}pop(e){var s;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let r=0;for(;r+(((s=this.peek())==null?void 0:s.size)??0)<e&&this.items.length>0;){const a=this.items.shift();a&&(t.push(a),r+=a.size,this.sizeBytes-=a.size)}if(t.length===0&&this.items.length>0){const a=this.items.shift();t.push(a),r+=a.size,this.sizeBytes-=a.size}return[t.map(a=>({action:a.action,item:a.payload})),()=>t.forEach(a=>a.itemPromiseResolve())]}}const Tw=20971520,Iw=1e3;class oa{constructor(e={}){var r;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Rw}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=oa.getDefaultClientConfig();this.tracingSampleRate=Ow(),this.apiUrl=Ni(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Ni(e.apiKey??t.apiKey),this.webUrl=Ni(e.webUrl??t.webUrl),(r=this.webUrl)!=null&&r.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??12e3,this.caller=new fl(e.callerOptions??{}),this.batchIngestCaller=new fl({...e.callerOptions??{},onFailedResponseHook:xw}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=xr("API_KEY"),t=xr("ENDPOINT")??"https://api.smith.langchain.com",r=xr("HIDE_INPUTS")==="true",s=xr("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:Sw(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${_f}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=(t==null?void 0:t.toString())??"",s=`${this.apiUrl}${e}?${r}`,a=await this.caller.call(D(),s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(a,`Failed to fetch ${e}`),a}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let s=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(s)),t.set("limit",String(a));const i=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(D(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(o,`Failed to fetch ${e}`);const c=r?r(await o.json()):await o.json();if(c.length===0||(yield c,c.length<a))break;s+=c.length}}async*_getCursorPaginatedList(e,t=null,r="POST",s="runs"){const a=t?{...t}:{};for(;;){const o=await(await this.caller.call(D(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)})).json();if(!o||!o[s])break;yield o[s];const c=o.cursors;if(!c||!c.next)break;a.cursor=c.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const r=[];for(const s of e)this.filteredPostUuids.has(s.id)?this.filteredPostUuids.delete(s.id):r.push(s);return r}else{const r=[];for(const s of e)s.id!==s.trace_id&&!this.filteredPostUuids.has(s.trace_id)||Math.random()<this.tracingSampleRate?r.push(s):this.filteredPostUuids.add(s.id);return r}}async _getBatchSizeLimitBytes(){var t;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((t=e.batch_ingest_config)==null?void 0:t.size_limit_bytes)??Tw}async drainAutoBatchQueue(){var e;for(;this.autoBatchQueue.items.length>=0;){const[t,r]=this.autoBatchQueue.pop(await this._getBatchSizeLimitBytes());if(!t.length){r();return}try{const s={runCreates:t.filter(i=>i.action==="create").map(i=>i.item),runUpdates:t.filter(i=>i.action==="update").map(i=>i.item)},a=await this._ensureServerInfo();(e=a==null?void 0:a.batch_ingest_config)!=null&&e.use_multipart_endpoint?await this.multipartIngestRuns(s):await this.batchIngestRuns(s)}finally{r()}}}async processRunOperation(e,t){const r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.action==="create"&&(e.item=Fl(e.item));const s=this.autoBatchQueue.push(e),a=await this._getBatchSizeLimitBytes();return(t||this.autoBatchQueue.sizeBytes>a)&&await this.drainAutoBatchQueue().catch(console.error),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),s}async _getServerInfo(){const e=await D()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(Iw),...this.fetchOptions});return await W(e,"get server info"),e.json()}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch{console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to single calls and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const s=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){this.processRunOperation({action:"create",item:s}).catch(console.error);return}const a=Fl(s),i=await this.caller.call(D(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:Rr(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r=(e==null?void 0:e.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[],s=(t==null?void 0:t.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[];if(r.length>0&&s.length>0){const c=r.reduce((u,d)=>(d.id&&(u[d.id]=d),u),{}),l=[];for(const u of s)u.id!==void 0&&c[u.id]?c[u.id]={...c[u.id],...u}:l.push(u);r=Object.values(c),s=l}const a={post:this._filterForSampling(r),patch:this._filterForSampling(s,!0)};if(!a.post.length&&!a.patch.length)return;if((await this._ensureServerInfo()).version===void 0){this.autoBatchTracing=!1;for(const c of a.post)await this.createRun(c);for(const c of a.patch)c.id!==void 0&&await this.updateRun(c.id,c);return}const o={post:[],patch:[]};for(const c of["post","patch"]){const l=c,u=a[l].reverse();let d=u.pop();for(;d!==void 0;)o[l].push(d),d=u.pop()}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(Rr(o))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(D(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;const r={};let s=[];for(const u of e??[]){const d=this.prepareRunCreateOrUpdateInputs(u);d.id!==void 0&&d.attachments!==void 0&&(r[d.id]=d.attachments),delete d.attachments,s.push(d)}let a=[];for(const u of t??[])a.push(this.prepareRunCreateOrUpdateInputs(u));if(s.find(u=>u.trace_id===void 0||u.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(a.find(u=>u.trace_id===void 0||u.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(s.length>0&&a.length>0){const u=s.reduce((h,f)=>(f.id&&(h[f.id]=f),h),{}),d=[];for(const h of a)h.id!==void 0&&u[h.id]?u[h.id]={...u[h.id],...h}:d.push(h);s=Object.values(u),a=d}if(s.length===0&&a.length===0)return;const c=[],l=[];for(const[u,d]of[["post",s],["patch",a]])for(const h of d){const{inputs:f,outputs:g,events:p,...m}=h,_={inputs:f,outputs:g,events:p},y=Rr(m);l.push({name:`${u}.${m.id}`,payload:new Blob([y],{type:`application/json; length=${y.length}`})});for(const[w,O]of Object.entries(_)){if(O===void 0)continue;const P=Rr(O);l.push({name:`${u}.${m.id}.${w}`,payload:new Blob([P],{type:`application/json; length=${P.length}`})})}if(m.id!==void 0){const w=r[m.id];if(w){delete r[m.id];for(const[O,[P,k]]of Object.entries(w))l.push({name:`attachment.${m.id}.${O}`,payload:new Blob([k],{type:`${P}; length=${k.length}`})})}}c.push(`trace=${m.trace_id},id=${m.id}`)}await this._sendMultipartRequest(l,c.join("; "))}async _sendMultipartRequest(e,t){try{const r=new FormData;for(const s of e)r.append(s.name,s.payload);await this.batchIngestCaller.call(D(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers},body:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})}catch(r){let s="Failed to multipart ingest runs";r instanceof Error?s+=`: ${r.stack||r.message}`:s+=`: ${String(r)}`,console.warn(`${s.trim()}

Context: ${t}`)}}async updateRun(e,t){X(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0&&this.blockOnRootRunFinalization){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}const s={...this.headers,"Content-Type":"application/json"},a=await this.caller.call(D(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:s,body:Rr(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(a,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){X(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let s;t.session_id?s=t.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:xr("PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${s}/r/${t.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await Pw(this.listRuns({id:e.child_run_ids})),r={},s={};t.sort((a,i)=>((a==null?void 0:a.dotted_order)??"").localeCompare((i==null?void 0:i.dotted_order)??""));for(const a of t){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);a.parent_run_id in r||(r[a.parent_run_id]=[]),r[a.parent_run_id].push(a),s[a.id]=a}e.child_runs=r[e.id]||[];for(const a in r)a!==e.id&&(s[a].child_runs=r[a]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:s,traceId:a,referenceExampleId:i,startTime:o,executionOrder:c,isRoot:l,runType:u,error:d,id:h,query:f,filter:g,traceFilter:p,treeFilter:m,limit:_,select:y}=e;let w=[];if(t&&(w=Array.isArray(t)?t:[t]),r){const $=Array.isArray(r)?r:[r],Q=await Promise.all($.map(re=>this.readProject({projectName:re}).then(se=>se.id)));w.push(...Q)}const O=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],P={session:w.length?w:null,run_type:u,reference_example:i,query:f,filter:g,trace_filter:p,tree_filter:m,execution_order:c,parent_run:s,start_time:o?o.toISOString():null,error:d,id:h,limit:_,trace:a,select:y||O,is_root:l};let k=0;for await(const $ of this._getCursorPaginatedList("/runs/query",P))if(_){if(k>=_)break;if($.length+k>_){yield*$.slice(0,_-k);break}k+=$.length,yield*$}else yield*$}async getRunStats({id:e,trace:t,parentRun:r,runType:s,projectNames:a,projectIds:i,referenceExampleIds:o,startTime:c,endTime:l,error:u,query:d,filter:h,traceFilter:f,treeFilter:g,isRoot:p,dataSourceType:m}){let _=i||[];a&&(_=[...i||[],...await Promise.all(a.map(k=>this.readProject({projectName:k}).then($=>$.id)))]);const w=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:s,session:_,reference_example:o,start_time:c,end_time:l,error:u,query:d,filter:h,trace_filter:f,tree_filter:g,is_root:p,data_source_type:m}).filter(([k,$])=>$!==void 0));return await(await this.caller.call(D(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(w),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||Oi()};X(e);const a=await(await this.caller.call(D(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){X(e);const t=await this.caller.call(D(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(t,"unshare run",!0)}async readRunSharedLink(e){X(e);const r=await(await this.caller.call(D(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const i of t)r.append("id",i);return X(e),await(await this.caller.call(D(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),X(e);const s=await(await this.caller.call(D(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};X(e);const a=await(await this.caller.call(D(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){X(e);const t=await this.caller.call(D(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(t,"unshare dataset",!0)}async readSharedDataset(e){return X(e),await(await this.caller.call(D(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async listSharedExamples(e,t){const r={};t!=null&&t.exampleIds&&(r.id=t.exampleIds);const s=new URLSearchParams;Object.entries(r).forEach(([o,c])=>{Array.isArray(c)?c.forEach(l=>s.append(o,l)):s.append(o,c)});const a=await this.caller.call(D(),`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await a.json();if(!a.ok)throw"detail"in i?new Error(`Failed to list shared examples.
Status: ${a.status}
Message: ${i.detail.join(`
`)}`):new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`);return i.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:s=!1,projectExtra:a=null,referenceDatasetId:i=null}){const o=s?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,l=a||{};r&&(l.metadata=r);const u={name:e,extra:l,description:t};i!==null&&(u.reference_dataset_id=i);const d=await this.caller.call(D(),c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(d,"create project"),await d.json()}async updateProject(e,{name:t=null,description:r=null,metadata:s=null,projectExtra:a=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=a;s&&(c={...c||{},metadata:s});const l={name:t,extra:c,description:r,end_time:i?new Date(i).toISOString():null},u=await this.caller.call(D(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(u,"update project"),await u.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)X(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");const a=await this.caller.call(D(),`${this.apiUrl}${r}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const i=await a.json();return a.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let s="/sessions";const a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)X(e),s+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&a.append("include_stats",r.toString());const i=await this._get(s,a);let o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:s,referenceDatasetName:a,referenceFree:i,metadata:o}={}){const c=new URLSearchParams;if(e!==void 0)for(const l of e)c.append("id",l);if(t!==void 0&&c.append("name",t),r!==void 0&&c.append("name_contains",r),s!==void 0)c.append("reference_dataset",s);else if(a!==void 0){const l=await this.readDataset({datasetName:a});c.append("reference_dataset",l.id)}i!==void 0&&c.append("reference_free",i.toString()),o!==void 0&&c.append("metadata",JSON.stringify(o));for await(const l of this._getPaginated("/sessions",c))yield*l}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,X(r);const s=await this.caller.call(D(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(s,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:s,description:a,dataType:i,name:o}){const c=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach(h=>{l.append("input_keys",h)}),s.forEach(h=>{l.append("output_keys",h)}),a&&l.append("description",a),i&&l.append("data_type",i),o&&l.append("name",o);const u=await this.caller.call(D(),c,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(u,"upload CSV"),await u.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:s,outputsSchema:a,metadata:i}={}){const o={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),s&&(o.inputs_schema_definition=s),a&&(o.outputs_schema_definition=a);const c=await this.caller.call(D(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(c,"create dataset"),await c.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const s=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)X(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide datasetName or datasetId");const a=await this._get(r,s);let i;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=a[0]}else i=a;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:s}){let a=e;if(a===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:s,datasetNameContains:a,metadata:i}={}){const o="/datasets",c=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const l of r)c.append("id",l);s!==void 0&&c.append("name",s),a!==void 0&&c.append("name_contains",a),i!==void 0&&c.append("metadata",JSON.stringify(i));for await(const l of this._getPaginated(o,c))yield*l}async updateDataset(e){const{datasetId:t,datasetName:r,...s}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const a=t??(await this.readDataset({datasetName:r})).id;X(a);const i=await this.caller.call(D(),`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(i,"update dataset"),await i.json()}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",s=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(s=(await this.readDataset({datasetName:t})).id),s!==void 0)X(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");const a=await this.caller.call(D(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(a,`delete ${r}`),await a.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let s=e;if(!s&&!t)throw new Error("Must provide either datasetName or datasetId");if(s&&t)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:t})).id),X(s);const a={tag:r},i=await this.caller.call(D(),`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(i,"index dataset"),await i.json()}async similarExamples(e,t,r,{filter:s}={}){const a={limit:r,inputs:e};s!==void 0&&(a.filter=s),X(t);const i=await this.caller.call(D(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(i,"fetch similar examples"),(await i.json()).examples}async createExample(e,t,{datasetId:r,datasetName:s,createdAt:a,exampleId:i,metadata:o,split:c,sourceRunId:l}){let u=r;if(u===void 0&&s===void 0)throw new Error("Must provide either datasetName or datasetId");if(u!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");u===void 0&&(u=(await this.readDataset({datasetName:s})).id);const d=a||new Date,h={dataset_id:u,inputs:e,outputs:t,created_at:d==null?void 0:d.toISOString(),id:i,metadata:o,split:c,source_run_id:l},f=await this.caller.call(D(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(h),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(f,"create example"),await f.json()}async createExamples(e){const{inputs:t,outputs:r,metadata:s,sourceRunIds:a,exampleIds:i,datasetId:o,datasetName:c}=e;let l=o;if(l===void 0&&c===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&c!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:c})).id);const u=t.map((f,g)=>({dataset_id:l,inputs:f,outputs:r?r[g]:void 0,metadata:s?s[g]:void 0,split:e.splits?e.splits[g]:void 0,id:i?i[g]:void 0,source_run_id:a?a[g]:void 0})),d=await this.caller.call(D(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(d,"create examples"),await d.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const s=e.map(i=>pl(i)?ml(i):i),a=pl(t)?ml(t):t;return this.createExample({input:s},{output:a},r)}async readExample(e){X(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:s,splits:a,inlineS3Urls:i,metadata:o,limit:c,offset:l,filter:u}={}){let d;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)d=e;else if(t!==void 0)d=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const h=new URLSearchParams({dataset:d}),f=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;f&&h.append("as_of",f);const g=i??!0;if(h.append("inline_s3_urls",g.toString()),r!==void 0)for(const m of r)h.append("id",m);if(a!==void 0)for(const m of a)h.append("splits",m);if(o!==void 0){const m=JSON.stringify(o);h.append("metadata",m)}c!==void 0&&h.append("limit",c.toString()),l!==void 0&&h.append("offset",l.toString()),u!==void 0&&h.append("filter",u);let p=0;for await(const m of this._getPaginated("/examples",h)){for(const _ of m)yield _,p++;if(c!==void 0&&p>=c)break}}async deleteExample(e){X(e);const t=`/examples/${e}`,r=await this.caller.call(D(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(r,`delete ${t}`),await r.json()}async updateExample(e,t){X(e);const r=await this.caller.call(D(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(r,"update example"),await r.json()}async updateExamples(e){const t=await this.caller.call(D(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(t,"update examples"),await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let s;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:t})).id:s=e,X(s);const a=new URLSearchParams,i=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return i&&a.append("as_of",i),await this._get(`/datasets/${s}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:s,remove:a=!1}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,X(i);const o={split_name:r,examples:s.map(l=>(X(l),l)),remove:a},c=await this.caller.call(D(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(c,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:s,referenceExample:a}={loadChildRuns:!1}){xy("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(a=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,a),[c,l]=await this._logEvaluationFeedback(o,i,r);return l[0]}async createFeedback(e,t,{score:r,value:s,correction:a,comment:i,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:l,feedbackId:u,feedbackConfig:d,projectId:h,comparativeExperimentId:f}){var y;if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const g={type:c??"api",metadata:o??{}};l!==void 0&&(g==null?void 0:g.metadata)!==void 0&&!g.metadata.__run&&(g.metadata.__run={run_id:l}),(g==null?void 0:g.metadata)!==void 0&&((y=g.metadata.__run)==null?void 0:y.run_id)!==void 0&&X(g.metadata.__run.run_id);const p={id:u??Oi(),run_id:e,key:t,score:r,value:s,correction:a,comment:i,feedback_source:g,comparative_experiment_id:f,feedbackConfig:d,session_id:h},m=`${this.apiUrl}/feedback`,_=await this.caller.call(D(),m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(_,"create feedback",!0),p}async updateFeedback(e,{score:t,value:r,correction:s,comment:a}){const i={};t!=null&&(i.score=t),r!=null&&(i.value=r),s!=null&&(i.correction=s),a!=null&&(i.comment=a),X(e);const o=await this.caller.call(D(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(o,"update feedback",!0)}async readFeedback(e){X(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){X(e);const t=`/feedback/${e}`,r=await this.caller.call(D(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(r,`delete ${t}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const s=new URLSearchParams;if(e&&s.append("run",e.join(",")),t)for(const a of t)s.append("key",a);if(r)for(const a of r)s.append("source",a);for await(const a of this._getPaginated("/feedback",s))yield*a}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:s}={}){const a={run_id:e,feedback_key:t,feedback_config:s};return r?typeof r=="string"?a.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(a.expires_in=r):a.expires_in={hours:3},await(await this.caller.call(D(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:s,description:a,metadata:i,id:o}){var u;if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const c={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:a,created_at:(u=s??new Date)==null?void 0:u.toISOString(),extra:{}};return i&&(c.extra.metadata=i),await(await this.caller.call(D(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){X(e);const t=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:t=[e],t}async _logEvaluationFeedback(e,t,r){const s=this._selectEvalResults(e),a=[];for(const i of s){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let c=null;i.targetRunId?c=i.targetRunId:t&&(c=t.id),a.push(await this.createFeedback(c,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[s,a]}async logEvaluationFeedback(e,t,r){const[s]=await this._logEvaluationFeedback(e,t,r);return s}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:s,limit:a}=e,i=new URLSearchParams;t&&t.forEach((c,l)=>{X(c,`queueIds[${l}]`),i.append("ids",c)}),r&&i.append("name",r),s&&i.append("name_contains",s),i.append("limit",(a!==void 0?Math.min(a,100):100).toString());let o=0;for await(const c of this._getPaginated("/annotation-queues",i))if(yield*c,o++,a!==void 0&&o>=a)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:s}=e,a={name:t,description:r,id:s||Oi()},i=await this.caller.call(D(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(a).filter(([c,l])=>l!==void 0))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(i,"create annotation queue"),await i.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:r,description:s}=t,a=await this.caller.call(D(),`${this.apiUrl}/annotation-queues/${X(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:s}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(a,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call(D(),`${this.apiUrl}/annotation-queues/${X(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const r=await this.caller.call(D(),`${this.apiUrl}/annotation-queues/${X(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map((s,a)=>X(s,`runIds[${a}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${X(e,"queueId")}/run`,s=await this.caller.call(D(),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(s,"get run from annotation queue"),await s.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(D(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){const s=typeof r.detail=="string"?r.detail:JSON.stringify(r.detail),a=new Error(`Error ${t.status}: ${t.statusText}
${s}`);throw a.statusCode=t.status,a}if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,s,a]=qt(e),i=await this.caller.call(D(),`${this.apiUrl}/likes/${r}/${s}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(i,`${t?"like":"unlike"} prompt`),await i.json()}async _getPromptUrl(e){const[t,r,s]=qt(e);if(await this._currentTenantIsOwner(t)){const a=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${r}/${s.substring(0,8)}?organizationId=${a.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${a.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${t}/${r}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&t.append("is_public",e.isPublic.toString()),e!=null&&e.query&&t.append("query",e.query);for await(const r of this._getPaginated("/repos",t,s=>s.repos))yield*r}async getPrompt(e){const[t,r,s]=qt(e),a=await this.caller.call(D(),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(a.status===404)return null;await W(a,"get prompt");const i=await a.json();return i.repo?i.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t!=null&&t.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,a,i]=qt(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const o={repo_handle:a,...(t==null?void 0:t.description)&&{description:t.description},...(t==null?void 0:t.readme)&&{readme:t.readme},...(t==null?void 0:t.tags)&&{tags:t.tags},is_public:!!(t!=null&&t.isPublic)},c=await this.caller.call(D(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(c,"create prompt");const{repo:l}=await c.json();return l}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,a,i]=qt(e),o=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${s}/${a}`):r==null?void 0:r.parentCommitHash,c={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},l=await this.caller.call(D(),`${this.apiUrl}/commits/${s}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(l,"create commit");const u=await l.json();return this._getPromptUrl(`${s}/${a}${u.commit_hash?`:${u.commit_hash}`:""}`)}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s]=qt(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const a={};if((t==null?void 0:t.description)!==void 0&&(a.description=t.description),(t==null?void 0:t.readme)!==void 0&&(a.readme=t.readme),(t==null?void 0:t.tags)!==void 0&&(a.tags=t.tags),(t==null?void 0:t.isPublic)!==void 0&&(a.is_public=t.isPublic),(t==null?void 0:t.isArchived)!==void 0&&(a.is_archived=t.isArchived),Object.keys(a).length===0)throw new Error("No valid update options provided");const i=await this.caller.call(D(),`${this.apiUrl}/repos/${r}/${s}`,{method:"PATCH",body:JSON.stringify(a),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await W(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,s]=qt(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return await(await this.caller.call(D(),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async pullPromptCommit(e,t){const[r,s,a]=qt(e),i=await this._getServerInfo(),o=bw(i.version,"0.5.23");let c=a;if(!o&&a==="latest"){const d=await this._getLatestCommitHash(`${r}/${s}`);if(d)c=d;else throw new Error("No commits found")}const l=await this.caller.call(D(),`${this.apiUrl}/commits/${r}/${s}/${c}${t!=null&&t.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await W(l,"pull prompt commit");const u=await l.json();return{owner:r,repo:s,commit_hash:u.commit_hash,manifest:u.manifest,examples:u.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t==null?void 0:t.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(s=>s!=="object")&&await this.updatePrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}):await this.createPrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}),t!=null&&t.object?await this.createCommit(e,t==null?void 0:t.object,{parentCommitHash:t==null?void 0:t.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:s}=t,[a,i]=this.parseTokenOrUrl(e,r),o=new oa({apiUrl:a,apiKey:"placeholder"}),c=await o.readSharedDataset(i),l=s||c.name;try{if(await this.hasDataset({datasetId:l})){console.log(`Dataset ${l} already exists in your tenant. Skipping.`);return}}catch{}const u=await o.listSharedExamples(i),d=await this.createDataset(l,{description:c.description,dataType:c.data_type||"kv",inputsSchema:c.inputs_schema_definition??void 0,outputsSchema:c.outputs_schema_definition??void 0});try{await this.createExamples({inputs:u.map(h=>h.inputs),outputs:u.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),h}}parseTokenOrUrl(e,t,r=2,s="dataset"){try{return X(e),[t,e]}catch{}try{const i=new URL(e).pathname.split("/").filter(o=>o!=="");if(i.length>=r){const o=i[i.length-r];return[t,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}awaitPendingTraceBatches(){return Promise.all(this.autoBatchQueue.items.map(({itemPromise:e})=>e))}}const _f="0.1.68";class kw extends ja{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:s}=e;this.projectName=r??Ge("LANGCHAIN_PROJECT")??Ge("LANGCHAIN_SESSION"),this.exampleId=t,this.client=s??new oa({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Um()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}}async function Cw(){return new kw}let ji;function $w(){const n="default"in $t?$t.default:$t;return new n({autoStart:!0,concurrency:1})}async function ve(n,e){e===!0?await n():(typeof ji>"u"&&(ji=$w()),ji.add(n))}class Nw{setHandler(e){return this.setHandlers([e])}}class Ba{constructor(e,t,r,s,a,i,o,c){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:c})}async handleText(e){await Promise.all(this.handlers.map(t=>ve(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleText: ${s}`)}},t.awaitHandlers)))}}class jw extends Ba{getChild(e){const t=new Be(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>ve(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch{console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>ve(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${s}`)}},t.awaitHandlers)))}}class Bl extends Ba{async handleLLMNewToken(e,t,r,s,a,i){await Promise.all(this.handlers.map(o=>ve(async()=>{var c;if(!o.ignoreLLM)try{await((c=o.handleLLMNewToken)==null?void 0:c.call(o,e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(l){console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${l}`)}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>ve(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${s}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>ve(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${s}`)}},t.awaitHandlers)))}}class Lw extends Ba{getChild(e){const t=new Be(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,s,a){await Promise.all(this.handlers.map(i=>ve(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(c){console.error(`Error in handler ${i.constructor.name}, handleChainError: ${c}`)}},i.awaitHandlers)))}async handleChainEnd(e,t,r,s,a){await Promise.all(this.handlers.map(i=>ve(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(c){console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${c}`)}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>ve(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${s}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>ve(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${s}`)}},t.awaitHandlers)))}}class Dw extends Ba{getChild(e){const t=new Be(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>ve(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${s}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>ve(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${s}`)}},t.awaitHandlers)))}}class Be extends Nw{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(t==null?void 0:t.handlers)??this.handlers,this.inheritableHandlers=(t==null?void 0:t.inheritableHandlers)??this.inheritableHandlers,this.tags=(t==null?void 0:t.tags)??this.tags,this.inheritableTags=(t==null?void 0:t.inheritableTags)??this.inheritableTags,this.metadata=(t==null?void 0:t.metadata)??this.metadata,this.inheritableMetadata=(t==null?void 0:t.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,c=void 0){return Promise.all(t.map(async(l,u)=>{const d=u===0&&r?r:Ht();return await Promise.all(this.handlers.map(h=>ve(async()=>{var f;if(!h.ignoreLLM)try{await((f=h.handleLLMStart)==null?void 0:f.call(h,e,[l],d,this._parentRunId,a,this.tags,this.metadata,c))}catch(g){console.error(`Error in handler ${h.constructor.name}, handleLLMStart: ${g}`)}},h.awaitHandlers))),new Bl(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,c=void 0){return Promise.all(t.map(async(l,u)=>{const d=u===0&&r?r:Ht();return await Promise.all(this.handlers.map(h=>ve(async()=>{var f,g;if(!h.ignoreLLM)try{if(h.handleChatModelStart)await((f=h.handleChatModelStart)==null?void 0:f.call(h,e,[l],d,this._parentRunId,a,this.tags,this.metadata,c));else if(h.handleLLMStart){const p=rh(l);await((g=h.handleLLMStart)==null?void 0:g.call(h,e,[p],d,this._parentRunId,a,this.tags,this.metadata,c))}}catch(p){console.error(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`)}},h.awaitHandlers))),new Bl(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=Ht(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>ve(async()=>{var l;if(!c.ignoreChain)try{await((l=c.handleChainStart)==null?void 0:l.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,s,o))}catch(u){console.error(`Error in handler ${c.constructor.name}, handleChainStart: ${u}`)}},c.awaitHandlers))),new Lw(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=Ht(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>ve(async()=>{var l;if(!c.ignoreAgent)try{await((l=c.handleToolStart)==null?void 0:l.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(u){console.error(`Error in handler ${c.constructor.name}, handleToolStart: ${u}`)}},c.awaitHandlers))),new Dw(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=Ht(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>ve(async()=>{var l;if(!c.ignoreRetriever)try{await((l=c.handleRetrieverStart)==null?void 0:l.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(u){console.error(`Error in handler ${c.constructor.name}, handleRetrieverStart: ${u}`)}},c.awaitHandlers))),new jw(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new Be(this._parentRunId);for(const s of this.handlers){const a=this.inheritableHandlers.includes(s);r.addHandler(s,a)}for(const s of this.tags){const a=this.inheritableTags.includes(s);r.addTags([s],a)}for(const s of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(s);r.addMetadata({[s]:this.metadata[s]},a)}for(const s of e)r.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===s.name)||r.addHandler(s,t);return r}static fromHandlers(e){class t extends fs{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ht()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static async configure(e,t,r,s,a,i,o){let c;(e||t)&&(Array.isArray(e)||!e?(c=new Be,c.setHandlers((e==null?void 0:e.map(ca))??[],!0)):c=e,c=c.copy(Array.isArray(t)?t.map(ca):t==null?void 0:t.handlers,!1));const l=Ge("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),u=Ge("LANGCHAIN_TRACING_V2")==="true",d=u||(Ge("LANGCHAIN_TRACING")??!1);if(l||d){if(c||(c=new Be),l&&!c.handlers.some(h=>h.name===dl.prototype.name)){const h=new dl;c.addHandler(h,!0)}d&&!c.handlers.some(h=>h.name==="langchain_tracer")&&u&&c.addHandler(await Cw(),!0)}return(r||s)&&c&&(c.addTags(r??[]),c.addTags(s??[],!1)),(a||i)&&c&&(c.addMetadata(a??{}),c.addMetadata(i??{},!1)),c}}function ca(n){return"name"in n?n:fs.fromMethods(n)}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const Mw=Object.prototype.hasOwnProperty;function Uw(n,e){return Mw.call(n,e)}function Fw(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Uw(n,t)&&e.push(t);return e}function Yr(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function uo(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Bw(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function ho(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(ho(n[t]))return!0}else if(typeof n=="object"){const t=Fw(n),r=t.length;for(var e=0;e<r;e++)if(ho(n[t[e]]))return!0}}return!1}function zl(n,e){const t=[n];for(const r in e){const s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s<"u"&&t.push(`${r}: ${s}`)}return t.join(`
`)}class zw extends Error{constructor(e,t,r,s,a){super(zl(e,{name:t,index:r,operation:s,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=zl(e,{name:t,index:r,operation:s,tree:a})}}const fe=zw,kr={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=fo(t,this.path);r&&(r=Yr(r));const s=Hn(t,{op:"remove",path:this.from}).removed;return Hn(t,{op:"add",path:this.path,value:s}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=fo(t,this.from);return Hn(t,{op:"add",path:this.path,value:Yr(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:ua(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var Zw={add:function(n,e,t){return uo(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:kr.move,copy:kr.copy,test:kr.test,_get:kr._get};function fo(n,e){if(e=="")return n;var t={op:"_get",path:e};return Hn(n,t),t.value}function Hn(n,e,t=!1,r=!0,s=!0,a=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):po(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=fo(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=ua(n,e.value),i.test===!1)throw new fe("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new fe("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,n);return i}}else{r||(n=Yr(n));const o=(e.path||"").split("/");let c=n,l=1,u=o.length,d,h,f;for(typeof t=="function"?f=t:f=po;;){if(h=o[l],h&&h.indexOf("~")!=-1&&(h=Bw(h)),s&&(h=="__proto__"||h=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(c[h]===void 0?d=o.slice(0,l).join("/"):l==u-1&&(d=e.path),d!==void 0&&f(e,0,n,d)),l++,Array.isArray(c)){if(h==="-")h=c.length;else{if(t&&!uo(h))throw new fe("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,n);uo(h)&&(h=~~h)}if(l>=u){if(t&&e.op==="add"&&h>c.length)throw new fe("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,n);const g=Zw[e.op].call(e,c,h,n);if(g.test===!1)throw new fe("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return g}}else if(l>=u){const g=kr[e.op].call(e,c,h,n);if(g.test===!1)throw new fe("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return g}if(c=c[h],t&&l<u&&(!c||typeof c!="object"))throw new fe("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,n)}}}function la(n,e,t,r=!0,s=!0){if(t&&!Array.isArray(e))throw new fe("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=Yr(n));const a=new Array(e.length);for(let i=0,o=e.length;i<o;i++)a[i]=Hn(n,e[i],t,!0,s,i),n=a[i].newDocument;return a.newDocument=n,a}function po(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new fe("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(kr[n.op]){if(typeof n.path!="string")throw new fe("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new fe('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new fe("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new fe("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&ho(n.value))throw new fe("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var s=n.path.split("/").length,a=r.split("/").length;if(s!==a+1&&s!==a)throw new fe("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new fe("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=qw([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new fe("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new fe("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function qw(n,e,t){try{if(!Array.isArray(n))throw new fe("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)la(Yr(e),Yr(n),t||!0);else{t=t||po;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(s){if(s instanceof fe)return s;throw s}}function ua(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),s,a,i;if(t&&r){if(a=n.length,a!=e.length)return!1;for(s=a;s--!==0;)if(!ua(n[s],e[s]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(a=o.length,a!==Object.keys(e).length)return!1;for(s=a;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=a;s--!==0;)if(i=o[s],!ua(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}class xt extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new xt({start(r){return s();function s(){return t.read().then(({done:a,value:i})=>{if(a){r.close();return}return r.enqueue(i),s()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new xt({async pull(t){const{value:r,done:s}=await e.next();s&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function bf(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(s){for(;;)if(s.length===0){const a=await n.next();for(const i of t)i.push(a)}else{if(s[0].done)return;yield s.shift().value}})}function Wt(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,s]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Wt(t[r],s):t[r]=s;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}class ln{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((r,s)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(r,s):this.firstResult.then(a=>r(void 0),s)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}async function Vw(n,e,t,...r){const s=new ln(e,t),a=await s.setup;return{output:n(s,a,...r),setup:a}}class Gt{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=la({},t);return new ts({ops:t,state:r[r.length-1].newDocument})}}class ts extends Gt{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=la(this.state,e.ops);return new ts({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=la({},e.ops);return new ts({ops:e.ops,state:t[t.length-1].newDocument})}}async function Zl(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function ql(n,e){const{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function Hw(n){return n!==void 0&&n.message!==void 0}class Vl extends ja{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=xt.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new Gt({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Gt({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await Zl(e,this._schemaFormat)),await this.writer.write(new Gt({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await Zl(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await ql(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const s=new Gt({ops:r});await this.writer.write(s)}finally{if(e.id===this.rootId){const t=new Gt({ops:[{op:"replace",path:"/final_output",value:await ql(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const a=e.inputs.messages!==void 0;let i;a?Hw(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new Ta(t):i=t;const o=new Gt({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${s}/streamed_output/-`,value:i}]});await this.writer.write(o)}}class Gw{getStore(){}run(e,t){return t()}}class Jw{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new Gw}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}}const rs=new Jw,Li=25;async function ur(n){return Be.configure(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function Hl(...n){const e={};for(const t of n.filter(r=>!!r))for(const r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){const s=e[r]??[];e[r]=[...new Set(s.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="callbacks"){const s=e.callbacks,a=t.callbacks;if(Array.isArray(a))if(!s)e.callbacks=a;else if(Array.isArray(s))e.callbacks=s.concat(a);else{const i=s.copy();for(const o of a)i.addHandler(ca(o),!0);e.callbacks=i}else if(a)if(!s)e.callbacks=a;else if(Array.isArray(s)){const i=a.copy();for(const o of s)i.addHandler(ca(o),!0);e.callbacks=i}else e.callbacks=new Be(a._parentRunId,{handlers:s.handlers.concat(a.handlers),inheritableHandlers:s.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(a.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(a.inheritableTags))),metadata:{...s.metadata,...a.metadata}})}else{const s=r;e[s]=t[s]??e[s]}return e}const Kw=new Set(["string","number","boolean"]);function ue(n){var r;const e=n??rs.getInstance().getStore();let t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,runId:void 0};if(e&&(t={...t,...e}),e!=null&&e.configurable)for(const s of Object.keys(e.configurable))Kw.has(typeof e.configurable[s])&&!((r=t.metadata)!=null&&r[s])&&(t.metadata||(t.metadata={}),t.metadata[s]=e.configurable[s]);return t}function Ue(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:s,configurable:a,runId:i}={}){const o=ue(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),s!==void 0&&(o.runName=s),a!==void 0&&(o.configurable={...o.configurable,...a}),i!==void 0&&delete o.runId,o}class wf extends ja{constructor({config:e,onStart:t,onEnd:r,onError:s}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}function vf(n){return n?n.lc_runnable:!1}class Ww{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const s=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||s.some(a=>{var i;return(i=this.includeTags)==null?void 0:i.includes(a)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&s.every(a=>{var i;return!((i=this.excludeTags)!=null&&i.includes(a))})),r}}const Xw=Symbol("Let zodToJsonSchema decide on which parser to use"),Yw={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Qw=n=>({...Yw,...n}),ev=n=>{const e=Qw(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function Ef(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function ne(n,e,t,r,s){n[e]=t,Ef(n,e,r,s)}function tv(){return{}}function rv(n,e){var r,s,a;const t={type:"array"};return(r=n.type)!=null&&r._def&&((a=(s=n.type)==null?void 0:s._def)==null?void 0:a.typeName)!==A.ZodAny&&(t.items=te(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&ne(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&ne(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(ne(t,"minItems",n.exactLength.value,n.exactLength.message,e),ne(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function nv(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?ne(t,"minimum",r.value,r.message,e):ne(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),ne(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?ne(t,"maximum",r.value,r.message,e):ne(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),ne(t,"maximum",r.value,r.message,e));break;case"multipleOf":ne(t,"multipleOf",r.value,r.message,e);break}return t}function sv(){return{type:"boolean"}}function Af(n,e){return te(n.type._def,e)}const av=(n,e)=>te(n.innerType._def,e);function Of(n,e,t){const r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((s,a)=>Of(n,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return iv(n,e)}}const iv=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const r of n.checks)switch(r.kind){case"min":ne(t,"minimum",r.value,r.message,e);break;case"max":ne(t,"maximum",r.value,r.message,e);break}return t};function ov(n,e){return{...te(n.innerType._def,e),default:n.defaultValue()}}function cv(n,e){return e.effectStrategy==="input"?te(n.schema._def,e):{}}function lv(n){return{type:"string",enum:Array.from(n.values)}}const uv=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function dv(n,e){const t=[te(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),te(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return t.forEach(a=>{if(uv(a))s.push(...a.allOf),a.unevaluatedProperties===void 0&&(r=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...c}=a;i=c}else r=void 0;s.push(i)}}),s.length?{allOf:s,...r}:void 0}function hv(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let Di;const at={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Di===void 0&&(Di=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Di),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function Sf(n,e){const t={type:"string"};if(n.checks)for(const r of n.checks)switch(r.kind){case"min":ne(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":ne(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":it(t,"email",r.message,e);break;case"format:idn-email":it(t,"idn-email",r.message,e);break;case"pattern:zod":Ce(t,at.email,r.message,e);break}break;case"url":it(t,"uri",r.message,e);break;case"uuid":it(t,"uuid",r.message,e);break;case"regex":Ce(t,r.regex,r.message,e);break;case"cuid":Ce(t,at.cuid,r.message,e);break;case"cuid2":Ce(t,at.cuid2,r.message,e);break;case"startsWith":Ce(t,RegExp(`^${Mi(r.value,e)}`),r.message,e);break;case"endsWith":Ce(t,RegExp(`${Mi(r.value,e)}$`),r.message,e);break;case"datetime":it(t,"date-time",r.message,e);break;case"date":it(t,"date",r.message,e);break;case"time":it(t,"time",r.message,e);break;case"duration":it(t,"duration",r.message,e);break;case"length":ne(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),ne(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"includes":{Ce(t,RegExp(Mi(r.value,e)),r.message,e);break}case"ip":{r.version!=="v6"&&it(t,"ipv4",r.message,e),r.version!=="v4"&&it(t,"ipv6",r.message,e);break}case"base64url":Ce(t,at.base64url,r.message,e);break;case"jwt":Ce(t,at.jwt,r.message,e);break;case"cidr":{r.version!=="v6"&&Ce(t,at.ipv4Cidr,r.message,e),r.version!=="v4"&&Ce(t,at.ipv6Cidr,r.message,e);break}case"emoji":Ce(t,at.emoji(),r.message,e);break;case"ulid":{Ce(t,at.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{it(t,"binary",r.message,e);break}case"contentEncoding:base64":{ne(t,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{Ce(t,at.base64,r.message,e);break}}break}case"nanoid":Ce(t,at.nanoid,r.message,e)}return t}function Mi(n,e){return e.patternStrategy==="escape"?pv(n):n}const fv=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function pv(n){let e="";for(let t=0;t<n.length;t++)fv.has(n[t])||(e+="\\"),e+=n[t];return e}function it(n,e,t,r){var s;n.format||(s=n.anyOf)!=null&&s.some(a=>a.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):ne(n,"format",e,t,r)}function Ce(n,e,t,r){var s;n.pattern||(s=n.allOf)!=null&&s.some(a=>a.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Gl(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):ne(n,"pattern",Gl(e,r),t,r)}function Gl(n,e){var c;if(!e.applyRegexFlags||!n.flags)return n.source;const t={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=t.i?n.source.toLowerCase():n.source;let s="",a=!1,i=!1,o=!1;for(let l=0;l<r.length;l++){if(a){s+=r[l],a=!1;continue}if(t.i){if(i){if(r[l].match(/[a-z]/)){o?(s+=r[l],s+=`${r[l-2]}-${r[l]}`.toUpperCase(),o=!1):r[l+1]==="-"&&((c=r[l+2])!=null&&c.match(/[a-z]/))?(s+=r[l],o=!0):s+=`${r[l]}${r[l].toUpperCase()}`;continue}}else if(r[l].match(/[a-z]/)){s+=`[${r[l]}${r[l].toUpperCase()}]`;continue}}if(t.m){if(r[l]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(r[l]==="$"){s+=`($|(?=[\r
]))`;continue}}if(t.s&&r[l]==="."){s+=i?`${r[l]}\r
`:`[${r[l]}\r
]`;continue}s+=r[l],r[l]==="\\"?a=!0:i&&r[l]==="]"?i=!1:!i&&r[l]==="["&&(i=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return s}function Pf(n,e){var r,s,a,i,o,c;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===A.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((l,u)=>({...l,[u]:te(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??{}}),{}),additionalProperties:e.rejectedAdditionalProperties};const t={type:"object",additionalProperties:te(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return t;if(((s=n.keyType)==null?void 0:s._def.typeName)===A.ZodString&&((a=n.keyType._def.checks)!=null&&a.length)){const{type:l,...u}=Sf(n.keyType._def,e);return{...t,propertyNames:u}}else{if(((i=n.keyType)==null?void 0:i._def.typeName)===A.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};if(((o=n.keyType)==null?void 0:o._def.typeName)===A.ZodBranded&&n.keyType._def.type._def.typeName===A.ZodString&&((c=n.keyType._def.type._def.checks)!=null&&c.length)){const{type:l,...u}=Af(n.keyType._def,e);return{...t,propertyNames:u}}}return t}function mv(n,e){if(e.mapStrategy==="record")return Pf(n,e);const t=te(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=te(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function gv(n){const e=n.values,r=Object.keys(n.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(r.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function yv(){return{not:{}}}function _v(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const da={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function bv(n,e){if(e.target==="openApi3")return Jl(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in da&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((s,a)=>{const i=da[a._def.typeName];return i&&!s.includes(i)?[...s,i]:s},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((s,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...s,i];case"bigint":return[...s,"integer"];case"object":if(a._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===t.length){const s=r.filter((a,i,o)=>o.indexOf(a)===i);return{type:s.length>1?s:s[0],enum:t.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,s)=>[...r,...s._def.values.filter(a=>!r.includes(a))],[])};return Jl(n,e)}const Jl=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,s)=>te(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function wv(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:da[n.innerType._def.typeName],nullable:!0}:{type:[da[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=te(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=te(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function vv(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",Ef(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?ne(t,"minimum",r.value,r.message,e):ne(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),ne(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?ne(t,"maximum",r.value,r.message,e):ne(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),ne(t,"maximum",r.value,r.message,e));break;case"multipleOf":ne(t,"multipleOf",r.value,r.message,e);break}return t}function Ev(n,e){const t=e.target==="openAi",r={type:"object",properties:{}},s=[],a=n.shape();for(const o in a){let c=a[o];if(c===void 0||c._def===void 0)continue;let l=Ov(c);l&&t&&(c instanceof tt&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),l=!1);const u=te(c._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});u!==void 0&&(r.properties[o]=u,l||s.push(o))}s.length&&(r.required=s);const i=Av(n,e);return i!==void 0&&(r.additionalProperties=i),r}function Av(n,e){if(n.catchall._def.typeName!=="ZodNever")return te(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(n.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function Ov(n){try{return n.isOptional()}catch{return!0}}const Sv=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return te(n.innerType._def,e);const t=te(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Pv=(n,e)=>{if(e.pipeStrategy==="input")return te(n.in._def,e);if(e.pipeStrategy==="output")return te(n.out._def,e);const t=te(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=te(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(s=>s!==void 0)}};function xv(n,e){return te(n.type._def,e)}function Rv(n,e){const r={type:"array",uniqueItems:!0,items:te(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&ne(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&ne(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function Tv(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>te(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:te(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>te(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function Iv(){return{not:{}}}function kv(){return{}}const Cv=(n,e)=>te(n.innerType._def,e),$v=(n,e,t)=>{switch(e){case A.ZodString:return Sf(n,t);case A.ZodNumber:return vv(n,t);case A.ZodObject:return Ev(n,t);case A.ZodBigInt:return nv(n,t);case A.ZodBoolean:return sv();case A.ZodDate:return Of(n,t);case A.ZodUndefined:return Iv();case A.ZodNull:return _v(t);case A.ZodArray:return rv(n,t);case A.ZodUnion:case A.ZodDiscriminatedUnion:return bv(n,t);case A.ZodIntersection:return dv(n,t);case A.ZodTuple:return Tv(n,t);case A.ZodRecord:return Pf(n,t);case A.ZodLiteral:return hv(n,t);case A.ZodEnum:return lv(n);case A.ZodNativeEnum:return gv(n);case A.ZodNullable:return wv(n,t);case A.ZodOptional:return Sv(n,t);case A.ZodMap:return mv(n,t);case A.ZodSet:return Rv(n,t);case A.ZodLazy:return()=>n.getter()._def;case A.ZodPromise:return xv(n,t);case A.ZodNaN:case A.ZodNever:return yv();case A.ZodEffects:return cv(n,t);case A.ZodAny:return tv();case A.ZodUnknown:return kv();case A.ZodDefault:return ov(n,t);case A.ZodBranded:return Af(n,t);case A.ZodReadonly:return Cv(n,t);case A.ZodCatch:return av(n,t);case A.ZodPipeline:return Pv(n,t);case A.ZodFunction:case A.ZodVoid:case A.ZodSymbol:return;default:return(r=>{})()}};function te(n,e,t=!1){var o;const r=e.seen.get(n);if(e.override){const c=(o=e.override)==null?void 0:o.call(e,n,e,r,t);if(c!==Xw)return c}if(r&&!t){const c=Nv(r,e);if(c!==void 0)return c}const s={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,s);const a=$v(n,n.typeName,e),i=typeof a=="function"?te(a(),e):a;if(i&&Lv(n,e,i),e.postProcess){const c=e.postProcess(i,n,e);return s.jsonSchema=i,c}return s.jsonSchema=i,i}const Nv=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:jv(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},jv=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Lv=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),xf=(n,e)=>{const t=ev(e),r=void 0,s=e==null?void 0:e.name,a=te(n._def,t,!1)??{},i=s===void 0?r?{...a,[t.definitionPath]:r}:a:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,s].join("/"),[t.definitionPath]:{...r,[s]:a}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function Dv(n){return vf(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...xf(n.data.schema),title:n.data.name}}}class Rf{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=ty(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...Dv(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);const r=t||Ht(),s={id:r,data:e};return this.nodes[r]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);const s={source:e.id,target:t.id,data:r};return this.edges.push(s),s}firstNode(){const e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){const e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e){Object.entries(e.nodes).forEach(([t,r])=>{this.nodes[t]=r}),this.edges=[...this.edges,...e.edges]}trimFirstNode(){const e=this.firstNode();if(e){const t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}}function Mv(n){const e=new TextEncoder,t=new ReadableStream({async start(r){for await(const s of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return xt.fromReadableStream(t)}function Kl(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}function Wl(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*Xl(n,e){const t=rs.getInstance();for(;;){const{value:r,done:s}=t.run(n,e.next.bind(e));if(s)break;yield r}}async function*Yl(n,e){const t=rs.getInstance(),r=e[Symbol.asyncIterator]();for(;;){const{value:s,done:a}=await t.run(n,r.next.bind(e));if(a)break;yield s}}function xe(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}class Ne extends hr{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Dr({bound:this,kwargs:e,config:{}})}map(){return new ha({bound:this})}withRetry(e){return new Uv({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Dr({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Fv({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(ue);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:t},(s,a)=>ue(a===0?e:r))}return Array.from({length:t},()=>ue(e))}async batch(e,t,r){var c;const s=this._getOptionsList(t??{},e.length),a=((c=s[0])==null?void 0:c.maxConcurrency)??(r==null?void 0:r.maxConcurrency),i=new hc({maxConcurrency:a,onFailedAttempt:l=>{throw l}}),o=e.map((l,u)=>i.call(async()=>{try{return await this.invoke(l,s[u])}catch(d){if(r!=null&&r.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=new ln(this._streamIterator(e,ue(t)));return await r.setup,xt.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=ue(e):t=ue({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,[t,r]}async _callWithConfig(e,t,r){const s=ue(r),a=await ur(s),i=await(a==null?void 0:a.handleChainStart(this.toJSON(),xe(t,"input"),s.runId,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));delete s.runId;let o;try{o=await e.call(this,t,s,i)}catch(c){throw await(i==null?void 0:i.handleChainError(c)),c}return await(i==null?void 0:i.handleChainEnd(xe(o,"output"))),o}async _batchWithConfig(e,t,r,s){const a=this._getOptionsList(r??{},t.length),i=await Promise.all(a.map(ur)),o=await Promise.all(i.map(async(l,u)=>{const d=await(l==null?void 0:l.handleChainStart(this.toJSON(),xe(t[u],"input"),a[u].runId,a[u].runType,void 0,void 0,a[u].runName??this.getName()));return delete a[u].runId,d}));let c;try{c=await e.call(this,t,a,o,s)}catch(l){throw await Promise.all(o.map(u=>u==null?void 0:u.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(xe(c,"output")))),c}async*_transformStreamWithConfig(e,t,r){let s,a=!0,i,o=!0;const c=ue(r),l=await ur(c);async function*u(){for await(const h of e){if(a)if(s===void 0)s=h;else try{s=Wt(s,h)}catch{s=void 0,a=!1}yield h}}let d;try{const h=await Vw(t.bind(this),u(),async()=>l==null?void 0:l.handleChainStart(this.toJSON(),{input:""},c.runId,c.runType,void 0,void 0,c.runName??this.getName()),c);delete c.runId,d=h.setup;const f=m=>m.name==="log_stream_tracer",g=d==null?void 0:d.handlers.find(f);let p=h.output;g!==void 0&&d!==void 0&&(p=await g.tapOutputIterable(d.runId,h.output));for await(const m of p)if(yield m,o)if(i===void 0)i=m;else try{i=Wt(i,m)}catch{i=void 0,o=!1}}catch(h){throw await(d==null?void 0:d.handleChainError(h,void 0,void 0,void 0,{inputs:xe(s,"input")})),h}await(d==null?void 0:d.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:xe(s,"input")}))}getGraph(e){const t=new Rf,r=t.addNode({name:`${this.getName()}Input`,schema:aa.any()}),s=t.addNode(this),a=t.addNode({name:`${this.getName()}Output`,schema:aa.any()});return t.addEdge(r,s),t.addEdge(s,a),t}pipe(e){return new Cr({first:this,last:or(e)})}pick(e){return this.pipe(new zv(e))}assign(e){return this.pipe(new Bv(new ms({steps:e})))}async*transform(e,t){let r;for await(const s of e)r===void 0?r=s:r=Wt(r,s);yield*this._streamIterator(r,ue(t))}async*streamLog(e,t,r){const s=new Vl({...r,autoClose:!1,_schemaFormat:"original"}),a=ue(t);yield*this._streamLog(e,s,a)}async*_streamLog(e,t,r){const{callbacks:s}=r;if(s===void 0)r.callbacks=[t];else if(Array.isArray(s))r.callbacks=s.concat([t]);else{const c=s.copy();c.inheritableHandlers.push(t),r.callbacks=c}const a=this.stream(e,r);async function i(){try{const c=await a;for await(const l of c){const u=new Gt({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(u)}}finally{await t.writer.close()}}const o=i();try{for await(const c of t)yield c}finally{await o}}async*streamEvents(e,t,r){if(t.encoding==="text/event-stream"){const s=await this._streamEvents(e,t,r);yield*Mv(s)}else yield*this._streamEvents(e,t,r)}async*_streamEvents(e,t,r){if(t.version!=="v1")throw new Error('Only version "v1" of the events schema is currently supported.');let s,a=!1;const i=ue(t),o=i.tags??[],c=i.metadata??{},l=i.runName??this.getName(),u=new Vl({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new Ww({...r}),h=this._streamLog(e,u,i);for await(const g of h){if(s?s=s.concat(g):s=ts.fromRunLogPatch(g),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const y={...s.state},w={run_id:y.id,event:`on_${y.type}_start`,name:l,tags:o,metadata:c,data:{input:e}};d.includeEvent(w,y.type)&&(yield w)}const p=g.ops.filter(y=>y.path.startsWith("/logs/")).map(y=>y.path.split("/")[2]),m=[...new Set(p)];for(const y of m){let w,O={};const P=s.state.logs[y];if(P.end_time===void 0?P.streamed_output.length>0?w="stream":w="start":w="end",w==="start")P.inputs!==void 0&&(O.input=P.inputs);else if(w==="end")P.inputs!==void 0&&(O.input=P.inputs),O.output=P.final_output;else if(w==="stream"){const k=P.streamed_output.length;if(k!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${k} instead. Encountered in: "${P.name}"`);O={chunk:P.streamed_output[0]},P.streamed_output=[]}yield{event:`on_${P.type}_${w}`,name:P.name,run_id:P.id,tags:P.tags,metadata:P.metadata,data:O}}const{state:_}=s;if(_.streamed_output.length>0){const y=_.streamed_output.length;if(y!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${y} instead. Encountered in: "${_.name}"`);const w={chunk:_.streamed_output[0]};_.streamed_output=[];const O={event:`on_${_.type}_stream`,run_id:_.id,tags:o,metadata:c,name:l,data:w};d.includeEvent(O,_.type)&&(yield O)}}const f=s==null?void 0:s.state;if(f!==void 0){const g={event:`on_${f.type}_end`,name:l,run_id:f.id,tags:o,metadata:c,data:{output:f.final_output}};d.includeEvent(g,f.type)&&(yield g)}}static isRunnable(e){return vf(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Dr({bound:this,config:{},configFactories:[s=>({callbacks:[new wf({config:s,onStart:e,onEnd:t,onError:r})]})]})}}class Dr extends Ne{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=Hl(this.config,...e);return Hl(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(ue(t),this.kwargs))}async batch(e,t,r){const s=Array.isArray(t)?await Promise.all(t.map(async a=>this._mergeConfig(ue(a),this.kwargs))):await this._mergeConfig(ue(t),this.kwargs);return this.bound.batch(e,s,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(ue(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(ue(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(ue(t),this.kwargs))}async*streamEvents(e,t,r){yield*this.bound.streamEvents(e,{...await this._mergeConfig(ue(t),this.kwargs),version:t.version},r)}static isRunnableBinding(e){return e.bound&&Ne.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new Dr({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[s=>({callbacks:[new wf({config:s,onStart:e,onEnd:t,onError:r})]})]})}}class ha extends Ne{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new ha({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,Ue(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new ha({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class Uv extends Dr{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const s=e>1?`retry:attempt:${e}`:void 0;return Ue(t,{callbacks:r==null?void 0:r.getChild(s)})}async _invoke(e,t,r){return Qs(s=>super.invoke(e,this._patchConfigForRetry(s,t,r)),{onFailedAttempt:s=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,s){const a={};try{await Qs(async i=>{const o=e.map((h,f)=>f).filter(h=>a[h.toString()]===void 0||a[h.toString()]instanceof Error),c=o.map(h=>e[h]),l=o.map(h=>this._patchConfigForRetry(i,t==null?void 0:t[h],r==null?void 0:r[h])),u=await super.batch(c,l,{...s,returnExceptions:!0});let d;for(let h=0;h<u.length;h+=1){const f=u[h],g=o[h];f instanceof Error&&d===void 0&&(d=f,d.input=c[h]),a[g.toString()]=f}if(d)throw d;return u},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((s==null?void 0:s.returnExceptions)!==!0)throw i}return Object.keys(a).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>a[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class Cr extends Ne{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=ue(t),s=await ur(r),a=await(s==null?void 0:s.handleChainStart(this.toJSON(),xe(e,"input"),r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;let i=e,o;try{const c=[this.first,...this.middle];for(let l=0;l<c.length;l+=1)i=await c[l].invoke(i,Ue(r,{callbacks:a==null?void 0:a.getChild(`seq:step:${l+1}`)}));o=await this.last.invoke(i,Ue(r,{callbacks:a==null?void 0:a.getChild(`seq:step:${this.steps.length}`)}))}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(xe(o,"output"))),o}async batch(e,t,r){const s=this._getOptionsList(t??{},e.length),a=await Promise.all(s.map(ur)),i=await Promise.all(a.map(async(c,l)=>{const u=await(c==null?void 0:c.handleChainStart(this.toJSON(),xe(e[l],"input"),s[l].runId,void 0,void 0,void 0,s[l].runName));return delete s[l].runId,u}));let o=e;try{for(let c=0;c<this.steps.length;c+=1)o=await this.steps[c].batch(o,i.map((u,d)=>{const h=u==null?void 0:u.getChild(`seq:step:${c+1}`);return Ue(s[d],{callbacks:h})}),r)}catch(c){throw await Promise.all(i.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(i.map(c=>c==null?void 0:c.handleChainEnd(xe(o,"output")))),o}async*_streamIterator(e,t){const r=await ur(t),{runId:s,...a}=t??{},i=await(r==null?void 0:r.handleChainStart(this.toJSON(),xe(e,"input"),s,void 0,void 0,void 0,a==null?void 0:a.runName)),o=[this.first,...this.middle,this.last];let c=!0,l;async function*u(){yield e}try{let d=o[0].transform(u(),Ue(a,{callbacks:i==null?void 0:i.getChild("seq:step:1")}));for(let h=1;h<o.length;h+=1)d=await o[h].transform(d,Ue(a,{callbacks:i==null?void 0:i.getChild(`seq:step:${h+1}`)}));for await(const h of d)if(yield h,c)if(l===void 0)l=h;else try{l=Wt(l,h)}catch{l=void 0,c=!1}}catch(d){throw await(i==null?void 0:i.handleChainError(d)),d}await(i==null?void 0:i.handleChainEnd(xe(l,"output")))}getGraph(e){const t=new Rf;let r=null;return this.steps.forEach((s,a)=>{const i=s.getGraph(e);a!==0&&i.trimFirstNode(),a!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const o=i.firstNode();if(!o)throw new Error(`Runnable ${s} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){return Cr.isRunnableSequence(e)?new Cr({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Cr({first:this.first,middle:[...this.middle,this.last],last:or(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Ne.isRunnable(e)}static from([e,...t],r){return new Cr({first:or(e),middle:t.slice(0,-1).map(or),last:or(t[t.length-1]),name:r})}}class ms extends Ne{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=or(r)}static from(e){return new ms({steps:e})}async invoke(e,t){const r=ue(t),s=await ur(r),a=await(s==null?void 0:s.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;const i={};try{await Promise.all(Object.entries(this.steps).map(async([o,c])=>{i[o]=await c.invoke(e,Ue(r,{callbacks:a==null?void 0:a.getChild(`map:key:${o}`)}))}))}catch(o){throw await(a==null?void 0:a.handleChainError(o)),o}return await(a==null?void 0:a.handleChainEnd(i)),i}async*_transform(e,t,r){const s={...this.steps},a=bf(e,Object.keys(s).length),i=new Map(Object.entries(s).map(([o,c],l)=>{const u=c.transform(a[l],Ue(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,u.next().then(d=>({key:o,gen:u,result:d}))]}));for(;i.size;){const{key:o,result:c,gen:l}=await Promise.race(i.values());i.delete(o),c.done||(yield{[o]:c.value},i.set(o,l.next().then(u=>({key:o,gen:l,result:u}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new ln(this.transform(r(),t));return await s.setup,xt.fromAsyncGenerator(s)}}class xc extends Ne{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new xc({func:e})}async _invoke(e,t,r){return new Promise((s,a)=>{const i=Ue(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((t==null?void 0:t.recursionLimit)??Li)-1});rs.getInstance().run(i,async()=>{try{let o=await this.func(e,{...i,config:i});if(o&&Ne.isRunnable(o)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...i,recursionLimit:(i.recursionLimit??Li)-1})}else if(Wl(o)){let c;for await(const l of Yl(i,o))if(c===void 0)c=l;else try{c=Wt(c,l)}catch{c=l}o=c}else if(Kl(o)){let c;for(const l of Xl(i,o))if(c===void 0)c=l;else try{c=Wt(c,l)}catch{c=l}o=c}s(o)}catch(o){a(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let s;for await(const i of e)if(s===void 0)s=i;else try{s=Wt(s,i)}catch{s=i}const a=await new Promise((i,o)=>{rs.getInstance().run(r,async()=>{try{const c=await this.func(s,{...r,config:r});i(c)}catch(c){o(c)}})});if(a&&Ne.isRunnable(a)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");const i=await a.stream(s,Ue(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??Li)-1}));for await(const o of i)yield o}else if(Wl(a))for await(const i of Yl(r,a))yield i;else if(Kl(a))for(const i of Xl(r,a))yield i;else yield a}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new ln(this.transform(r(),t));return await s.setup,xt.fromAsyncGenerator(s)}}class Fv extends Ne{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=await Be.configure(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),{runId:s,...a}=t??{},i=await(r==null?void 0:r.handleChainStart(this.toJSON(),xe(e,"input"),s,void 0,void 0,void 0,a==null?void 0:a.runName));let o;for(const c of this.runnables())try{const l=await c.invoke(e,Ue(a,{callbacks:i==null?void 0:i.getChild()}));return await(i==null?void 0:i.handleChainEnd(xe(l,"output"))),l}catch(l){o===void 0&&(o=l)}throw o===void 0?new Error("No error stored at end of fallback."):(await(i==null?void 0:i.handleChainError(o)),o)}async batch(e,t,r){if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(t??{},e.length),a=await Promise.all(s.map(c=>Be.configure(c==null?void 0:c.callbacks,void 0,c==null?void 0:c.tags,void 0,c==null?void 0:c.metadata))),i=await Promise.all(a.map(async(c,l)=>{const u=await(c==null?void 0:c.handleChainStart(this.toJSON(),xe(e[l],"input"),s[l].runId,void 0,void 0,void 0,s[l].runName));return delete s[l].runId,u}));let o;for(const c of this.runnables())try{const l=await c.batch(e,i.map((u,d)=>Ue(s[d],{callbacks:u==null?void 0:u.getChild()})),r);return await Promise.all(i.map((u,d)=>u==null?void 0:u.handleChainEnd(xe(l[d],"output")))),l}catch(l){o===void 0&&(o=l)}throw o?(await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function or(n){if(typeof n=="function")return new xc({func:n});if(Ne.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=or(r);return new ms({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class Bv extends Ne{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof ms&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const s=this.mapper.getStepsKeys(),[a,i]=bf(e),o=this.mapper.transform(i,Ue(r,{callbacks:t==null?void 0:t.getChild()})),c=o.next();for await(const l of a){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);const u=Object.fromEntries(Object.entries(l).filter(([d])=>!s.includes(d)));Object.keys(u).length>0&&(yield u)}yield(await c).value;for await(const l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new ln(this.transform(r(),t));return await s.setup,xt.fromAsyncGenerator(s)}}class zv extends Ne{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new ln(this.transform(r(),t));return await s.setup,xt.fromAsyncGenerator(s)}}const Zv=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n,qv=()=>!1;class Vv extends Ne{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??qv(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class Hv extends Vv{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=lc.global():this.cache=void 0,this.caller=new hc(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Tg("modelName"in this?Zv(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new ah(e):Array.isArray(e)?new Vm(e.map(Un)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class sr extends Hv{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r!=null&&r.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){const r=sr._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===sr.prototype._streamResponseChunks)yield this.invoke(e,t);else{const s=sr._convertInputToPromptValue(e).toChatMessages(),[a,i]=this._separateRunnableConfigFromCallOptions(t),o=await Be.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),c={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},l=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),[s],a.runId,void 0,c,void 0,void 0,a.runName));let u;try{for await(const d of this._streamResponseChunks(s,i,l==null?void 0:l[0]))d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,u?u=u.concat(d):u=d}catch(d){throw await Promise.all((l??[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}await Promise.all((l??[]).map(d=>d==null?void 0:d.handleLLMEnd({generations:[[u]]})))}}async _generateUncached(e,t,r){var h;const s=e.map(f=>f.map(Un)),a=await Be.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1},o=await(a==null?void 0:a.handleChatModelStart(this.toJSON(),s,r.runId,void 0,i,void 0,void 0,r.runName)),c=await Promise.allSettled(s.map((f,g)=>this._generate(f,{...t,promptIndex:g},o==null?void 0:o[g]))),l=[],u=[];await Promise.all(c.map(async(f,g)=>{var p,m;if(f.status==="fulfilled"){const _=f.value;for(const y of _.generations)y.message.response_metadata={...y.generationInfo,...y.message.response_metadata};return _.generations.length===1&&(_.generations[0].message.response_metadata={..._.llmOutput,..._.generations[0].message.response_metadata}),l[g]=_.generations,u[g]=_.llmOutput,(p=o==null?void 0:o[g])==null?void 0:p.handleLLMEnd({generations:[_.generations],llmOutput:_.llmOutput})}else return await((m=o==null?void 0:o[g])==null?void 0:m.handleLLMError(f.reason)),Promise.reject(f.reason)}));const d={generations:l,llmOutput:u.length?(h=this._combineLLMOutput)==null?void 0:h.call(this,...u):void 0};return Object.defineProperty(d,il,{value:o?{runIds:o==null?void 0:o.map(f=>f.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:s,handledOptions:a}){const i=e.map(p=>p.map(Un)),o=await Be.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),c={options:s,invocation_params:this==null?void 0:this.invocationParams(s),batch_size:1,cached:!0},l=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),i,a.runId,void 0,c,void 0,void 0,a.runName)),u=[],h=(await Promise.allSettled(i.map(async(p,m)=>{const _=sr._convertInputToPromptValue(p).toString(),y=await t.lookup(_,r);return y==null&&u.push(m),y}))).map((p,m)=>({result:p,runManager:l==null?void 0:l[m]})).filter(({result:p})=>p.status==="fulfilled"&&p.value!=null||p.status==="rejected"),f=[];await Promise.all(h.map(async({result:p,runManager:m},_)=>{if(p.status==="fulfilled"){const y=p.value;return f[_]=y,y.length&&await(m==null?void 0:m.handleLLMNewToken(y[0].text)),m==null?void 0:m.handleLLMEnd({generations:[y]})}else return await(m==null?void 0:m.handleLLMError(p.reason)),Promise.reject(p.reason)}));const g={generations:f,missingPromptIndices:u};return Object.defineProperty(g,il,{value:l?{runIds:l==null?void 0:l.map(p=>p.runId)}:void 0,configurable:!0}),g}async generate(e,t,r){let s;Array.isArray(t)?s={stop:t}:s=t;const a=e.map(f=>f.map(Un)),[i,o]=this._separateRunnableConfigFromCallOptions(s);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(a,o,i);const{cache:c}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:u,missingPromptIndices:d}=await this._generateCached({messages:a,cache:c,llmStringKey:l,parsedOptions:o,handledOptions:i});let h={};if(d.length>0){const f=await this._generateUncached(d.map(g=>a[g]),o,i);await Promise.all(f.generations.map(async(g,p)=>{const m=d[p];u[m]=g;const _=sr._convertInputToPromptValue(a[m]).toString();return c.update(_,l,g)})),h=f.llmOutput??{}}return{generations:u,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){const s=e.map(a=>a.toChatMessages());return this.generate(s,t,r)}async call(e,t,r){return(await this.generate([e.map(Un)],t,r)).generations[0][0].message}async callPrompt(e,t,r){const s=e.toChatMessages();return this.call(s,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){const s=new Ys(e),a=await this.call([s],t,r);if(typeof a.content!="string")throw new Error("Cannot use predict when output is not a string.");return a.content}}function Gv(n){return{name:n.name,description:n.description,parameters:xf(n.schema)}}function Jv(n){return Kv(n)?{type:"function",function:Gv(n)}:n}function Kv(n){return n!==void 0&&Array.isArray(n.lc_namespace)}function Wv(n){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:a}=n;if(r&&s&&e)return`${s}/${e}`;if(r){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return a}var Xv={},za={},mn={};const Rc=lp(Xg);var Za={};Object.defineProperty(Za,"__esModule",{value:!0});Za.parseAnyDef=void 0;function Yv(){return{}}Za.parseAnyDef=Yv;var gn={},Mt={};Object.defineProperty(Mt,"__esModule",{value:!0});Mt.setResponseValueAndErrors=Mt.addErrorMessage=void 0;function Tf(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage=Object.assign(Object.assign({},n.errorMessage),{[e]:t}))}Mt.addErrorMessage=Tf;function Qv(n,e,t,r,s){n[e]=t,Tf(n,e,r,s)}Mt.setResponseValueAndErrors=Qv;var Ql;function e0(){if(Ql)return gn;Ql=1,Object.defineProperty(gn,"__esModule",{value:!0}),gn.parseArrayDef=void 0;const n=Rc,e=Mt,t=Se();function r(s,a){var i,o;const c={type:"array"};return((o=(i=s.type)===null||i===void 0?void 0:i._def)===null||o===void 0?void 0:o.typeName)!==n.ZodFirstPartyTypeKind.ZodAny&&(c.items=(0,t.parseDef)(s.type._def,Object.assign(Object.assign({},a),{currentPath:[...a.currentPath,"items"]}))),s.minLength&&(0,e.setResponseValueAndErrors)(c,"minItems",s.minLength.value,s.minLength.message,a),s.maxLength&&(0,e.setResponseValueAndErrors)(c,"maxItems",s.maxLength.value,s.maxLength.message,a),c}return gn.parseArrayDef=r,gn}var qa={};Object.defineProperty(qa,"__esModule",{value:!0});qa.parseBigintDef=void 0;function t0(){return{type:"integer",format:"int64"}}qa.parseBigintDef=t0;var Va={};Object.defineProperty(Va,"__esModule",{value:!0});Va.parseBooleanDef=void 0;function r0(){return{type:"boolean"}}Va.parseBooleanDef=r0;var yn={},eu;function n0(){if(eu)return yn;eu=1,Object.defineProperty(yn,"__esModule",{value:!0}),yn.parseBrandedDef=void 0;const n=Se();function e(t,r){return(0,n.parseDef)(t.type._def,r)}return yn.parseBrandedDef=e,yn}var _n={},tu;function s0(){if(tu)return _n;tu=1,Object.defineProperty(_n,"__esModule",{value:!0}),_n.parseCatchDef=void 0;const n=Se(),e=(t,r)=>(0,n.parseDef)(t.innerType._def,r);return _n.parseCatchDef=e,_n}var Ha={};Object.defineProperty(Ha,"__esModule",{value:!0});Ha.parseDateDef=void 0;function a0(){return{type:"string",format:"date-time"}}Ha.parseDateDef=a0;var bn={},ru;function i0(){if(ru)return bn;ru=1,Object.defineProperty(bn,"__esModule",{value:!0}),bn.parseDefaultDef=void 0;const n=Se();function e(t,r){return Object.assign(Object.assign({},(0,n.parseDef)(t.innerType._def,r)),{default:t.defaultValue()})}return bn.parseDefaultDef=e,bn}var wn={},nu;function o0(){if(nu)return wn;nu=1,Object.defineProperty(wn,"__esModule",{value:!0}),wn.parseEffectsDef=void 0;const n=Se();function e(t,r){return r.effectStrategy==="input"?(0,n.parseDef)(t.schema._def,r):{}}return wn.parseEffectsDef=e,wn}var Ga={};Object.defineProperty(Ga,"__esModule",{value:!0});Ga.parseEnumDef=void 0;function c0(n){return{type:"string",enum:n.values}}Ga.parseEnumDef=c0;var vn={},su;function l0(){if(su)return vn;su=1,Object.defineProperty(vn,"__esModule",{value:!0}),vn.parseIntersectionDef=void 0;const n=Se();function e(t,r){const s=[(0,n.parseDef)(t.left._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"allOf","0"]})),(0,n.parseDef)(t.right._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"allOf","1"]}))].filter(a=>!!a);return s.length?{allOf:s}:void 0}return vn.parseIntersectionDef=e,vn}var Ja={};Object.defineProperty(Ja,"__esModule",{value:!0});Ja.parseLiteralDef=void 0;function u0(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}Ja.parseLiteralDef=u0;var En={},au;function d0(){if(au)return En;au=1,Object.defineProperty(En,"__esModule",{value:!0}),En.parseMapDef=void 0;const n=Se();function e(t,r){const s=(0,n.parseDef)(t.keyType._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"items","items","0"]}))||{},a=(0,n.parseDef)(t.valueType._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"items","items","1"]}))||{};return{type:"array",maxItems:125,items:{type:"array",items:[s,a],minItems:2,maxItems:2}}}return En.parseMapDef=e,En}var Ka={};Object.defineProperty(Ka,"__esModule",{value:!0});Ka.parseNativeEnumDef=void 0;function h0(n){const e=n.values,r=Object.keys(n.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(r.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}Ka.parseNativeEnumDef=h0;var Wa={};Object.defineProperty(Wa,"__esModule",{value:!0});Wa.parseNeverDef=void 0;function f0(){return{not:{}}}Wa.parseNeverDef=f0;var Xa={};Object.defineProperty(Xa,"__esModule",{value:!0});Xa.parseNullDef=void 0;function p0(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}Xa.parseNullDef=p0;var An={},Ui={},iu;function If(){return iu||(iu=1,function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.parseUnionDef=n.primitiveMappings=void 0;const e=Se();n.primitiveMappings={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function t(s,a){if(a.target==="openApi3")return r(s,a);const i=s.options instanceof Map?Array.from(s.options.values()):s.options;if(i.every(o=>o._def.typeName in n.primitiveMappings&&(!o._def.checks||!o._def.checks.length))){const o=i.reduce((c,l)=>{const u=n.primitiveMappings[l._def.typeName];return u&&!c.includes(u)?[...c,u]:c},[]);return{type:o.length>1?o:o[0]}}else if(i.every(o=>o._def.typeName==="ZodLiteral")){const o=i.reduce((c,l)=>{const u=typeof l._def.value;switch(u){case"string":case"number":case"boolean":return[...c,u];case"bigint":return[...c,"integer"];case"object":if(l._def.value===null)return[...c,"null"];case"symbol":case"undefined":case"function":default:return c}},[]);if(o.length===i.length){const c=o.filter((l,u,d)=>d.indexOf(l)===u);return{type:c.length>1?c:c[0],enum:i.reduce((l,u)=>l.includes(u._def.value)?l:[...l,u._def.value],[])}}}else if(i.every(o=>o._def.typeName==="ZodEnum"))return{type:"string",enum:i.reduce((o,c)=>[...o,...c._def.values.filter(l=>!o.includes(l))],[])};return r(s,a)}n.parseUnionDef=t;const r=(s,a)=>{const i=(s.options instanceof Map?Array.from(s.options.values()):s.options).map((o,c)=>(0,e.parseDef)(o._def,Object.assign(Object.assign({},a),{currentPath:[...a.currentPath,"anyOf",`${c}`]}))).filter(o=>!!o&&(!a.strictUnions||typeof o=="object"&&Object.keys(o).length>0));return i.length?{anyOf:i}:void 0}}(Ui)),Ui}var ou;function m0(){if(ou)return An;ou=1,Object.defineProperty(An,"__esModule",{value:!0}),An.parseNullableDef=void 0;const n=Se(),e=If();function t(r,s){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(r.innerType._def.typeName)&&(!r.innerType._def.checks||!r.innerType._def.checks.length))return s.target==="openApi3"?{type:e.primitiveMappings[r.innerType._def.typeName],nullable:!0}:{type:[e.primitiveMappings[r.innerType._def.typeName],"null"]};const a=(0,n.parseDef)(r.innerType._def,Object.assign(Object.assign({},s),{currentPath:[...s.currentPath,"anyOf","0"]}));return a?s.target==="openApi3"?Object.assign(Object.assign({},a),{nullable:!0}):{anyOf:[a,{type:"null"}]}:void 0}return An.parseNullableDef=t,An}var Ya={};Object.defineProperty(Ya,"__esModule",{value:!0});Ya.parseNumberDef=void 0;const Vt=Mt;function g0(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",(0,Vt.addErrorMessage)(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?(0,Vt.setResponseValueAndErrors)(t,"minimum",r.value,r.message,e):(0,Vt.setResponseValueAndErrors)(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),(0,Vt.setResponseValueAndErrors)(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?(0,Vt.setResponseValueAndErrors)(t,"maximum",r.value,r.message,e):(0,Vt.setResponseValueAndErrors)(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),(0,Vt.setResponseValueAndErrors)(t,"maximum",r.value,r.message,e));break;case"multipleOf":(0,Vt.setResponseValueAndErrors)(t,"multipleOf",r.value,r.message,e);break}return t}Ya.parseNumberDef=g0;var On={},cu;function y0(){if(cu)return On;cu=1,Object.defineProperty(On,"__esModule",{value:!0}),On.parseObjectDef=void 0;const n=Se();function e(t,r){var s;const a=Object.assign(Object.assign({type:"object"},Object.entries(t.shape()).reduce((i,[o,c])=>{if(c===void 0||c._def===void 0)return i;const l=(0,n.parseDef)(c._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"properties",o],propertyPath:[...r.currentPath,"properties",o]}));return l===void 0?i:{properties:Object.assign(Object.assign({},i.properties),{[o]:l}),required:c.isOptional()?i.required:[...i.required,o]}},{properties:{},required:[]})),{additionalProperties:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":(s=(0,n.parseDef)(t.catchall._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"additionalProperties"]})))!==null&&s!==void 0?s:!0});return a.required.length||delete a.required,a}return On.parseObjectDef=e,On}var Sn={},lu;function _0(){if(lu)return Sn;lu=1,Object.defineProperty(Sn,"__esModule",{value:!0}),Sn.parseOptionalDef=void 0;const n=Se(),e=(t,r)=>{var s;if(r.currentPath.toString()===((s=r.propertyPath)===null||s===void 0?void 0:s.toString()))return(0,n.parseDef)(t.innerType._def,r);const a=(0,n.parseDef)(t.innerType._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"anyOf","1"]}));return a?{anyOf:[{not:{}},a]}:{}};return Sn.parseOptionalDef=e,Sn}var Pn={},uu;function b0(){if(uu)return Pn;uu=1,Object.defineProperty(Pn,"__esModule",{value:!0}),Pn.parsePipelineDef=void 0;const n=Se(),e=(t,r)=>{const s=(0,n.parseDef)(t.in._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"allOf","0"]})),a=(0,n.parseDef)(t.out._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"allOf",s?"1":"0"]}));return{allOf:[s,a].filter(i=>i!==void 0)}};return Pn.parsePipelineDef=e,Pn}var xn={},du;function w0(){if(du)return xn;du=1,Object.defineProperty(xn,"__esModule",{value:!0}),xn.parsePromiseDef=void 0;const n=Se();function e(t,r){return(0,n.parseDef)(t.type._def,r)}return xn.parsePromiseDef=e,xn}var Rn={},gs={};Object.defineProperty(gs,"__esModule",{value:!0});gs.parseStringDef=void 0;const Ct=Mt;function v0(n,e){const t={type:"string"};if(n.checks)for(const r of n.checks)switch(r.kind){case"min":(0,Ct.setResponseValueAndErrors)(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":(0,Ct.setResponseValueAndErrors)(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":(0,Ct.setResponseValueAndErrors)(t,"format","email",r.message,e);break;case"url":(0,Ct.setResponseValueAndErrors)(t,"format","uri",r.message,e);break;case"uuid":(0,Ct.setResponseValueAndErrors)(t,"format","uuid",r.message,e);break;case"regex":Tn(t,r.regex.source,r.message,e);break;case"cuid":Tn(t,"^c[^\\s-]{8,}$",r.message,e);break;case"cuid2":Tn(t,"^[a-z][a-z0-9]*$",r.message,e);break;case"startsWith":Tn(t,"^"+hu(r.value),r.message,e);break;case"endsWith":Tn(t,hu(r.value)+"$",r.message,e);break;case"trim":break;case"datetime":(0,Ct.setResponseValueAndErrors)(t,"format","date-time",r.message,e);break;case"length":(0,Ct.setResponseValueAndErrors)(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),(0,Ct.setResponseValueAndErrors)(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break}return t}gs.parseStringDef=v0;const hu=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Tn=(n,e,t,r)=>{var s;n.pattern||!((s=n.allOf)===null||s===void 0)&&s.some(a=>a.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push(Object.assign({pattern:n.pattern},n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}})),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push(Object.assign({pattern:e},t&&r.errorMessages&&{errorMessage:{pattern:t}}))):(0,Ct.setResponseValueAndErrors)(n,"pattern",e,t,r)};var fu;function E0(){if(fu)return Rn;fu=1,Object.defineProperty(Rn,"__esModule",{value:!0}),Rn.parseRecordDef=void 0;const n=Rc,e=Se(),t=gs;function r(s,a){var i,o,c;const l={type:"object",additionalProperties:(0,e.parseDef)(s.valueType._def,Object.assign(Object.assign({},a),{currentPath:[...a.currentPath,"additionalProperties"]}))||{}};if(((i=s.keyType)===null||i===void 0?void 0:i._def.typeName)===n.ZodFirstPartyTypeKind.ZodString&&(!((o=s.keyType._def.checks)===null||o===void 0)&&o.length)){const u=Object.entries((0,t.parseStringDef)(s.keyType._def,a)).reduce((d,[h,f])=>h==="type"?d:Object.assign(Object.assign({},d),{[h]:f}),{});return Object.assign(Object.assign({},l),{propertyNames:u})}else if(((c=s.keyType)===null||c===void 0?void 0:c._def.typeName)===n.ZodFirstPartyTypeKind.ZodEnum)return Object.assign(Object.assign({},l),{propertyNames:{enum:s.keyType._def.values}});return l}return Rn.parseRecordDef=r,Rn}var In={},pu;function A0(){if(pu)return In;pu=1,Object.defineProperty(In,"__esModule",{value:!0}),In.parseSetDef=void 0;const n=Mt,e=Se();function t(r,s){const i={type:"array",items:(0,e.parseDef)(r.valueType._def,Object.assign(Object.assign({},s),{currentPath:[...s.currentPath,"items"]}))};return r.minSize&&(0,n.setResponseValueAndErrors)(i,"minItems",r.minSize.value,r.minSize.message,s),r.maxSize&&(0,n.setResponseValueAndErrors)(i,"maxItems",r.maxSize.value,r.maxSize.message,s),i}return In.parseSetDef=t,In}var kn={},mu;function O0(){if(mu)return kn;mu=1,Object.defineProperty(kn,"__esModule",{value:!0}),kn.parseTupleDef=void 0;const n=Se();function e(t,r){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((s,a)=>(0,n.parseDef)(s._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"items",`${a}`]}))).reduce((s,a)=>a===void 0?s:[...s,a],[]),additionalItems:(0,n.parseDef)(t.rest._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"additionalItems"]}))}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((s,a)=>(0,n.parseDef)(s._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"items",`${a}`]}))).reduce((s,a)=>a===void 0?s:[...s,a],[])}}return kn.parseTupleDef=e,kn}var Qa={};Object.defineProperty(Qa,"__esModule",{value:!0});Qa.parseUndefinedDef=void 0;function S0(){return{not:{}}}Qa.parseUndefinedDef=S0;var ei={};Object.defineProperty(ei,"__esModule",{value:!0});ei.parseUnknownDef=void 0;function P0(){return{}}ei.parseUnknownDef=P0;var gu;function Se(){if(gu)return mn;gu=1,Object.defineProperty(mn,"__esModule",{value:!0}),mn.parseDef=void 0;const n=Rc,e=Za,t=e0(),r=qa,s=Va,a=n0(),i=s0(),o=Ha,c=i0(),l=o0(),u=Ga,d=l0(),h=Ja,f=d0(),g=Ka,p=Wa,m=Xa,_=m0(),y=Ya,w=y0(),O=_0(),P=b0(),k=w0(),$=E0(),Q=A0(),re=gs,se=O0(),ee=Qa,gt=If(),tr=ei;function T(v,C){const I=C.seen.find(Ie=>Object.is(Ie.def,v));if(I)return S(I,C);const q={def:v,path:C.currentPath,jsonSchema:void 0};C.seen.push(q);const ae=L(v,v.typeName,C);return ae&&U(v,ae),q.jsonSchema=ae,ae}mn.parseDef=T;const S=(v,C)=>{switch(C.$refStrategy){case"root":return{$ref:v.path.length===0?"":v.path.length===1?`${v.path[0]}/`:v.path.join("/")};case"relative":return{$ref:M(C.currentPath,v.path)};case"none":return v.path.length<C.currentPath.length&&v.path.every((I,q)=>C.currentPath[q]===I)?(console.warn(`Recursive reference detected at ${C.currentPath.join("/")}! Defaulting to any`),{}):v.jsonSchema}},M=(v,C)=>{let I=0;for(;I<v.length&&I<C.length&&v[I]===C[I];I++);return[(v.length-I).toString(),...C.slice(I)].join("/")},L=(v,C,I)=>{switch(C){case n.ZodFirstPartyTypeKind.ZodString:return(0,re.parseStringDef)(v,I);case n.ZodFirstPartyTypeKind.ZodNumber:return(0,y.parseNumberDef)(v,I);case n.ZodFirstPartyTypeKind.ZodObject:return(0,w.parseObjectDef)(v,I);case n.ZodFirstPartyTypeKind.ZodBigInt:return(0,r.parseBigintDef)();case n.ZodFirstPartyTypeKind.ZodBoolean:return(0,s.parseBooleanDef)();case n.ZodFirstPartyTypeKind.ZodDate:return(0,o.parseDateDef)();case n.ZodFirstPartyTypeKind.ZodUndefined:return(0,ee.parseUndefinedDef)();case n.ZodFirstPartyTypeKind.ZodNull:return(0,m.parseNullDef)(I);case n.ZodFirstPartyTypeKind.ZodArray:return(0,t.parseArrayDef)(v,I);case n.ZodFirstPartyTypeKind.ZodUnion:case n.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:return(0,gt.parseUnionDef)(v,I);case n.ZodFirstPartyTypeKind.ZodIntersection:return(0,d.parseIntersectionDef)(v,I);case n.ZodFirstPartyTypeKind.ZodTuple:return(0,se.parseTupleDef)(v,I);case n.ZodFirstPartyTypeKind.ZodRecord:return(0,$.parseRecordDef)(v,I);case n.ZodFirstPartyTypeKind.ZodLiteral:return(0,h.parseLiteralDef)(v,I);case n.ZodFirstPartyTypeKind.ZodEnum:return(0,u.parseEnumDef)(v);case n.ZodFirstPartyTypeKind.ZodNativeEnum:return(0,g.parseNativeEnumDef)(v);case n.ZodFirstPartyTypeKind.ZodNullable:return(0,_.parseNullableDef)(v,I);case n.ZodFirstPartyTypeKind.ZodOptional:return(0,O.parseOptionalDef)(v,I);case n.ZodFirstPartyTypeKind.ZodMap:return(0,f.parseMapDef)(v,I);case n.ZodFirstPartyTypeKind.ZodSet:return(0,Q.parseSetDef)(v,I);case n.ZodFirstPartyTypeKind.ZodLazy:return T(v.getter()._def,I);case n.ZodFirstPartyTypeKind.ZodPromise:return(0,k.parsePromiseDef)(v,I);case n.ZodFirstPartyTypeKind.ZodNaN:case n.ZodFirstPartyTypeKind.ZodNever:return(0,p.parseNeverDef)();case n.ZodFirstPartyTypeKind.ZodEffects:return(0,l.parseEffectsDef)(v,I);case n.ZodFirstPartyTypeKind.ZodAny:return(0,e.parseAnyDef)();case n.ZodFirstPartyTypeKind.ZodUnknown:return(0,tr.parseUnknownDef)();case n.ZodFirstPartyTypeKind.ZodDefault:return(0,c.parseDefaultDef)(v,I);case n.ZodFirstPartyTypeKind.ZodBranded:return(0,a.parseBrandedDef)(v,I);case n.ZodFirstPartyTypeKind.ZodCatch:return(0,i.parseCatchDef)(v,I);case n.ZodFirstPartyTypeKind.ZodPipeline:return(0,P.parsePipelineDef)(v,I);case n.ZodFirstPartyTypeKind.ZodFunction:case n.ZodFirstPartyTypeKind.ZodVoid:case n.ZodFirstPartyTypeKind.ZodSymbol:return;default:return(q=>{})()}},U=(v,C)=>(v.description&&(C.description=v.description),C);return mn}var ti={},kf={};(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.getDefaultOptions=n.defaultOptions=void 0,n.defaultOptions={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1};const e=t=>typeof t=="string"?Object.assign(Object.assign({},n.defaultOptions),{name:t}):Object.assign(Object.assign({},n.defaultOptions),t);n.getDefaultOptions=e})(kf);Object.defineProperty(ti,"__esModule",{value:!0});ti.getRefs=void 0;const x0=kf,R0=n=>{const e=(0,x0.getDefaultOptions)(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return Object.assign(Object.assign({},e),{currentPath:t,propertyPath:void 0,seen:[]})};ti.getRefs=R0;Object.defineProperty(za,"__esModule",{value:!0});za.zodToJsonSchema=void 0;const yu=Se(),T0=ti,I0=(n,e)=>{var t;const r=(0,T0.getRefs)(e),s=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((c,[l,u])=>{var d;return Object.assign(Object.assign({},c),{[l]:(d=(0,yu.parseDef)(u._def,Object.assign(Object.assign({},r),{currentPath:[...r.basePath,r.definitionPath,l]})))!==null&&d!==void 0?d:{}})},{}):void 0,a=typeof e=="string"?e:e==null?void 0:e.name,i=(t=(0,yu.parseDef)(n._def,a===void 0?r:Object.assign(Object.assign({},r),{currentPath:[...r.basePath,r.definitionPath,a]})))!==null&&t!==void 0?t:{},o=a===void 0?s?Object.assign(Object.assign({},i),{[r.definitionPath]:s}):i:{$ref:[...r.$refStrategy==="relative"?[]:r.basePath,r.definitionPath,a].join("/"),[r.definitionPath]:Object.assign(Object.assign({},s),{[a]:i})};return r.target==="jsonSchema7"&&(o.$schema="http://json-schema.org/draft-07/schema#"),o};za.zodToJsonSchema=I0;(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.zodToJsonSchema=void 0;const e=za;Object.defineProperty(n,"zodToJsonSchema",{enumerable:!0,get:function(){return e.zodToJsonSchema}}),n.default=e.zodToJsonSchema})(Xv);function k0(n){let e;return n.constructor.name===ya.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===Je.name?(e=new Error(n.message),e.name="AbortError"):e=n,e}function C0(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function $0(n){const e=["namespace functions {",""];for(const t of n)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(Cf(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Cf(n,e){var r;const t=[];for(const[s,a]of Object.entries(n.properties??{}))a.description&&e<2&&t.push(`// ${a.description}`),(r=n.required)!=null&&r.includes(s)?t.push(`${s}: ${fa(a,e)},`):t.push(`${s}?: ${fa(a,e)},`);return t.map(s=>" ".repeat(e)+s).join(`
`)}function fa(n,e){if(C0(n))return n.anyOf.map(t=>fa(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Cf(n,e+2),"}"].join(`
`);case"array":return n.items?`${fa(n.items,e)}[]`:"any[]";default:return""}}function N0(n){return n.role!=="system"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function $f(n){const e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Ia.isInstance(n))throw new Error("Invalid generic chat message");return N0(n)}default:throw new Error(`Unknown message type: ${e}`)}}function j0(n){switch(n.role){case"assistant":return new th(n.content||"",{function_call:n.function_call,tool_calls:n.tool_calls});default:return new Ia(n.content||"",n.role??"unknown")}}function L0(n,e){const t=n.role??e,r=n.content??"";let s;return n.function_call?s={function_call:n.function_call}:n.tool_calls?s={tool_calls:n.tool_calls}:s={},t==="user"?new ac({content:r}):t==="assistant"?new Ta({content:r,additional_kwargs:s}):t==="system"?new ic({content:r}):t==="function"?new sc({content:r,additional_kwargs:s,name:n.name}):t==="tool"?new rc({content:r,additional_kwargs:s,tool_call_id:n.tool_call_id}):new nc({content:r,role:t})}function _u(n){return n.map(e=>({role:$f(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id}))}class ys extends sr{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){var r,s,a,i,o,c,l,u;if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.openAIApiKey)??Ge("OPENAI_API_KEY"),this.azureOpenAIApiKey=(e==null?void 0:e.azureOpenAIApiKey)??Ge("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=(e==null?void 0:e.azureOpenAIApiInstanceName)??Ge("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e==null?void 0:e.azureOpenAIApiDeploymentName)??Ge("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(e==null?void 0:e.azureOpenAIApiVersion)??Ge("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(e==null?void 0:e.azureOpenAIBasePath)??Ge("AZURE_OPENAI_BASE_PATH"),this.organization=((r=e==null?void 0:e.configuration)==null?void 0:r.organization)??Ge("OPENAI_ORGANIZATION"),this.modelName=(e==null?void 0:e.modelName)??this.modelName,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=e==null?void 0:e.stop,this.user=e==null?void 0:e.user,this.streaming=(e==null?void 0:e.streaming)??!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.openAIApiKey=this.openAIApiKey??""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:(t==null?void 0:t.basePath)??((s=e==null?void 0:e.configuration)==null?void 0:s.basePath),dangerouslyAllowBrowser:!0,defaultHeaders:((a=t==null?void 0:t.baseOptions)==null?void 0:a.headers)??((o=(i=e==null?void 0:e.configuration)==null?void 0:i.baseOptions)==null?void 0:o.headers),defaultQuery:((c=t==null?void 0:t.baseOptions)==null?void 0:c.params)??((u=(l=e==null?void 0:e.configuration)==null?void 0:l.baseOptions)==null?void 0:u.params),...t,...e==null?void 0:e.configuration}}invocationParams(e){function t(s){return s!==void 0&&s.every(a=>Array.isArray(a.lc_namespace))}return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stop,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:t(e==null?void 0:e.tools)?e==null?void 0:e.tools.map(Jv):e==null?void 0:e.tools,tool_choice:e==null?void 0:e.tool_choice,response_format:e==null?void 0:e.response_format,seed:e==null?void 0:e.seed,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){var c;const s=_u(e),a={...this.invocationParams(t),messages:s,stream:!0};let i;const o=await this.completionWithRetry(a,t);for await(const l of o){const u=l==null?void 0:l.choices[0];if(!u)continue;const{delta:d}=u;if(!d)continue;const h=L0(d,i);i=d.role??i;const f={prompt:t.promptIndex??0,completion:u.index??0};if(typeof h.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const g=new cc({message:h,text:h.content,generationInfo:f});yield g,r==null||r.handleLLMNewToken(g.text??"",f,void 0,void 0,void 0,{chunk:g})}if((c=t.signal)!=null&&c.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){var o,c;const s={},a=this.invocationParams(t),i=_u(e);if(a.stream){const l=this._streamResponseChunks(e,t,r),u={};for await(const m of l){const _=((o=m.generationInfo)==null?void 0:o.completion)??0;u[_]===void 0?u[_]=m:u[_]=u[_].concat(m)}const d=Object.entries(u).sort(([m],[_])=>parseInt(m,10)-parseInt(_,10)).map(([m,_])=>_),{functions:h,function_call:f}=this.invocationParams(t),g=await this.getEstimatedTokenCountFromPrompt(e,h,f),p=await this.getNumTokensFromGenerations(d);return s.promptTokens=g,s.completionTokens=p,s.totalTokens=g+p,{generations:d,llmOutput:{estimatedTokenUsage:s}}}else{const l=await this.completionWithRetry({...a,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}),{completion_tokens:u,prompt_tokens:d,total_tokens:h}=(l==null?void 0:l.usage)??{};u&&(s.completionTokens=(s.completionTokens??0)+u),d&&(s.promptTokens=(s.promptTokens??0)+d),h&&(s.totalTokens=(s.totalTokens??0)+h);const f=[];for(const g of(l==null?void 0:l.choices)??[]){const m={text:((c=g.message)==null?void 0:c.content)??"",message:j0(g.message??{role:"assistant"})};m.generationInfo={...g.finish_reason?{finish_reason:g.finish_reason}:{},...g.logprobs?{logprobs:g.logprobs}:{}},f.push(m)}return{generations:f,llmOutput:{tokenUsage:s}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){const a=$0(t);s+=await this.getNumTokens(a),s+=9}return t&&e.find(a=>a._getType()==="system")&&(s-=4),r==="none"?s+=1:typeof r=="object"&&(s+=await this.getNumTokens(r.name)+4),s}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var s;return(s=r.message.additional_kwargs)!=null&&s.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,s)=>r+s,0)}async getNumTokensFromMessages(e){let t=0,r=0,s=0;this.modelName==="gpt-3.5-turbo-0301"?(r=4,s=-1):(r=3,s=1);const a=await Promise.all(e.map(async i=>{var h,f,g,p,m;const o=await this.getNumTokens(i.content),c=await this.getNumTokens($f(i)),l=i.name!==void 0?s+await this.getNumTokens(i.name):0;let u=o+r+c+l;const d=i;return d._getType()==="function"&&(u-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(u+=3),(f=d==null?void 0:d.additional_kwargs.function_call)!=null&&f.name&&(u+=await this.getNumTokens((g=d.additional_kwargs.function_call)==null?void 0:g.name)),(p=d.additional_kwargs.function_call)!=null&&p.arguments&&(u+=await this.getNumTokens(JSON.stringify(JSON.parse((m=d.additional_kwargs.function_call)==null?void 0:m.arguments)))),t+=u,u}));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(s){throw k0(s)}})}_getClientOptions(e){if(!this.client){const r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},s=Wv(r),a={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};a.baseURL||delete a.baseURL,this.client=new G(a)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}const D0="modulepreload",M0=function(n){return"/"+n},bu={},Fi=function(e,t,r){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),o=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));s=Promise.allSettled(t.map(c=>{if(c=M0(c),c in bu)return;bu[c]=!0;const l=c.endsWith(".css"),u=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${u}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":D0,l||(d.as="script"),d.crossOrigin="",d.href=c,o&&d.setAttribute("nonce",o),document.head.appendChild(d),l)return new Promise((h,f)=>{d.addEventListener("load",h),d.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${c}`)))})}))}function a(i){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=i,window.dispatchEvent(o),!o.defaultPrevented)throw i}return s.then(i=>{for(const o of i||[])o.status==="rejected"&&a(o.reason);return e().catch(a)})};class U0 extends Ne{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},r={};for(const[a,i]of Object.entries(t))typeof i=="string"?r[a]=i:r[a]=await i();return{...r,...e}}async invoke(e,t){return this._callWithConfig(r=>this.formatPromptValue(r),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await Fi(async()=>{const{PromptTemplate:r}=await Promise.resolve().then(()=>Eu);return{PromptTemplate:r}},void 0);return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await Fi(async()=>{const{PromptTemplate:r}=await Promise.resolve().then(()=>Eu);return{PromptTemplate:r}},void 0);return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await Fi(async()=>{const{FewShotPromptTemplate:r}=await import("./few_shot.js");return{FewShotPromptTemplate:r}},__vite__mapDeps([0,1,2]));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}class F0 extends U0{async formatPromptValue(e){const t=await this.format(e);return new ah(t)}}/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var B0=Object.prototype.toString,un=Array.isArray||function(e){return B0.call(e)==="[object Array]"};function Tc(n){return typeof n=="function"}function z0(n){return un(n)?"array":typeof n}function Bi(n){return n.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function wu(n,e){return n!=null&&typeof n=="object"&&e in n}function Z0(n,e){return n!=null&&typeof n!="object"&&n.hasOwnProperty&&n.hasOwnProperty(e)}var q0=RegExp.prototype.test;function V0(n,e){return q0.call(n,e)}var H0=/\S/;function G0(n){return!V0(H0,n)}var J0={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function K0(n){return String(n).replace(/[&<>"'`=\/]/g,function(t){return J0[t]})}var W0=/\s*/,X0=/\s+/,vu=/\s*=/,Y0=/\s*\}/,Q0=/#|\^|\/|>|\{|&|=|!/;function eE(n,e){if(!n)return[];var t=!1,r=[],s=[],a=[],i=!1,o=!1,c="",l=0;function u(){if(i&&!o)for(;a.length;)delete s[a.pop()];else a=[];i=!1,o=!1}var d,h,f;function g(Q){if(typeof Q=="string"&&(Q=Q.split(X0,2)),!un(Q)||Q.length!==2)throw new Error("Invalid tags: "+Q);d=new RegExp(Bi(Q[0])+"\\s*"),h=new RegExp("\\s*"+Bi(Q[1])),f=new RegExp("\\s*"+Bi("}"+Q[1]))}g(e||Xe.tags);for(var p=new _s(n),m,_,y,w,O,P;!p.eos();){if(m=p.pos,y=p.scanUntil(d),y)for(var k=0,$=y.length;k<$;++k)w=y.charAt(k),G0(w)?(a.push(s.length),c+=w):(o=!0,t=!0,c+=" "),s.push(["text",w,m,m+1]),m+=1,w===`
`&&(u(),c="",l=0,t=!1);if(!p.scan(d))break;if(i=!0,_=p.scan(Q0)||"name",p.scan(W0),_==="="?(y=p.scanUntil(vu),p.scan(vu),p.scanUntil(h)):_==="{"?(y=p.scanUntil(f),p.scan(Y0),p.scanUntil(h),_="&"):y=p.scanUntil(h),!p.scan(h))throw new Error("Unclosed tag at "+p.pos);if(_==">"?O=[_,y,m,p.pos,c,l,t]:O=[_,y,m,p.pos],l++,s.push(O),_==="#"||_==="^")r.push(O);else if(_==="/"){if(P=r.pop(),!P)throw new Error('Unopened section "'+y+'" at '+m);if(P[1]!==y)throw new Error('Unclosed section "'+P[1]+'" at '+m)}else _==="name"||_==="{"||_==="&"?o=!0:_==="="&&g(y)}if(u(),P=r.pop(),P)throw new Error('Unclosed section "'+P[1]+'" at '+p.pos);return rE(tE(s))}function tE(n){for(var e=[],t,r,s=0,a=n.length;s<a;++s)t=n[s],t&&(t[0]==="text"&&r&&r[0]==="text"?(r[1]+=t[1],r[3]=t[3]):(e.push(t),r=t));return e}function rE(n){for(var e=[],t=e,r=[],s,a,i=0,o=n.length;i<o;++i)switch(s=n[i],s[0]){case"#":case"^":t.push(s),r.push(s),t=s[4]=[];break;case"/":a=r.pop(),a[5]=s[2],t=r.length>0?r[r.length-1][4]:e;break;default:t.push(s)}return e}function _s(n){this.string=n,this.tail=n,this.pos=0}_s.prototype.eos=function(){return this.tail===""};_s.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var r=t[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r};_s.prototype.scanUntil=function(e){var t=this.tail.search(e),r;switch(t){case-1:r=this.tail,this.tail="";break;case 0:r="";break;default:r=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=r.length,r};function Qr(n,e){this.view=n,this.cache={".":this.view},this.parent=e}Qr.prototype.push=function(e){return new Qr(e,this)};Qr.prototype.lookup=function(e){var t=this.cache,r;if(t.hasOwnProperty(e))r=t[e];else{for(var s=this,a,i,o,c=!1;s;){if(e.indexOf(".")>0)for(a=s.view,i=e.split("."),o=0;a!=null&&o<i.length;)o===i.length-1&&(c=wu(a,i[o])||Z0(a,i[o])),a=a[i[o++]];else a=s.view[e],c=wu(s.view,e);if(c){r=a;break}s=s.parent}t[e]=r}return Tc(r)&&(r=r.call(this.view)),r};function Le(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}Le.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};Le.prototype.parse=function(e,t){var r=this.templateCache,s=e+":"+(t||Xe.tags).join(":"),a=typeof r<"u",i=a?r.get(s):void 0;return i==null&&(i=eE(e,t),a&&r.set(s,i)),i};Le.prototype.render=function(e,t,r,s){var a=this.getConfigTags(s),i=this.parse(e,a),o=t instanceof Qr?t:new Qr(t,void 0);return this.renderTokens(i,o,r,e,s)};Le.prototype.renderTokens=function(e,t,r,s,a){for(var i="",o,c,l,u=0,d=e.length;u<d;++u)l=void 0,o=e[u],c=o[0],c==="#"?l=this.renderSection(o,t,r,s,a):c==="^"?l=this.renderInverted(o,t,r,s,a):c===">"?l=this.renderPartial(o,t,r,a):c==="&"?l=this.unescapedValue(o,t):c==="name"?l=this.escapedValue(o,t,a):c==="text"&&(l=this.rawValue(o)),l!==void 0&&(i+=l);return i};Le.prototype.renderSection=function(e,t,r,s,a){var i=this,o="",c=t.lookup(e[1]);function l(h){return i.render(h,t,r,a)}if(c){if(un(c))for(var u=0,d=c.length;u<d;++u)o+=this.renderTokens(e[4],t.push(c[u]),r,s,a);else if(typeof c=="object"||typeof c=="string"||typeof c=="number")o+=this.renderTokens(e[4],t.push(c),r,s,a);else if(Tc(c)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");c=c.call(t.view,s.slice(e[3],e[5]),l),c!=null&&(o+=c)}else o+=this.renderTokens(e[4],t,r,s,a);return o}};Le.prototype.renderInverted=function(e,t,r,s,a){var i=t.lookup(e[1]);if(!i||un(i)&&i.length===0)return this.renderTokens(e[4],t,r,s,a)};Le.prototype.indentPartial=function(e,t,r){for(var s=t.replace(/[^ \t]/g,""),a=e.split(`
`),i=0;i<a.length;i++)a[i].length&&(i>0||!r)&&(a[i]=s+a[i]);return a.join(`
`)};Le.prototype.renderPartial=function(e,t,r,s){if(r){var a=this.getConfigTags(s),i=Tc(r)?r(e[1]):r[e[1]];if(i!=null){var o=e[6],c=e[5],l=e[4],u=i;c==0&&l&&(u=this.indentPartial(i,l,o));var d=this.parse(u,a);return this.renderTokens(d,t,r,u,s)}}};Le.prototype.unescapedValue=function(e,t){var r=t.lookup(e[1]);if(r!=null)return r};Le.prototype.escapedValue=function(e,t,r){var s=this.getConfigEscape(r)||Xe.escape,a=t.lookup(e[1]);if(a!=null)return typeof a=="number"&&s===Xe.escape?String(a):s(a)};Le.prototype.rawValue=function(e){return e[1]};Le.prototype.getConfigTags=function(e){return un(e)?e:e&&typeof e=="object"?e.tags:void 0};Le.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!un(e))return e.escape};var Xe={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(n){ns.templateCache=n},get templateCache(){return ns.templateCache}},ns=new Le;Xe.clearCache=function(){return ns.clearCache()};Xe.parse=function(e,t){return ns.parse(e,t)};Xe.render=function(e,t,r,s){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+z0(e)+'" was given as the first argument for mustache#render(template, view, partials)');return ns.render(e,t,r,s)};Xe.escape=K0;Xe.Scanner=_s;Xe.Context=Qr;Xe.Writer=Le;const Nf=n=>{const e=n.split(""),t=[],r=(a,i)=>{for(let o=i;o<e.length;o+=1)if(a.includes(e[o]))return o;return-1};let s=0;for(;s<e.length;)if(e[s]==="{"&&s+1<e.length&&e[s+1]==="{")t.push({type:"literal",text:"{"}),s+=2;else if(e[s]==="}"&&s+1<e.length&&e[s+1]==="}")t.push({type:"literal",text:"}"}),s+=2;else if(e[s]==="{"){const a=r("}",s);if(a<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(s+1,a).join("")}),s=a+1}else{if(e[s]==="}")throw new Error("Single '}' in template.");{const a=r("{}",s),i=(a<0?e.slice(s):e.slice(s,a)).join("");t.push({type:"literal",text:i}),s=a<0?e.length:a}}return t},nE=n=>n.map(e=>e[0]==="name"?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:e[0]==="#"?{type:"variable",name:e[1]}:{type:"literal",text:e[1]}),sE=n=>{const e=Xe.parse(n);return nE(e)},aE=(n,e)=>Nf(n).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`(f-string) Missing value for input ${r.name}`)}return t+r.text},""),iE=(n,e)=>Xe.render(n,e),mo={"f-string":aE,mustache:iE},oE={"f-string":Nf,mustache:sE},zn=(n,e,t)=>mo[e](n,t),cE=(n,e)=>oE[e](n),lE=(n,e,t)=>{if(!(e in mo)){const r=Object.keys(mo);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{const r=t.reduce((s,a)=>(s[a]="foo",s),{});Array.isArray(n)?n.forEach(s=>{if(s.type==="text")zn(s.text,e,r);else if(s.type==="image_url")if(typeof s.image_url=="string")zn(s.image_url,e,r);else{const a=s.image_url.url;zn(a,e,r)}else throw new Error(`Invalid message template received. ${JSON.stringify(s,null,2)}`)}):zn(n,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}};class ut extends F0{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),lE(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return zn(this.template,this.templateFormat,t)}static fromExamples(e,t,r,s=`

`,a=""){const i=[a,...e,t].join(s);return new ut({inputVariables:r,template:i})}static fromTemplate(e,t){const{templateFormat:r="f-string",...s}=t??{},a=new Set;return cE(e,r).forEach(i=>{i.type==="variable"&&a.add(i.name)}),new ut({inputVariables:[...a],templateFormat:r,template:e,...s})}async partial(e){const t=this.inputVariables.filter(a=>!(a in e)),r={...this.partialVariables??{},...e},s={...this,inputVariables:t,partialVariables:r};return new ut(s)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new ut({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}const Eu=Object.freeze(Object.defineProperty({__proto__:null,PromptTemplate:ut},Symbol.toStringTag,{value:"Module"})),go={OPENAI_API_KEY:"earth_agent_openai_api_key",SETTINGS:"earth_agent_settings"},uE=async n=>{try{console.log("Saving API key to Chrome storage, length:",n.length),await chrome.storage.sync.set({[go.OPENAI_API_KEY]:n}),console.log("API key saved successfully")}catch(e){throw console.error("Error saving API key:",e),new Error("Failed to save API key")}},yr=async()=>{try{console.log("Retrieving API key from Chrome storage...");const e=(await chrome.storage.sync.get([go.OPENAI_API_KEY]))[go.OPENAI_API_KEY]||null;return console.log("API key retrieved from storage:",e?`length: ${e.length}`:"not found"),e}catch(n){return console.error("Error retrieving API key:",n),null}},jf=async()=>{const e=!!await yr();return console.log("API key is set:",e),e};function Lf(n,e){return function(){return n.apply(e,arguments)}}const{toString:dE}=Object.prototype,{getPrototypeOf:Ic}=Object,ri=(n=>e=>{const t=dE.call(e);return n[t]||(n[t]=t.slice(8,-1).toLowerCase())})(Object.create(null)),mt=n=>(n=n.toLowerCase(),e=>ri(e)===n),ni=n=>e=>typeof e===n,{isArray:dn}=Array,ss=ni("undefined");function hE(n){return n!==null&&!ss(n)&&n.constructor!==null&&!ss(n.constructor)&&Ke(n.constructor.isBuffer)&&n.constructor.isBuffer(n)}const Df=mt("ArrayBuffer");function fE(n){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(n):e=n&&n.buffer&&Df(n.buffer),e}const pE=ni("string"),Ke=ni("function"),Mf=ni("number"),si=n=>n!==null&&typeof n=="object",mE=n=>n===!0||n===!1,Vs=n=>{if(ri(n)!=="object")return!1;const e=Ic(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)},gE=mt("Date"),yE=mt("File"),_E=mt("Blob"),bE=mt("FileList"),wE=n=>si(n)&&Ke(n.pipe),vE=n=>{let e;return n&&(typeof FormData=="function"&&n instanceof FormData||Ke(n.append)&&((e=ri(n))==="formdata"||e==="object"&&Ke(n.toString)&&n.toString()==="[object FormData]"))},EE=mt("URLSearchParams"),[AE,OE,SE,PE]=["ReadableStream","Request","Response","Headers"].map(mt),xE=n=>n.trim?n.trim():n.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function bs(n,e,{allOwnKeys:t=!1}={}){if(n===null||typeof n>"u")return;let r,s;if(typeof n!="object"&&(n=[n]),dn(n))for(r=0,s=n.length;r<s;r++)e.call(null,n[r],r,n);else{const a=t?Object.getOwnPropertyNames(n):Object.keys(n),i=a.length;let o;for(r=0;r<i;r++)o=a[r],e.call(null,n[o],o,n)}}function Uf(n,e){e=e.toLowerCase();const t=Object.keys(n);let r=t.length,s;for(;r-- >0;)if(s=t[r],e===s.toLowerCase())return s;return null}const cr=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,Ff=n=>!ss(n)&&n!==cr;function yo(){const{caseless:n}=Ff(this)&&this||{},e={},t=(r,s)=>{const a=n&&Uf(e,s)||s;Vs(e[a])&&Vs(r)?e[a]=yo(e[a],r):Vs(r)?e[a]=yo({},r):dn(r)?e[a]=r.slice():e[a]=r};for(let r=0,s=arguments.length;r<s;r++)arguments[r]&&bs(arguments[r],t);return e}const RE=(n,e,t,{allOwnKeys:r}={})=>(bs(e,(s,a)=>{t&&Ke(s)?n[a]=Lf(s,t):n[a]=s},{allOwnKeys:r}),n),TE=n=>(n.charCodeAt(0)===65279&&(n=n.slice(1)),n),IE=(n,e,t,r)=>{n.prototype=Object.create(e.prototype,r),n.prototype.constructor=n,Object.defineProperty(n,"super",{value:e.prototype}),t&&Object.assign(n.prototype,t)},kE=(n,e,t,r)=>{let s,a,i;const o={};if(e=e||{},n==null)return e;do{for(s=Object.getOwnPropertyNames(n),a=s.length;a-- >0;)i=s[a],(!r||r(i,n,e))&&!o[i]&&(e[i]=n[i],o[i]=!0);n=t!==!1&&Ic(n)}while(n&&(!t||t(n,e))&&n!==Object.prototype);return e},CE=(n,e,t)=>{n=String(n),(t===void 0||t>n.length)&&(t=n.length),t-=e.length;const r=n.indexOf(e,t);return r!==-1&&r===t},$E=n=>{if(!n)return null;if(dn(n))return n;let e=n.length;if(!Mf(e))return null;const t=new Array(e);for(;e-- >0;)t[e]=n[e];return t},NE=(n=>e=>n&&e instanceof n)(typeof Uint8Array<"u"&&Ic(Uint8Array)),jE=(n,e)=>{const r=(n&&n[Symbol.iterator]).call(n);let s;for(;(s=r.next())&&!s.done;){const a=s.value;e.call(n,a[0],a[1])}},LE=(n,e)=>{let t;const r=[];for(;(t=n.exec(e))!==null;)r.push(t);return r},DE=mt("HTMLFormElement"),ME=n=>n.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,r,s){return r.toUpperCase()+s}),Au=(({hasOwnProperty:n})=>(e,t)=>n.call(e,t))(Object.prototype),UE=mt("RegExp"),Bf=(n,e)=>{const t=Object.getOwnPropertyDescriptors(n),r={};bs(t,(s,a)=>{let i;(i=e(s,a,n))!==!1&&(r[a]=i||s)}),Object.defineProperties(n,r)},FE=n=>{Bf(n,(e,t)=>{if(Ke(n)&&["arguments","caller","callee"].indexOf(t)!==-1)return!1;const r=n[t];if(Ke(r)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+t+"'")})}})},BE=(n,e)=>{const t={},r=s=>{s.forEach(a=>{t[a]=!0})};return dn(n)?r(n):r(String(n).split(e)),t},zE=()=>{},ZE=(n,e)=>n!=null&&Number.isFinite(n=+n)?n:e;function qE(n){return!!(n&&Ke(n.append)&&n[Symbol.toStringTag]==="FormData"&&n[Symbol.iterator])}const VE=n=>{const e=new Array(10),t=(r,s)=>{if(si(r)){if(e.indexOf(r)>=0)return;if(!("toJSON"in r)){e[s]=r;const a=dn(r)?[]:{};return bs(r,(i,o)=>{const c=t(i,s+1);!ss(c)&&(a[o]=c)}),e[s]=void 0,a}}return r};return t(n,0)},HE=mt("AsyncFunction"),GE=n=>n&&(si(n)||Ke(n))&&Ke(n.then)&&Ke(n.catch),zf=((n,e)=>n?setImmediate:e?((t,r)=>(cr.addEventListener("message",({source:s,data:a})=>{s===cr&&a===t&&r.length&&r.shift()()},!1),s=>{r.push(s),cr.postMessage(t,"*")}))(`axios@${Math.random()}`,[]):t=>setTimeout(t))(typeof setImmediate=="function",Ke(cr.postMessage)),JE=typeof queueMicrotask<"u"?queueMicrotask.bind(cr):typeof process<"u"&&process.nextTick||zf,b={isArray:dn,isArrayBuffer:Df,isBuffer:hE,isFormData:vE,isArrayBufferView:fE,isString:pE,isNumber:Mf,isBoolean:mE,isObject:si,isPlainObject:Vs,isReadableStream:AE,isRequest:OE,isResponse:SE,isHeaders:PE,isUndefined:ss,isDate:gE,isFile:yE,isBlob:_E,isRegExp:UE,isFunction:Ke,isStream:wE,isURLSearchParams:EE,isTypedArray:NE,isFileList:bE,forEach:bs,merge:yo,extend:RE,trim:xE,stripBOM:TE,inherits:IE,toFlatObject:kE,kindOf:ri,kindOfTest:mt,endsWith:CE,toArray:$E,forEachEntry:jE,matchAll:LE,isHTMLForm:DE,hasOwnProperty:Au,hasOwnProp:Au,reduceDescriptors:Bf,freezeMethods:FE,toObjectSet:BE,toCamelCase:ME,noop:zE,toFiniteNumber:ZE,findKey:Uf,global:cr,isContextDefined:Ff,isSpecCompliantForm:qE,toJSONObject:VE,isAsyncFn:HE,isThenable:GE,setImmediate:zf,asap:JE};function V(n,e,t,r,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=n,this.name="AxiosError",e&&(this.code=e),t&&(this.config=t),r&&(this.request=r),s&&(this.response=s,this.status=s.status?s.status:null)}b.inherits(V,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:b.toJSONObject(this.config),code:this.code,status:this.status}}});const Zf=V.prototype,qf={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(n=>{qf[n]={value:n}});Object.defineProperties(V,qf);Object.defineProperty(Zf,"isAxiosError",{value:!0});V.from=(n,e,t,r,s,a)=>{const i=Object.create(Zf);return b.toFlatObject(n,i,function(c){return c!==Error.prototype},o=>o!=="isAxiosError"),V.call(i,n.message,e,t,r,s),i.cause=n,i.name=n.name,a&&Object.assign(i,a),i};const KE=null;function _o(n){return b.isPlainObject(n)||b.isArray(n)}function Vf(n){return b.endsWith(n,"[]")?n.slice(0,-2):n}function Ou(n,e,t){return n?n.concat(e).map(function(s,a){return s=Vf(s),!t&&a?"["+s+"]":s}).join(t?".":""):e}function WE(n){return b.isArray(n)&&!n.some(_o)}const XE=b.toFlatObject(b,{},null,function(e){return/^is[A-Z]/.test(e)});function ai(n,e,t){if(!b.isObject(n))throw new TypeError("target must be an object");e=e||new FormData,t=b.toFlatObject(t,{metaTokens:!0,dots:!1,indexes:!1},!1,function(p,m){return!b.isUndefined(m[p])});const r=t.metaTokens,s=t.visitor||u,a=t.dots,i=t.indexes,c=(t.Blob||typeof Blob<"u"&&Blob)&&b.isSpecCompliantForm(e);if(!b.isFunction(s))throw new TypeError("visitor must be a function");function l(g){if(g===null)return"";if(b.isDate(g))return g.toISOString();if(!c&&b.isBlob(g))throw new V("Blob is not supported. Use a Buffer instead.");return b.isArrayBuffer(g)||b.isTypedArray(g)?c&&typeof Blob=="function"?new Blob([g]):Buffer.from(g):g}function u(g,p,m){let _=g;if(g&&!m&&typeof g=="object"){if(b.endsWith(p,"{}"))p=r?p:p.slice(0,-2),g=JSON.stringify(g);else if(b.isArray(g)&&WE(g)||(b.isFileList(g)||b.endsWith(p,"[]"))&&(_=b.toArray(g)))return p=Vf(p),_.forEach(function(w,O){!(b.isUndefined(w)||w===null)&&e.append(i===!0?Ou([p],O,a):i===null?p:p+"[]",l(w))}),!1}return _o(g)?!0:(e.append(Ou(m,p,a),l(g)),!1)}const d=[],h=Object.assign(XE,{defaultVisitor:u,convertValue:l,isVisitable:_o});function f(g,p){if(!b.isUndefined(g)){if(d.indexOf(g)!==-1)throw Error("Circular reference detected in "+p.join("."));d.push(g),b.forEach(g,function(_,y){(!(b.isUndefined(_)||_===null)&&s.call(e,_,b.isString(y)?y.trim():y,p,h))===!0&&f(_,p?p.concat(y):[y])}),d.pop()}}if(!b.isObject(n))throw new TypeError("data must be an object");return f(n),e}function Su(n){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(n).replace(/[!'()~]|%20|%00/g,function(r){return e[r]})}function kc(n,e){this._pairs=[],n&&ai(n,this,e)}const Hf=kc.prototype;Hf.append=function(e,t){this._pairs.push([e,t])};Hf.toString=function(e){const t=e?function(r){return e.call(this,r,Su)}:Su;return this._pairs.map(function(s){return t(s[0])+"="+t(s[1])},"").join("&")};function YE(n){return encodeURIComponent(n).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Gf(n,e,t){if(!e)return n;const r=t&&t.encode||YE;b.isFunction(t)&&(t={serialize:t});const s=t&&t.serialize;let a;if(s?a=s(e,t):a=b.isURLSearchParams(e)?e.toString():new kc(e,t).toString(r),a){const i=n.indexOf("#");i!==-1&&(n=n.slice(0,i)),n+=(n.indexOf("?")===-1?"?":"&")+a}return n}class Pu{constructor(){this.handlers=[]}use(e,t,r){return this.handlers.push({fulfilled:e,rejected:t,synchronous:r?r.synchronous:!1,runWhen:r?r.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){b.forEach(this.handlers,function(r){r!==null&&e(r)})}}const Jf={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},QE=typeof URLSearchParams<"u"?URLSearchParams:kc,eA=typeof FormData<"u"?FormData:null,tA=typeof Blob<"u"?Blob:null,rA={isBrowser:!0,classes:{URLSearchParams:QE,FormData:eA,Blob:tA},protocols:["http","https","file","blob","url","data"]},Cc=typeof window<"u"&&typeof document<"u",bo=typeof navigator=="object"&&navigator||void 0,nA=Cc&&(!bo||["ReactNative","NativeScript","NS"].indexOf(bo.product)<0),sA=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",aA=Cc&&window.location.href||"http://localhost",iA=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:Cc,hasStandardBrowserEnv:nA,hasStandardBrowserWebWorkerEnv:sA,navigator:bo,origin:aA},Symbol.toStringTag,{value:"Module"})),Re={...iA,...rA};function oA(n,e){return ai(n,new Re.classes.URLSearchParams,Object.assign({visitor:function(t,r,s,a){return Re.isNode&&b.isBuffer(t)?(this.append(r,t.toString("base64")),!1):a.defaultVisitor.apply(this,arguments)}},e))}function cA(n){return b.matchAll(/\w+|\[(\w*)]/g,n).map(e=>e[0]==="[]"?"":e[1]||e[0])}function lA(n){const e={},t=Object.keys(n);let r;const s=t.length;let a;for(r=0;r<s;r++)a=t[r],e[a]=n[a];return e}function Kf(n){function e(t,r,s,a){let i=t[a++];if(i==="__proto__")return!0;const o=Number.isFinite(+i),c=a>=t.length;return i=!i&&b.isArray(s)?s.length:i,c?(b.hasOwnProp(s,i)?s[i]=[s[i],r]:s[i]=r,!o):((!s[i]||!b.isObject(s[i]))&&(s[i]=[]),e(t,r,s[i],a)&&b.isArray(s[i])&&(s[i]=lA(s[i])),!o)}if(b.isFormData(n)&&b.isFunction(n.entries)){const t={};return b.forEachEntry(n,(r,s)=>{e(cA(r),s,t,0)}),t}return null}function uA(n,e,t){if(b.isString(n))try{return(e||JSON.parse)(n),b.trim(n)}catch(r){if(r.name!=="SyntaxError")throw r}return(t||JSON.stringify)(n)}const ws={transitional:Jf,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const r=t.getContentType()||"",s=r.indexOf("application/json")>-1,a=b.isObject(e);if(a&&b.isHTMLForm(e)&&(e=new FormData(e)),b.isFormData(e))return s?JSON.stringify(Kf(e)):e;if(b.isArrayBuffer(e)||b.isBuffer(e)||b.isStream(e)||b.isFile(e)||b.isBlob(e)||b.isReadableStream(e))return e;if(b.isArrayBufferView(e))return e.buffer;if(b.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(a){if(r.indexOf("application/x-www-form-urlencoded")>-1)return oA(e,this.formSerializer).toString();if((o=b.isFileList(e))||r.indexOf("multipart/form-data")>-1){const c=this.env&&this.env.FormData;return ai(o?{"files[]":e}:e,c&&new c,this.formSerializer)}}return a||s?(t.setContentType("application/json",!1),uA(e)):e}],transformResponse:[function(e){const t=this.transitional||ws.transitional,r=t&&t.forcedJSONParsing,s=this.responseType==="json";if(b.isResponse(e)||b.isReadableStream(e))return e;if(e&&b.isString(e)&&(r&&!this.responseType||s)){const i=!(t&&t.silentJSONParsing)&&s;try{return JSON.parse(e)}catch(o){if(i)throw o.name==="SyntaxError"?V.from(o,V.ERR_BAD_RESPONSE,this,null,this.response):o}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Re.classes.FormData,Blob:Re.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};b.forEach(["delete","get","head","post","put","patch"],n=>{ws.headers[n]={}});const dA=b.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),hA=n=>{const e={};let t,r,s;return n&&n.split(`
`).forEach(function(i){s=i.indexOf(":"),t=i.substring(0,s).trim().toLowerCase(),r=i.substring(s+1).trim(),!(!t||e[t]&&dA[t])&&(t==="set-cookie"?e[t]?e[t].push(r):e[t]=[r]:e[t]=e[t]?e[t]+", "+r:r)}),e},xu=Symbol("internals");function Cn(n){return n&&String(n).trim().toLowerCase()}function Hs(n){return n===!1||n==null?n:b.isArray(n)?n.map(Hs):String(n)}function fA(n){const e=Object.create(null),t=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let r;for(;r=t.exec(n);)e[r[1]]=r[2];return e}const pA=n=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(n.trim());function zi(n,e,t,r,s){if(b.isFunction(r))return r.call(this,e,t);if(s&&(e=t),!!b.isString(e)){if(b.isString(r))return e.indexOf(r)!==-1;if(b.isRegExp(r))return r.test(e)}}function mA(n){return n.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,t,r)=>t.toUpperCase()+r)}function gA(n,e){const t=b.toCamelCase(" "+e);["get","set","has"].forEach(r=>{Object.defineProperty(n,r+t,{value:function(s,a,i){return this[r].call(this,e,s,a,i)},configurable:!0})})}let ze=class{constructor(e){e&&this.set(e)}set(e,t,r){const s=this;function a(o,c,l){const u=Cn(c);if(!u)throw new Error("header name must be a non-empty string");const d=b.findKey(s,u);(!d||s[d]===void 0||l===!0||l===void 0&&s[d]!==!1)&&(s[d||c]=Hs(o))}const i=(o,c)=>b.forEach(o,(l,u)=>a(l,u,c));if(b.isPlainObject(e)||e instanceof this.constructor)i(e,t);else if(b.isString(e)&&(e=e.trim())&&!pA(e))i(hA(e),t);else if(b.isHeaders(e))for(const[o,c]of e.entries())a(c,o,r);else e!=null&&a(t,e,r);return this}get(e,t){if(e=Cn(e),e){const r=b.findKey(this,e);if(r){const s=this[r];if(!t)return s;if(t===!0)return fA(s);if(b.isFunction(t))return t.call(this,s,r);if(b.isRegExp(t))return t.exec(s);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=Cn(e),e){const r=b.findKey(this,e);return!!(r&&this[r]!==void 0&&(!t||zi(this,this[r],r,t)))}return!1}delete(e,t){const r=this;let s=!1;function a(i){if(i=Cn(i),i){const o=b.findKey(r,i);o&&(!t||zi(r,r[o],o,t))&&(delete r[o],s=!0)}}return b.isArray(e)?e.forEach(a):a(e),s}clear(e){const t=Object.keys(this);let r=t.length,s=!1;for(;r--;){const a=t[r];(!e||zi(this,this[a],a,e,!0))&&(delete this[a],s=!0)}return s}normalize(e){const t=this,r={};return b.forEach(this,(s,a)=>{const i=b.findKey(r,a);if(i){t[i]=Hs(s),delete t[a];return}const o=e?mA(a):String(a).trim();o!==a&&delete t[a],t[o]=Hs(s),r[o]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return b.forEach(this,(r,s)=>{r!=null&&r!==!1&&(t[s]=e&&b.isArray(r)?r.join(", "):r)}),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,t])=>e+": "+t).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const r=new this(e);return t.forEach(s=>r.set(s)),r}static accessor(e){const r=(this[xu]=this[xu]={accessors:{}}).accessors,s=this.prototype;function a(i){const o=Cn(i);r[o]||(gA(s,i),r[o]=!0)}return b.isArray(e)?e.forEach(a):a(e),this}};ze.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);b.reduceDescriptors(ze.prototype,({value:n},e)=>{let t=e[0].toUpperCase()+e.slice(1);return{get:()=>n,set(r){this[t]=r}}});b.freezeMethods(ze);function Zi(n,e){const t=this||ws,r=e||t,s=ze.from(r.headers);let a=r.data;return b.forEach(n,function(o){a=o.call(t,a,s.normalize(),e?e.status:void 0)}),s.normalize(),a}function Wf(n){return!!(n&&n.__CANCEL__)}function hn(n,e,t){V.call(this,n??"canceled",V.ERR_CANCELED,e,t),this.name="CanceledError"}b.inherits(hn,V,{__CANCEL__:!0});function Xf(n,e,t){const r=t.config.validateStatus;!t.status||!r||r(t.status)?n(t):e(new V("Request failed with status code "+t.status,[V.ERR_BAD_REQUEST,V.ERR_BAD_RESPONSE][Math.floor(t.status/100)-4],t.config,t.request,t))}function yA(n){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(n);return e&&e[1]||""}function _A(n,e){n=n||10;const t=new Array(n),r=new Array(n);let s=0,a=0,i;return e=e!==void 0?e:1e3,function(c){const l=Date.now(),u=r[a];i||(i=l),t[s]=c,r[s]=l;let d=a,h=0;for(;d!==s;)h+=t[d++],d=d%n;if(s=(s+1)%n,s===a&&(a=(a+1)%n),l-i<e)return;const f=u&&l-u;return f?Math.round(h*1e3/f):void 0}}function bA(n,e){let t=0,r=1e3/e,s,a;const i=(l,u=Date.now())=>{t=u,s=null,a&&(clearTimeout(a),a=null),n.apply(null,l)};return[(...l)=>{const u=Date.now(),d=u-t;d>=r?i(l,u):(s=l,a||(a=setTimeout(()=>{a=null,i(s)},r-d)))},()=>s&&i(s)]}const pa=(n,e,t=3)=>{let r=0;const s=_A(50,250);return bA(a=>{const i=a.loaded,o=a.lengthComputable?a.total:void 0,c=i-r,l=s(c),u=i<=o;r=i;const d={loaded:i,total:o,progress:o?i/o:void 0,bytes:c,rate:l||void 0,estimated:l&&o&&u?(o-i)/l:void 0,event:a,lengthComputable:o!=null,[e?"download":"upload"]:!0};n(d)},t)},Ru=(n,e)=>{const t=n!=null;return[r=>e[0]({lengthComputable:t,total:n,loaded:r}),e[1]]},Tu=n=>(...e)=>b.asap(()=>n(...e)),wA=Re.hasStandardBrowserEnv?((n,e)=>t=>(t=new URL(t,Re.origin),n.protocol===t.protocol&&n.host===t.host&&(e||n.port===t.port)))(new URL(Re.origin),Re.navigator&&/(msie|trident)/i.test(Re.navigator.userAgent)):()=>!0,vA=Re.hasStandardBrowserEnv?{write(n,e,t,r,s,a){const i=[n+"="+encodeURIComponent(e)];b.isNumber(t)&&i.push("expires="+new Date(t).toGMTString()),b.isString(r)&&i.push("path="+r),b.isString(s)&&i.push("domain="+s),a===!0&&i.push("secure"),document.cookie=i.join("; ")},read(n){const e=document.cookie.match(new RegExp("(^|;\\s*)("+n+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(n){this.write(n,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function EA(n){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)}function AA(n,e){return e?n.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):n}function Yf(n,e,t){let r=!EA(e);return n&&(r||t==!1)?AA(n,e):e}const Iu=n=>n instanceof ze?{...n}:n;function gr(n,e){e=e||{};const t={};function r(l,u,d,h){return b.isPlainObject(l)&&b.isPlainObject(u)?b.merge.call({caseless:h},l,u):b.isPlainObject(u)?b.merge({},u):b.isArray(u)?u.slice():u}function s(l,u,d,h){if(b.isUndefined(u)){if(!b.isUndefined(l))return r(void 0,l,d,h)}else return r(l,u,d,h)}function a(l,u){if(!b.isUndefined(u))return r(void 0,u)}function i(l,u){if(b.isUndefined(u)){if(!b.isUndefined(l))return r(void 0,l)}else return r(void 0,u)}function o(l,u,d){if(d in e)return r(l,u);if(d in n)return r(void 0,l)}const c={url:a,method:a,data:a,baseURL:i,transformRequest:i,transformResponse:i,paramsSerializer:i,timeout:i,timeoutMessage:i,withCredentials:i,withXSRFToken:i,adapter:i,responseType:i,xsrfCookieName:i,xsrfHeaderName:i,onUploadProgress:i,onDownloadProgress:i,decompress:i,maxContentLength:i,maxBodyLength:i,beforeRedirect:i,transport:i,httpAgent:i,httpsAgent:i,cancelToken:i,socketPath:i,responseEncoding:i,validateStatus:o,headers:(l,u,d)=>s(Iu(l),Iu(u),d,!0)};return b.forEach(Object.keys(Object.assign({},n,e)),function(u){const d=c[u]||s,h=d(n[u],e[u],u);b.isUndefined(h)&&d!==o||(t[u]=h)}),t}const Qf=n=>{const e=gr({},n);let{data:t,withXSRFToken:r,xsrfHeaderName:s,xsrfCookieName:a,headers:i,auth:o}=e;e.headers=i=ze.from(i),e.url=Gf(Yf(e.baseURL,e.url,e.allowAbsoluteUrls),n.params,n.paramsSerializer),o&&i.set("Authorization","Basic "+btoa((o.username||"")+":"+(o.password?unescape(encodeURIComponent(o.password)):"")));let c;if(b.isFormData(t)){if(Re.hasStandardBrowserEnv||Re.hasStandardBrowserWebWorkerEnv)i.setContentType(void 0);else if((c=i.getContentType())!==!1){const[l,...u]=c?c.split(";").map(d=>d.trim()).filter(Boolean):[];i.setContentType([l||"multipart/form-data",...u].join("; "))}}if(Re.hasStandardBrowserEnv&&(r&&b.isFunction(r)&&(r=r(e)),r||r!==!1&&wA(e.url))){const l=s&&a&&vA.read(a);l&&i.set(s,l)}return e},OA=typeof XMLHttpRequest<"u",SA=OA&&function(n){return new Promise(function(t,r){const s=Qf(n);let a=s.data;const i=ze.from(s.headers).normalize();let{responseType:o,onUploadProgress:c,onDownloadProgress:l}=s,u,d,h,f,g;function p(){f&&f(),g&&g(),s.cancelToken&&s.cancelToken.unsubscribe(u),s.signal&&s.signal.removeEventListener("abort",u)}let m=new XMLHttpRequest;m.open(s.method.toUpperCase(),s.url,!0),m.timeout=s.timeout;function _(){if(!m)return;const w=ze.from("getAllResponseHeaders"in m&&m.getAllResponseHeaders()),P={data:!o||o==="text"||o==="json"?m.responseText:m.response,status:m.status,statusText:m.statusText,headers:w,config:n,request:m};Xf(function($){t($),p()},function($){r($),p()},P),m=null}"onloadend"in m?m.onloadend=_:m.onreadystatechange=function(){!m||m.readyState!==4||m.status===0&&!(m.responseURL&&m.responseURL.indexOf("file:")===0)||setTimeout(_)},m.onabort=function(){m&&(r(new V("Request aborted",V.ECONNABORTED,n,m)),m=null)},m.onerror=function(){r(new V("Network Error",V.ERR_NETWORK,n,m)),m=null},m.ontimeout=function(){let O=s.timeout?"timeout of "+s.timeout+"ms exceeded":"timeout exceeded";const P=s.transitional||Jf;s.timeoutErrorMessage&&(O=s.timeoutErrorMessage),r(new V(O,P.clarifyTimeoutError?V.ETIMEDOUT:V.ECONNABORTED,n,m)),m=null},a===void 0&&i.setContentType(null),"setRequestHeader"in m&&b.forEach(i.toJSON(),function(O,P){m.setRequestHeader(P,O)}),b.isUndefined(s.withCredentials)||(m.withCredentials=!!s.withCredentials),o&&o!=="json"&&(m.responseType=s.responseType),l&&([h,g]=pa(l,!0),m.addEventListener("progress",h)),c&&m.upload&&([d,f]=pa(c),m.upload.addEventListener("progress",d),m.upload.addEventListener("loadend",f)),(s.cancelToken||s.signal)&&(u=w=>{m&&(r(!w||w.type?new hn(null,n,m):w),m.abort(),m=null)},s.cancelToken&&s.cancelToken.subscribe(u),s.signal&&(s.signal.aborted?u():s.signal.addEventListener("abort",u)));const y=yA(s.url);if(y&&Re.protocols.indexOf(y)===-1){r(new V("Unsupported protocol "+y+":",V.ERR_BAD_REQUEST,n));return}m.send(a||null)})},PA=(n,e)=>{const{length:t}=n=n?n.filter(Boolean):[];if(e||t){let r=new AbortController,s;const a=function(l){if(!s){s=!0,o();const u=l instanceof Error?l:this.reason;r.abort(u instanceof V?u:new hn(u instanceof Error?u.message:u))}};let i=e&&setTimeout(()=>{i=null,a(new V(`timeout ${e} of ms exceeded`,V.ETIMEDOUT))},e);const o=()=>{n&&(i&&clearTimeout(i),i=null,n.forEach(l=>{l.unsubscribe?l.unsubscribe(a):l.removeEventListener("abort",a)}),n=null)};n.forEach(l=>l.addEventListener("abort",a));const{signal:c}=r;return c.unsubscribe=()=>b.asap(o),c}},xA=function*(n,e){let t=n.byteLength;if(t<e){yield n;return}let r=0,s;for(;r<t;)s=r+e,yield n.slice(r,s),r=s},RA=async function*(n,e){for await(const t of TA(n))yield*xA(t,e)},TA=async function*(n){if(n[Symbol.asyncIterator]){yield*n;return}const e=n.getReader();try{for(;;){const{done:t,value:r}=await e.read();if(t)break;yield r}}finally{await e.cancel()}},ku=(n,e,t,r)=>{const s=RA(n,e);let a=0,i,o=c=>{i||(i=!0,r&&r(c))};return new ReadableStream({async pull(c){try{const{done:l,value:u}=await s.next();if(l){o(),c.close();return}let d=u.byteLength;if(t){let h=a+=d;t(h)}c.enqueue(new Uint8Array(u))}catch(l){throw o(l),l}},cancel(c){return o(c),s.return()}},{highWaterMark:2})},ii=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",ep=ii&&typeof ReadableStream=="function",IA=ii&&(typeof TextEncoder=="function"?(n=>e=>n.encode(e))(new TextEncoder):async n=>new Uint8Array(await new Response(n).arrayBuffer())),tp=(n,...e)=>{try{return!!n(...e)}catch{return!1}},kA=ep&&tp(()=>{let n=!1;const e=new Request(Re.origin,{body:new ReadableStream,method:"POST",get duplex(){return n=!0,"half"}}).headers.has("Content-Type");return n&&!e}),Cu=64*1024,wo=ep&&tp(()=>b.isReadableStream(new Response("").body)),ma={stream:wo&&(n=>n.body)};ii&&(n=>{["text","arrayBuffer","blob","formData","stream"].forEach(e=>{!ma[e]&&(ma[e]=b.isFunction(n[e])?t=>t[e]():(t,r)=>{throw new V(`Response type '${e}' is not supported`,V.ERR_NOT_SUPPORT,r)})})})(new Response);const CA=async n=>{if(n==null)return 0;if(b.isBlob(n))return n.size;if(b.isSpecCompliantForm(n))return(await new Request(Re.origin,{method:"POST",body:n}).arrayBuffer()).byteLength;if(b.isArrayBufferView(n)||b.isArrayBuffer(n))return n.byteLength;if(b.isURLSearchParams(n)&&(n=n+""),b.isString(n))return(await IA(n)).byteLength},$A=async(n,e)=>{const t=b.toFiniteNumber(n.getContentLength());return t??CA(e)},NA=ii&&(async n=>{let{url:e,method:t,data:r,signal:s,cancelToken:a,timeout:i,onDownloadProgress:o,onUploadProgress:c,responseType:l,headers:u,withCredentials:d="same-origin",fetchOptions:h}=Qf(n);l=l?(l+"").toLowerCase():"text";let f=PA([s,a&&a.toAbortSignal()],i),g;const p=f&&f.unsubscribe&&(()=>{f.unsubscribe()});let m;try{if(c&&kA&&t!=="get"&&t!=="head"&&(m=await $A(u,r))!==0){let P=new Request(e,{method:"POST",body:r,duplex:"half"}),k;if(b.isFormData(r)&&(k=P.headers.get("content-type"))&&u.setContentType(k),P.body){const[$,Q]=Ru(m,pa(Tu(c)));r=ku(P.body,Cu,$,Q)}}b.isString(d)||(d=d?"include":"omit");const _="credentials"in Request.prototype;g=new Request(e,{...h,signal:f,method:t.toUpperCase(),headers:u.normalize().toJSON(),body:r,duplex:"half",credentials:_?d:void 0});let y=await fetch(g);const w=wo&&(l==="stream"||l==="response");if(wo&&(o||w&&p)){const P={};["status","statusText","headers"].forEach(re=>{P[re]=y[re]});const k=b.toFiniteNumber(y.headers.get("content-length")),[$,Q]=o&&Ru(k,pa(Tu(o),!0))||[];y=new Response(ku(y.body,Cu,$,()=>{Q&&Q(),p&&p()}),P)}l=l||"text";let O=await ma[b.findKey(ma,l)||"text"](y,n);return!w&&p&&p(),await new Promise((P,k)=>{Xf(P,k,{data:O,headers:ze.from(y.headers),status:y.status,statusText:y.statusText,config:n,request:g})})}catch(_){throw p&&p(),_&&_.name==="TypeError"&&/fetch/i.test(_.message)?Object.assign(new V("Network Error",V.ERR_NETWORK,n,g),{cause:_.cause||_}):V.from(_,_&&_.code,n,g)}}),vo={http:KE,xhr:SA,fetch:NA};b.forEach(vo,(n,e)=>{if(n){try{Object.defineProperty(n,"name",{value:e})}catch{}Object.defineProperty(n,"adapterName",{value:e})}});const $u=n=>`- ${n}`,jA=n=>b.isFunction(n)||n===null||n===!1,rp={getAdapter:n=>{n=b.isArray(n)?n:[n];const{length:e}=n;let t,r;const s={};for(let a=0;a<e;a++){t=n[a];let i;if(r=t,!jA(t)&&(r=vo[(i=String(t)).toLowerCase()],r===void 0))throw new V(`Unknown adapter '${i}'`);if(r)break;s[i||"#"+a]=r}if(!r){const a=Object.entries(s).map(([o,c])=>`adapter ${o} `+(c===!1?"is not supported by the environment":"is not available in the build"));let i=e?a.length>1?`since :
`+a.map($u).join(`
`):" "+$u(a[0]):"as no adapter specified";throw new V("There is no suitable adapter to dispatch the request "+i,"ERR_NOT_SUPPORT")}return r},adapters:vo};function qi(n){if(n.cancelToken&&n.cancelToken.throwIfRequested(),n.signal&&n.signal.aborted)throw new hn(null,n)}function Nu(n){return qi(n),n.headers=ze.from(n.headers),n.data=Zi.call(n,n.transformRequest),["post","put","patch"].indexOf(n.method)!==-1&&n.headers.setContentType("application/x-www-form-urlencoded",!1),rp.getAdapter(n.adapter||ws.adapter)(n).then(function(r){return qi(n),r.data=Zi.call(n,n.transformResponse,r),r.headers=ze.from(r.headers),r},function(r){return Wf(r)||(qi(n),r&&r.response&&(r.response.data=Zi.call(n,n.transformResponse,r.response),r.response.headers=ze.from(r.response.headers))),Promise.reject(r)})}const np="1.8.4",oi={};["object","boolean","number","function","string","symbol"].forEach((n,e)=>{oi[n]=function(r){return typeof r===n||"a"+(e<1?"n ":" ")+n}});const ju={};oi.transitional=function(e,t,r){function s(a,i){return"[Axios v"+np+"] Transitional option '"+a+"'"+i+(r?". "+r:"")}return(a,i,o)=>{if(e===!1)throw new V(s(i," has been removed"+(t?" in "+t:"")),V.ERR_DEPRECATED);return t&&!ju[i]&&(ju[i]=!0,console.warn(s(i," has been deprecated since v"+t+" and will be removed in the near future"))),e?e(a,i,o):!0}};oi.spelling=function(e){return(t,r)=>(console.warn(`${r} is likely a misspelling of ${e}`),!0)};function LA(n,e,t){if(typeof n!="object")throw new V("options must be an object",V.ERR_BAD_OPTION_VALUE);const r=Object.keys(n);let s=r.length;for(;s-- >0;){const a=r[s],i=e[a];if(i){const o=n[a],c=o===void 0||i(o,a,n);if(c!==!0)throw new V("option "+a+" must be "+c,V.ERR_BAD_OPTION_VALUE);continue}if(t!==!0)throw new V("Unknown option "+a,V.ERR_BAD_OPTION)}}const Gs={assertOptions:LA,validators:oi},_t=Gs.validators;let dr=class{constructor(e){this.defaults=e,this.interceptors={request:new Pu,response:new Pu}}async request(e,t){try{return await this._request(e,t)}catch(r){if(r instanceof Error){let s={};Error.captureStackTrace?Error.captureStackTrace(s):s=new Error;const a=s.stack?s.stack.replace(/^.+\n/,""):"";try{r.stack?a&&!String(r.stack).endsWith(a.replace(/^.+\n.+\n/,""))&&(r.stack+=`
`+a):r.stack=a}catch{}}throw r}}_request(e,t){typeof e=="string"?(t=t||{},t.url=e):t=e||{},t=gr(this.defaults,t);const{transitional:r,paramsSerializer:s,headers:a}=t;r!==void 0&&Gs.assertOptions(r,{silentJSONParsing:_t.transitional(_t.boolean),forcedJSONParsing:_t.transitional(_t.boolean),clarifyTimeoutError:_t.transitional(_t.boolean)},!1),s!=null&&(b.isFunction(s)?t.paramsSerializer={serialize:s}:Gs.assertOptions(s,{encode:_t.function,serialize:_t.function},!0)),t.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),Gs.assertOptions(t,{baseUrl:_t.spelling("baseURL"),withXsrfToken:_t.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let i=a&&b.merge(a.common,a[t.method]);a&&b.forEach(["delete","get","head","post","put","patch","common"],g=>{delete a[g]}),t.headers=ze.concat(i,a);const o=[];let c=!0;this.interceptors.request.forEach(function(p){typeof p.runWhen=="function"&&p.runWhen(t)===!1||(c=c&&p.synchronous,o.unshift(p.fulfilled,p.rejected))});const l=[];this.interceptors.response.forEach(function(p){l.push(p.fulfilled,p.rejected)});let u,d=0,h;if(!c){const g=[Nu.bind(this),void 0];for(g.unshift.apply(g,o),g.push.apply(g,l),h=g.length,u=Promise.resolve(t);d<h;)u=u.then(g[d++],g[d++]);return u}h=o.length;let f=t;for(d=0;d<h;){const g=o[d++],p=o[d++];try{f=g(f)}catch(m){p.call(this,m);break}}try{u=Nu.call(this,f)}catch(g){return Promise.reject(g)}for(d=0,h=l.length;d<h;)u=u.then(l[d++],l[d++]);return u}getUri(e){e=gr(this.defaults,e);const t=Yf(e.baseURL,e.url,e.allowAbsoluteUrls);return Gf(t,e.params,e.paramsSerializer)}};b.forEach(["delete","get","head","options"],function(e){dr.prototype[e]=function(t,r){return this.request(gr(r||{},{method:e,url:t,data:(r||{}).data}))}});b.forEach(["post","put","patch"],function(e){function t(r){return function(a,i,o){return this.request(gr(o||{},{method:e,headers:r?{"Content-Type":"multipart/form-data"}:{},url:a,data:i}))}}dr.prototype[e]=t(),dr.prototype[e+"Form"]=t(!0)});let DA=class sp{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let t;this.promise=new Promise(function(a){t=a});const r=this;this.promise.then(s=>{if(!r._listeners)return;let a=r._listeners.length;for(;a-- >0;)r._listeners[a](s);r._listeners=null}),this.promise.then=s=>{let a;const i=new Promise(o=>{r.subscribe(o),a=o}).then(s);return i.cancel=function(){r.unsubscribe(a)},i},e(function(a,i,o){r.reason||(r.reason=new hn(a,i,o),t(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);t!==-1&&this._listeners.splice(t,1)}toAbortSignal(){const e=new AbortController,t=r=>{e.abort(r)};return this.subscribe(t),e.signal.unsubscribe=()=>this.unsubscribe(t),e.signal}static source(){let e;return{token:new sp(function(s){e=s}),cancel:e}}};function MA(n){return function(t){return n.apply(null,t)}}function UA(n){return b.isObject(n)&&n.isAxiosError===!0}const Eo={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(Eo).forEach(([n,e])=>{Eo[e]=n});function ap(n){const e=new dr(n),t=Lf(dr.prototype.request,e);return b.extend(t,dr.prototype,e,{allOwnKeys:!0}),b.extend(t,e,null,{allOwnKeys:!0}),t.create=function(s){return ap(gr(n,s))},t}const de=ap(ws);de.Axios=dr;de.CanceledError=hn;de.CancelToken=DA;de.isCancel=Wf;de.VERSION=np;de.toFormData=ai;de.AxiosError=V;de.Cancel=de.CanceledError;de.all=function(e){return Promise.all(e)};de.spread=MA;de.isAxiosError=UA;de.mergeConfig=gr;de.AxiosHeaders=ze;de.formToJSON=n=>Kf(b.isHTMLForm(n)?new FormData(n):n);de.getAdapter=rp.getAdapter;de.HttpStatusCode=Eo;de.default=de;const{Axios:EO,AxiosError:AO,CanceledError:OO,isCancel:SO,CancelToken:PO,VERSION:xO,all:RO,Cancel:TO,isAxiosError:IO,spread:kO,toFormData:CO,AxiosHeaders:$O,HttpStatusCode:NO,formToJSON:jO,getAdapter:LO,mergeConfig:DO}=de,FA="https://raw.githubusercontent.com/samapriya/Earth-Engine-Datasets-List/master/gee_catalog.json";let Vi=null;async function BA(){if(Vi)return Vi;try{const e=(await de.get(FA)).data;return Vi=e,console.log(`Fetched ${e.length} datasets from GEE catalog`),e}catch(n){return console.error("Error fetching Earth Engine catalog:",n),ip()}}function ip(){return[{id:"USGS/SRTMGL1_003",title:"SRTM Global 1 arc second elevation",description:"Shuttle Radar Topography Mission (SRTM) digital elevation data is a worldwide elevation dataset.",tags:["elevation","topography","dem","srtm"],provider:"USGS",documentation_url:"https://developers.google.com/earth-engine/datasets/catalog/USGS_SRTMGL1_003",type:"image"},{id:"MODIS/006/MOD13Q1",title:"MODIS Terra Vegetation Indices 16-Day Global 250m",description:"Vegetation indices designed to provide consistent spatial and temporal comparisons of vegetation conditions.",tags:["modis","vegetation","ndvi","evi"],provider:"NASA",documentation_url:"https://developers.google.com/earth-engine/datasets/catalog/MODIS_006_MOD13Q1",type:"image_collection"},{id:"COPERNICUS/S2",title:"Sentinel-2 MSI: MultiSpectral Instrument, Level-1C",description:"Sentinel-2 is a wide-swath, high-resolution, multi-spectral imaging mission supporting Copernicus Land Monitoring studies.",tags:["sentinel","satellite","esa","copernicus"],provider:"ESA",documentation_url:"https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S2",type:"image_collection"},{id:"LANDSAT/LC08/C01/T1_SR",title:"USGS Landsat 8 Surface Reflectance Tier 1",description:"Landsat 8 SR is atmospherically corrected surface reflectance from the Landsat 8 OLI/TIRS sensors.",tags:["landsat","usgs","sr","surface reflectance"],provider:"USGS",documentation_url:"https://developers.google.com/earth-engine/datasets/catalog/LANDSAT_LC08_C01_T1_SR",type:"image_collection"},{id:"NASA/GPM_L3/IMERG_V06",title:"GPM: Global Precipitation Measurement (GPM) v6",description:"Global Precipitation Measurement (GPM) IMERG precipitation data.",tags:["precipitation","rainfall","gpm","nasa"],provider:"NASA",documentation_url:"https://developers.google.com/earth-engine/datasets/catalog/NASA_GPM_L3_IMERG_V06",type:"image_collection"}]}async function zA(n){console.log("Searching Earth Engine database for:",n);try{const e=await BA(),r=n.toLowerCase().split(/\s+/).filter(a=>a.length>2);return e.filter(a=>{var o;const i=`${a.id} ${a.title||a.name||""} ${a.description||""} ${((o=a.tags)==null?void 0:o.join(" "))||""}`.toLowerCase();return r.some(c=>i.includes(c))}).map(a=>{var c;const i=`${a.id} ${a.title||a.name||""} ${a.description||""} ${((c=a.tags)==null?void 0:c.join(" "))||""}`.toLowerCase(),o=r.reduce((l,u)=>l+(i.split(u).length-1),0);return{dataset:a,score:o}}).sort((a,i)=>i.score-a.score).map(a=>a.dataset).slice(0,20)}catch(e){return console.error("Error searching Earth Engine database:",e),ip()}}const $r={databaseSearch:async n=>(console.log("Searching Earth Engine database for:",n),zA(n)),runCode:async n=>(console.log("Running code in Earth Engine:",n),{success:!0,message:"Code execution simulated for Phase 2"}),inspectMap:async n=>(console.log("Inspecting map at:",n),{success:!0,data:{elevation:1234,landCover:"forest",coordinates:n}}),checkConsole:async()=>(console.log("Checking Earth Engine console"),{success:!0,errors:[]}),assessProblem:async n=>{if(console.log("Assessing problem feasibility:",n),!n)return{feasible:!1,explanation:"No query was provided. Please enter a valid request to analyze."};const e=n.toLowerCase(),t=["map","satellite","image","elevation","terrain","landsat","sentinel","modis","ndvi","vegetation","forest","water","land cover","temperature","climate","flood","drought","fire","urban","agriculture","time series","change","detection","glacier","snow","rainfall","precipitation","landslide","erosion","deforestation","reforestation","cropland"],r=["indoor","indoor map","street view","navigation","driving directions","traffic","restaurant","hotel","booking","flight","weather forecast","stock","market","exchange rate","currency","news","social media","programming","algorithm","code","java","python","javascript"],s=t.some(i=>e.includes(i)),a=r.some(i=>e.includes(i));return s&&!a?{feasible:!0,explanation:"This task can be accomplished with Google Earth Engine.",suggestedApproach:"Use Earth Engine to analyze satellite imagery and geospatial data."}:a?{feasible:!1,explanation:"This task is not suitable for Google Earth Engine. Earth Engine is designed for geospatial analysis, not for this type of request."}:{feasible:!0,explanation:"This task might be accomplishable with Google Earth Engine, but I'm not completely sure based on your request.",suggestedApproach:"Let's try using Earth Engine to analyze geospatial data related to your query."}}},ZA=ut.fromTemplate(`
You are a planning agent for Google Earth Engine. Your role is to analyze the user's request and determine:
1. If the request can be accomplished using Google Earth Engine
2. What Earth Engine datasets might be needed
3. What processing steps would be required
4. A step-by-step plan to fulfill the request

USER REQUEST: {input}

First, determine if this request can be accomplished using Google Earth Engine. Earth Engine is good for:
- Analyzing satellite imagery and geospatial data
- Processing large-scale Earth observation data
- Creating visualizations and maps of geographic data
- Performing spatial and temporal analysis of environmental data

Earth Engine is NOT suitable for:
- Non-geospatial tasks (general programming, web development, etc.)
- Tasks that don't involve Earth observation data
- Personal navigation or routing

If the request is not suitable for Earth Engine, explain why and suggest alternatives.
If the request is suitable, provide a detailed plan for how to accomplish it using Earth Engine.

Your plan should include:
1. The specific Earth Engine datasets that might be useful
2. The processing steps required
3. How to visualize or present the results

Be specific and detailed in your plan.
`),qA=()=>async n=>{console.log("Planner processing input:",n.input);try{console.log("Assessing problem feasibility...");const e=await $r.assessProblem(n.input);if(console.log("Assessment result:",JSON.stringify(e)),!e.feasible)return console.log("Request not feasible with Earth Engine:",e.explanation),{...n,response:`I'm sorry, but I don't think Google Earth Engine is the right tool for this request. ${e.explanation}`};console.log("Retrieving API key...");const t=await yr();if(!t)return console.error("API key not found in storage"),{...n,response:"OpenAI API key is not configured. Please set your API key in the settings."};console.log("API key retrieved, length:",t.length),console.log("Initializing LLM...");try{const r=new ys({modelName:"gpt-3.5-turbo",temperature:0,openAIApiKey:t,configuration:{dangerouslyAllowBrowser:!0}});console.log("Generating plan using LLM...");const s=await ZA.format({input:n.input});console.log("Prompt formatted, calling OpenAI API...");const i=(await r.invoke(s)).content.toString();return console.log("Generated plan:",i),{...n,taskPlan:i}}catch(r){return console.error("OpenAI API error:",r),r instanceof Error&&console.error("Error details:",r.message,r.stack),{...n,response:`Error calling OpenAI API: ${r instanceof Error?r.message:"Unknown error"}`}}}catch(e){return console.error("Error in planner agent:",e),e instanceof Error&&console.error("Error details:",e.message,e.stack),{...n,response:`I encountered an error while planning the task: ${e instanceof Error?e.message:"Unknown error"}`}}},VA=ut.fromTemplate(`
You are a database selection agent for Google Earth Engine. Your job is to select the most appropriate 
Earth Engine datasets for a given task.

USER REQUEST: {input}
TASK PLAN: {taskPlan}
AVAILABLE DATASETS:
{availableDatabases}

Select the most appropriate datasets from the available options to accomplish the task. For each selected 
dataset, briefly explain why it's appropriate for the task.

Consider the following factors:
1. Spatial resolution - Is high spatial detail required?
2. Temporal coverage - Is historical data needed? How recent should the data be?
3. Update frequency - Does the task require the most up-to-date data?
4. Data type - What physical variables are needed (e.g., elevation, temperature, vegetation)?
5. Relevance to the specific task

Return your selections in a well-formatted list with justifications for each choice.
Be specific about which dataset IDs you are selecting from the provided list.
`),HA=()=>async n=>{if(!n.taskPlan)return console.log("Database selector: No task plan available"),n;console.log("Database selector processing task plan");try{const e=await $r.databaseSearch(n.input);if(!e||e.length===0)return{...n,response:"I couldn't find any relevant Earth Engine datasets for your request. Please try a different query."};const t=await yr();if(!t)return{...n,response:"OpenAI API key is not configured. Please set your API key in the settings."};const r=new ys({modelName:"gpt-3.5-turbo",temperature:0,openAIApiKey:t,configuration:{dangerouslyAllowBrowser:!0}}),s=JSON.stringify(e,null,2),a=await VA.format({input:n.input,taskPlan:n.taskPlan,availableDatabases:s}),o=(await r.invoke(a)).content.toString();console.log("Database selections:",o);const c=GA(o,e),l=e.filter(u=>c.includes(u.id));return console.log("Selected databases:",l),{...n,selectedDatabases:l,databaseSelectionText:o}}catch(e){return console.error("Error in database selector agent:",e),{...n,response:"I encountered an error while selecting Earth Engine datasets. Please try again with a more specific request."}}};function GA(n,e){const t=new Set;for(const r of e)n.includes(r.id)&&t.add(r.id);return Array.from(t)}const JA=ut.fromTemplate(`
You are a code generation agent for Google Earth Engine. Your role is to generate JavaScript code 
that runs in the Google Earth Engine Code Editor to fulfill the user's request.

USER REQUEST: {input}
TASK PLAN: {taskPlan}
SELECTED DATASETS: {selectedDatabases}

Generate complete, runnable Google Earth Engine JavaScript code that fulfills the user's request.
The code should:
1. Import and properly reference the selected datasets
2. Apply appropriate filters, transformations, and analyses
3. Create visualizations with good default parameters
4. Include comments explaining key steps
5. Be well-structured and follow Google Earth Engine best practices

Make sure the code is complete and ready to run in the Google Earth Engine Code Editor.
Use standard Earth Engine JavaScript API conventions.

Return only the code with no additional text before or after.
`),KA=()=>async n=>{if(!n.selectedDatabases||n.selectedDatabases.length===0)return console.log("Code generator: No databases selected"),n;console.log("Code generator processing selected databases");try{const e=await yr();if(!e)return{...n,response:"OpenAI API key is not configured. Please set your API key in the settings."};const t=new ys({modelName:"gpt-3.5-turbo",temperature:0,openAIApiKey:e,configuration:{dangerouslyAllowBrowser:!0}}),r=JSON.stringify(n.selectedDatabases,null,2),s=await JA.format({input:n.input,taskPlan:n.taskPlan||"No specific task plan available.",selectedDatabases:r}),i=(await t.invoke(s)).content.toString();let o=i;const c=i.match(/```(?:javascript|js)?\s*([\s\S]*?)```/);return c&&(o=c[1].trim()),console.log("Generated code:",o),{...n,generatedCode:o,response:WA(n.input,n.selectedDatabases,o)}}catch(e){return console.error("Error in code generator agent:",e),{...n,generatedCode:"// Error generating code",response:"I encountered an error while generating Google Earth Engine code for your request. Please try again with a more specific request."}}};function WA(n,e,t){const r=e.map(a=>a.name).join(", "),s=t.length;return`
Based on your request to "${n}", I've generated Google Earth Engine code (${s} characters) that uses the following datasets: ${r}.

The code:
1. Loads the necessary Earth Engine datasets
2. Processes the data to extract the information you requested
3. Creates a visualization to display the results

You can run this code in the Google Earth Engine Code Editor by clicking the "Run Code" button below.
  `.trim()}const XA=ut.fromTemplate(`
You are a code debugging agent for Google Earth Engine. Your role is to analyze error messages from
the Earth Engine console and fix the code to resolve these issues.

USER REQUEST: {input}
ORIGINAL CODE: 
\`\`\`javascript
{code}
\`\`\`

ERROR MESSAGES: 
{errors}

Carefully analyze the error messages and fix the code. Here are some common causes of errors in Earth Engine code:

1. Invalid dataset IDs or incorrect access to properties
2. Incorrect band names or indices
3. Geometry issues in regions/areas
4. Type mismatches (e.g., using an image function on an image collection)
5. Missing required parameters in functions
6. Incorrect use of Earth Engine API functions
7. Visualization parameter issues
8. Scale/projection issues

Return the fixed code with explanations of what you changed and why. The code should be complete and runnable in the Google Earth Engine Code Editor.

IMPORTANT: Only make changes necessary to fix the errors. Keep the overall structure and logic the same unless it's directly causing the error.
`),YA=()=>async n=>{if(!n.generatedCode||!n.errors)return console.log("Code debugger: No code or errors to debug"),n;console.log("Code debugger processing errors");try{const e=await yr();if(!e)return{...n,response:"OpenAI API key is not configured. Please set your API key in the settings."};const t=new ys({modelName:"gpt-3.5-turbo",temperature:0,openAIApiKey:e,configuration:{dangerouslyAllowBrowser:!0}}),r=await XA.format({input:n.input,code:n.generatedCode,errors:n.errors}),a=(await t.invoke(r)).content.toString();let i=n.generatedCode;const o=a.match(/```(?:javascript|js)?\s*([\s\S]*?)```/);return o&&(i=o[1].trim()),console.log("Debugged code:",i),{...n,generatedCode:i,debugLog:[...n.debugLog||[],`Fixed code issues: ${a}`],errors:void 0}}catch(e){return console.error("Error in code debugger agent:",e),{...n,debugLog:[...n.debugLog||[],`Error in debugging: ${e}`],response:n.response||"I encountered an error while debugging the code. Please try again with a simplified request."}}},QA=ut.fromTemplate(`
You are a summarization agent for Google Earth Engine analyses. Your role is to provide clear, concise summaries
of Earth Engine analyses and their results in a way that is accessible to users of all technical levels.

USER REQUEST: {input}
TASK PLAN: {taskPlan}
SELECTED DATASETS: {selectedDatabases}
GENERATED CODE: 
\`\`\`javascript
{generatedCode}
\`\`\`
INSPECTION RESULTS: {inspectionResults}

Based on all the information above, create a comprehensive but concise summary that includes:

1. The original objective of the analysis
2. The datasets used and why they were selected
3. The key processing steps in the analysis
4. The main findings or visualizations produced
5. Any limitations or caveats of the analysis
6. Suggestions for further exploration or improvement

Make your explanation accessible to users who may not be familiar with Earth Engine or remote sensing terminology.
Use clear language and avoid unnecessary technical jargon. When mentioning technical concepts, briefly explain them.

Your summary should be comprehensive enough to be useful, but concise enough to be quickly digested.
`),eO=()=>async n=>{if(!n.generatedCode)return console.log("Summarizer: No analysis to summarize"),n;console.log("Summarizer processing analysis results");try{const e=await yr();if(!e)return{...n,response:"OpenAI API key is not configured. Please set your API key in the settings."};const t=new ys({modelName:"gpt-3.5-turbo",temperature:0,openAIApiKey:e,configuration:{dangerouslyAllowBrowser:!0}}),r=n.selectedDatabases?JSON.stringify(n.selectedDatabases,null,2):"No specific datasets were selected.",s=await QA.format({input:n.input,taskPlan:n.taskPlan||"No specific task plan available.",selectedDatabases:r,generatedCode:n.generatedCode,inspectionResults:n.inspectionResults||"No inspection results available."}),i=(await t.invoke(s)).content.toString();return console.log("Generated summary:",i),{...n,response:i}}catch(e){return console.error("Error in summarizer agent:",e),{...n,response:n.response||"I encountered an error while summarizing the analysis. Here's the raw code and results instead."}}},tO=async()=>{console.log("Initializing Earth Agent system");try{const n=qA(),e=HA(),t=KA(),r=YA(),s=eO();if(!n||!e||!t||!r||!s)throw new Error("Failed to initialize one or more agents");return async a=>{console.log("Agent system received input:",a);try{if(!a)return{response:"I couldn't process your request. Please provide a valid query.",code:"// No code was generated (empty input)"};let i={input:a};if(console.log("Step 1: Planning"),i=await n(i),i.response)return{response:i.response,code:i.generatedCode||"// No code was generated"};console.log("Step 2: Database Selection"),i=await e(i),console.log("Step 3: Code Generation"),i=await t(i),console.log("Step 4: Executing code");try{const o=await $r.runCode(i.generatedCode||"");console.log("Code execution result:",o);const c=await $r.checkConsole();if(c.success&&c.errors&&Array.isArray(c.errors)&&c.errors.length>0&&(console.log("Detected errors:",c.errors),i.errors=c.errors.map(u=>`${u.level}: ${u.message}`).join(`
`),console.log("Step 5: Debugging code"),i=await r(i),i.generatedCode)){console.log("Retrying with fixed code");const u=await $r.runCode(i.generatedCode);console.log("Retry result:",u)}console.log("Step 6: Inspecting results");const l=await $r.inspectMap({lat:37.7749,lng:-122.4194});l&&l.data&&(i.inspectionResults=typeof l.data=="string"?l.data:JSON.stringify(l.data,null,2))}catch(o){console.error("Error during execution or inspection:",o),o instanceof Error?i.errors=o.message:typeof o=="string"?i.errors=o:i.errors="Unknown error during execution";try{i=await r(i)}catch(c){console.error("Error in code debugger:",c)}}console.log("Step 7: Summarizing");try{i=await s(i)}catch(o){console.error("Error in summarizer:",o),i.response=i.response||"I generated some code based on your request, but encountered an error summarizing the results."}return{response:i.response||"No response was generated.",code:i.generatedCode||"// No code was generated",debugLog:i.debugLog}}catch(i){return console.error("Error in agent workflow:",i),{response:`I encountered an error while processing your request: ${i instanceof Error?i.message:"Unknown error"}. Please try again with a more specific request.`,code:"// Error processing request",debugLog:i instanceof Error?[i.message]:["Unknown error"]}}}}catch(n){return console.error("Error initializing agent system:",n),async e=>({response:`The Earth Agent system could not be initialized. Error: ${n instanceof Error?n.message:"Unknown initialization error"}`,code:"// System initialization error",debugLog:n instanceof Error?[n.message]:["Unknown initialization error"]})}},rO=({onQuerySubmit:n})=>{const[e,t]=$e.useState([]),[r,s]=$e.useState(""),[a,i]=$e.useState(!1),[o,c]=$e.useState(null),l=$e.useRef(null);$e.useEffect(()=>{(async()=>{try{console.log("Initializing agent system...");const f=await tO();console.log("Agent system initialized"),c(f)}catch(f){console.error("Error initializing agent system:",f)}})()},[]),$e.useEffect(()=>{var h;(h=l.current)==null||h.scrollIntoView({behavior:"smooth"})},[e]);const u=async h=>{h.preventDefault();const f=r.trim();if(!f)return;const g={id:Date.now().toString(),role:"user",content:f};t(p=>[...p,g]),s(""),i(!0);try{if(n&&await n(),o)if(f)try{const p=await o(f);if(!p||typeof p!="object")throw new Error("Invalid response from agent system");const m={id:(Date.now()+1).toString(),role:"assistant",content:p&&typeof p.response=="string"?p.response:"I encountered an error processing your request.",code:p&&typeof p.code=="string"?p.code:void 0};t(_=>[..._,m])}catch(p){console.error("Error in agent system:",p);const m={id:(Date.now()+1).toString(),role:"assistant",content:`I encountered an error while processing your request: ${p instanceof Error?p.message:"Unknown error"}`};t(_=>[..._,m])}else{const p={id:(Date.now()+1).toString(),role:"assistant",content:"I couldn't process your request. Please provide a valid query."};t(m=>[...m,p])}else setTimeout(()=>{const p={id:(Date.now()+1).toString(),role:"assistant",content:"The Earth Agent system is still initializing. Please try again in a moment.",code:"// Agent system initializing"};t(m=>[...m,p]),i(!1)},1e3)}catch(p){console.error("Error processing message:",p);const m={id:(Date.now()+1).toString(),role:"assistant",content:"I encountered an error while processing your request. Please try again with a different query."};t(_=>[..._,m])}finally{i(!1)}},d=h=>{console.log("Running code in Earth Engine:",h),chrome.tabs.query({active:!0,currentWindow:!0},f=>{var g;(g=f[0])!=null&&g.id?chrome.tabs.sendMessage(f[0].id,{type:"RUN_CODE",code:h},p=>{if(chrome.runtime.lastError){console.error("Error sending message:",chrome.runtime.lastError),alert("Error: Could not run code in Earth Engine. Make sure you are on the Earth Engine Code Editor page.");return}p!=null&&p.success?alert("Code successfully sent to Earth Engine."):alert(`Error: ${(p==null?void 0:p.error)||"Could not run code in Earth Engine"}`)}):alert("Error: No active tab found. Make sure you are on the Earth Engine Code Editor page.")})};return z.jsxs("div",{className:"flex flex-col h-full",children:[z.jsxs("div",{className:"flex-1 overflow-auto mb-4",children:[e.map(h=>z.jsxs("div",{className:`mb-4 p-3 rounded-lg ${h.role==="user"?"bg-blue-100 ml-8":"bg-gray-100 mr-8"}`,children:[z.jsx("div",{className:"font-semibold mb-1",children:h.role==="user"?"You":"Earth Agent"}),z.jsx("div",{className:"whitespace-pre-wrap",children:h.content}),h.code&&z.jsxs("div",{className:"mt-2",children:[z.jsx("div",{className:"bg-gray-800 text-gray-200 p-3 rounded-md overflow-x-auto",children:z.jsx("pre",{children:z.jsx("code",{children:h.code})})}),z.jsx("button",{onClick:()=>d(h.code),className:"mt-2 px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors",children:"Run Code"})]})]},h.id)),a&&z.jsx("div",{className:"flex justify-center items-center my-4",children:z.jsx("div",{className:"animate-pulse text-gray-500",children:"Earth Agent is thinking..."})}),z.jsx("div",{ref:l})]}),z.jsxs("form",{onSubmit:u,className:"flex",children:[z.jsx("input",{type:"text",value:r,onChange:h=>s(h.target.value),placeholder:"Ask Earth Agent something...",className:"flex-1 border rounded-l-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:a}),z.jsx("button",{type:"submit",disabled:a||!r.trim(),className:"bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700 transition-colors disabled:bg-gray-400",children:"Send"})]})]})},nO=({onApiKeySet:n})=>{const[e,t]=$e.useState(""),[r,s]=$e.useState(!1),[a,i]=$e.useState(null),[o,c]=$e.useState(null);$e.useEffect(()=>{(async()=>{try{if(await jf())try{const f=await yr();if(f){const g="*".repeat(f.length-4)+f.slice(-4);t(g)}}catch(f){console.error("Error retrieving API key:",f),c("Error retrieving your API key. You may need to enter it again.")}}catch(h){console.error("Error checking API key status:",h),c("Error checking API key status. Please try refreshing the page.")}})()},[]);const l=d=>!d||d.trim()===""?(i("API key is required"),!1):d.includes("*")?(i("Please enter your full API key"),!1):/^sk-[a-zA-Z0-9]{32,}$/.test(d.trim())?!0:(i('Invalid API key format. OpenAI keys should start with "sk-" followed by at least 32 characters.'),!1),u=async d=>{d.preventDefault(),i(null);const h=e.trim();if(l(h))try{s(!0),await uE(h),n()}catch(f){console.error("Error saving API key:",f),i("Failed to save API key: "+(f instanceof Error?f.message:"Unknown error"))}finally{s(!1)}};return z.jsxs("div",{className:"p-4 bg-white rounded-lg shadow-md",children:[z.jsx("h2",{className:"text-xl font-semibold mb-4",children:"API Key Configuration"}),z.jsx("p",{className:"mb-4 text-gray-700",children:"To use the Earth Agent, you need to provide your OpenAI API key. Your key will be stored securely in your browser's local storage."}),o&&z.jsx("div",{className:"mb-4 p-3 bg-yellow-100 text-yellow-800 rounded-md",children:z.jsx("p",{children:o})}),z.jsxs("form",{onSubmit:u,children:[z.jsxs("div",{className:"mb-4",children:[z.jsx("label",{htmlFor:"apiKey",className:"block text-sm font-medium text-gray-700 mb-1",children:"OpenAI API Key"}),z.jsx("input",{id:"apiKey",type:"password",value:e,onChange:d=>{t(d.target.value),i(null)},placeholder:"sk-...",className:"w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"}),a&&z.jsx("p",{className:"mt-1 text-sm text-red-600",children:a})]}),z.jsx("button",{type:"submit",disabled:r,className:`w-full py-2 px-4 rounded-md text-white font-medium 
            ${r?"bg-gray-400":"bg-green-600 hover:bg-green-700"}`,children:r?"Saving...":"Save API Key"})]}),z.jsxs("div",{className:"mt-4 text-sm text-gray-500",children:[z.jsxs("p",{children:["You can get an API key from ",z.jsx("a",{href:"https://platform.openai.com/api-keys",target:"_blank",className:"text-blue-600 hover:underline",children:"OpenAI's website"}),"."]}),z.jsx("p",{className:"mt-1",children:"Your API key is only stored in your browser and is never sent to our servers."})]})]})},sO=()=>{const[n,e]=$e.useState(!1),[t,r]=$e.useState(!0);$e.useEffect(()=>{(async()=>{try{const i=await jf();e(i)}catch(i){console.error("Error checking API key status:",i)}finally{r(!1)}})()},[]);const s=()=>{e(!0)};return z.jsxs("div",{className:"flex flex-col h-screen",children:[z.jsxs("header",{className:"p-4 border-b",children:[z.jsx("h1",{className:"text-xl font-bold mb-2",children:"Earth Agent"}),z.jsx("p",{className:"text-sm text-gray-600",children:"AI-powered assistant for Google Earth Engine"})]}),z.jsx("main",{className:"flex-1 overflow-auto p-4 flex flex-col",children:t?z.jsx("div",{className:"flex items-center justify-center h-full",children:z.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-500"})}):n?z.jsx(rO,{}):z.jsx("div",{className:"flex-1 flex items-center justify-center",children:z.jsx("div",{className:"w-full max-w-md",children:z.jsx(nO,{onApiKeySet:s})})})})]})};up.createRoot(document.getElementById("root")).render(z.jsx(dp.StrictMode,{children:z.jsx(sO,{})}));console.log("Earth Agent sidepanel loaded");export{F0 as B,ut as P,lE as c,zn as r};
