const s="https://code.earthengine.google.com";chrome.runtime.onInstalled.addListener(e=>{console.log("Earth Agent installed",e),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(n=>console.error("Error setting panel behavior:",n))});chrome.action.onClicked.addListener(e=>{e!=null&&e.windowId&&chrome.sidePanel.open({windowId:e.windowId}).catch(n=>console.error("Error opening side panel:",n))});chrome.runtime.onMessage.addListener((e,n,t)=>{if(console.log("Background received message:",e,"from:",n),e.type==="TEST_CONNECTION")return t({success:!0,message:"Background connection successful"}),!0;if(e.type==="OPEN_EARTH_ENGINE_AND_RUN_CODE"){console.log("Received request to open Earth Engine and run code");const i=e.code;return i?(chrome.tabs.query({url:`${s}/*`},r=>{if(r.length>0){const o=r[0];chrome.tabs.update(o.id,{active:!0},()=>{l(o.id,i,t)})}else chrome.tabs.create({url:s},o=>{if(!o||!o.id){t({success:!1,error:"Failed to open Earth Engine"});return}console.log("Opened new Earth Engine tab, waiting for it to load");const c=(u,d)=>{u===o.id&&d.status==="complete"&&(chrome.tabs.onUpdated.removeListener(c),console.log("Earth Engine page loaded, waiting for initialization"),setTimeout(()=>{l(o.id,i,t)},5e3))};chrome.tabs.onUpdated.addListener(c)})}),!0):(t({success:!1,error:"No code provided"}),!0)}return!0});function l(e,n,t){console.log(`Injecting code into tab ${e}`),chrome.tabs.sendMessage(e,{type:"RUN_CODE",code:n},i=>{if(chrome.runtime.lastError){console.error("Error sending message to tab:",chrome.runtime.lastError),chrome.scripting.executeScript({target:{tabId:e},func:r=>{if(console.log("Executing code injection via executeScript"),!document.querySelector(".ace_editor"))return console.error("Could not find ACE editor"),{success:!1,error:"Could not find editor"};try{const c=document.querySelector(".ace_text-input");if(c){console.log("Found text input, setting value"),c.focus(),document.execCommand("selectAll",!1),document.execCommand("insertText",!1,r);const u=document.querySelector(".goog-button.run-button")||document.querySelector('button[title="Run"]');return u?(console.log("Clicking run button"),u.click(),{success:!0,message:"Code injected and run button clicked"}):{success:!0,message:"Code injected but run button not found"}}return{success:!1,error:"Could not find text input"}}catch(c){return console.error("Error in executeScript:",c),{success:!1,error:String(c)}}},args:[n]},r=>{if(r&&r[0]&&r[0].result&&r[0].result.success)t({success:!0,result:r[0].result.message});else{const o=r&&r[0]&&r[0].result?r[0].result.error:"Unknown error";t({success:!1,error:o})}});return}t(i)})}console.log("Earth Agent background script loaded");
